import { BaseDmFileReader, findDirectoryWithin, getNameByPath, renameFileInDir } from "./DirectoryManagers";
import { directoryReadToArray } from "./directoryReadToArray.function";
import { path } from "./path";
export class BrowserDmFileReader extends BaseDmFileReader {
    constructor(file, directory) {
        super();
        this.file = file;
        this.directory = directory;
        this.name = file.name;
    }
    async stats() {
        return this.getRealFile();
    }
    async write(fileString) {
        let writableStream;
        const likeFile = this.file;
        const hasPermission = likeFile.queryPermission && await likeFile.queryPermission() === 'granted';
        if (hasPermission) {
            writableStream = await likeFile.createWritable();
        }
        else {
            // request where to save
            const id = this.name.replace(/[^a-zA-Z0-9]/g, '-') + '-filePicker';
            const savePickerOptions = {
                suggestedName: this.name,
                /*types: [{
                  description: 'JSON',
                  accept: {
                    'application/json': ['.json'],
                  },
                }],*/
            };
            savePickerOptions.id = id.slice(0, 32);
            const handle = await window.showSaveFilePicker(savePickerOptions);
            writableStream = await handle.createWritable();
        }
        // write our file
        await writableStream.write(fileString);
        // close the file and write the contents to disk.
        await writableStream.close();
    }
    async getRealFile() {
        const file = this.file;
        return file.getFile ? await file.getFile() : Promise.resolve(file);
    }
    readAsText() {
        return new Promise(async (res, rej) => {
            try {
                var reader = new FileReader();
                const file = await this.getRealFile();
                reader.readAsText(file);
                reader.onload = () => res(reader.result);
            }
            catch (err) {
                rej(err);
            }
        });
    }
    readAsDataURL() {
        return new Promise(async (res, rej) => {
            try {
                var reader = new FileReader();
                const file = await this.getRealFile();
                reader.readAsDataURL(file);
                reader.onload = () => res(reader.result);
            }
            catch (err) {
                rej(err);
            }
        });
    }
}
export class BrowserDirectoryManager {
    constructor(path, files, // LikeFile[],
    directoryHandler) {
        this.path = path;
        this.files = files;
        this.directoryHandler = directoryHandler;
        this.name = getNameByPath(path);
    }
    findDirectory(path, options) {
        return findDirectoryWithin(path, this, options);
    }
    async list() {
        const files = await directoryReadToArray(this.directoryHandler);
        return files.map(file => file.name);
    }
    async listFolders() {
        const items = await directoryReadToArray(this.directoryHandler);
        return items.filter((file) => file.kind && file.kind === 'directory')
            .map(file => file.name);
    }
    async listFiles() {
        const items = await directoryReadToArray(this.directoryHandler);
        return items.filter((file) => file.kind === 'file')
            .map((file) => file.name);
    }
    async getFolders() {
        const names = await this.listFolders();
        return Promise.all(names.map(async (name) => await this.getDirectory(name)));
    }
    async getFiles() {
        const files = await directoryReadToArray(this.directoryHandler);
        return files.filter(file => file.kind === 'file')
            .map(file => new BrowserDmFileReader(file, this));
    }
    createDirectory(newPath) {
        return this.getDirectory(newPath, { create: true });
    }
    async getDirectory(newPath, options) {
        if (!newPath) {
            return this;
        }
        const newPathArray = newPath.split(/\\|\//);
        let fullNewPath = this.path;
        let dir;
        try {
            // traverse through each folder
            dir = await newPathArray.reduce(async (last, current) => {
                const next = await last;
                const newHandle = next.getDirectoryHandle(current, options);
                const name = (await newHandle).name;
                fullNewPath = path.join(fullNewPath, name);
                return newHandle;
            }, Promise.resolve(this.directoryHandler));
        }
        catch (err) {
            throw new Error(err.message + `. ${newPath} not found in ${this.name} (${this.path})`);
        }
        const files = await directoryReadToArray(dir);
        const newDir = new BrowserDirectoryManager(fullNewPath, files, dir);
        return newDir;
    }
    async removeEntry(name, options) {
        const split = name.split(/\\|\//);
        const lastName = split.pop(); // remove last item
        const dir = split.length >= 1 ? await this.getDirectory(split.join('/')) : this;
        return dir.directoryHandler.removeEntry(lastName, options);
    }
    async renameFile(oldFileName, newFileName) {
        return renameFileInDir(oldFileName, newFileName, this);
    }
    async file(path, options) {
        const findFile = await this.findFileByPath(path);
        if (findFile) {
            return findFile;
        }
        const dir = await this.getDirForFilePath(path);
        const fileName = path.split(/\\|\//).pop();
        const fileHandle = await dir.directoryHandler.getFileHandle(fileName, options);
        return new BrowserDmFileReader(fileHandle, this);
    }
    async findFileByPath(path, directoryHandler = this.directoryHandler) {
        const pathSplit = path.split(/\\|\//);
        const fileName = pathSplit.pop(); // pathSplit[ pathSplit.length-1 ]
        // chrome we dig through the first selected directory and search the subs
        if (pathSplit.length) {
            const dir = await this.getDirectory(pathSplit.join('/'));
            directoryHandler = dir.directoryHandler;
        }
        let files = this.files;
        files = await directoryReadToArray(directoryHandler);
        const likeFile = files.find(file => file.name === fileName);
        if (!likeFile) {
            return;
        }
        // when found, convert to File
        // const file = await this.getSystemFile(likeFile)
        return new BrowserDmFileReader(likeFile, this);
    }
    async getDirForFilePath(path) {
        const pathSplit = path.split(/\\|\//);
        pathSplit.pop(); // pathSplit[ pathSplit.length-1 ]
        return await this.getDirectory(pathSplit.join('/'));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQnJvd3NlckRpcmVjdG9yeU1hbmFnZXJzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2RpcmVjdG9yeS1tYW5hZ2Vycy9Ccm93c2VyRGlyZWN0b3J5TWFuYWdlcnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGdCQUFnQixFQUFrQyxtQkFBbUIsRUFBRSxhQUFhLEVBQUUsZUFBZSxFQUFFLE1BQU0scUJBQXFCLENBQUE7QUFDM0ksT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0saUNBQWlDLENBQUE7QUFDdEUsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLFFBQVEsQ0FBQTtBQUU3QixNQUFNLE9BQU8sbUJBQW9CLFNBQVEsZ0JBQWdCO0lBR3ZELFlBQ1MsSUFBaUMsRUFDakMsU0FBMkI7UUFFbEMsS0FBSyxFQUFFLENBQUE7UUFIQSxTQUFJLEdBQUosSUFBSSxDQUE2QjtRQUNqQyxjQUFTLEdBQVQsU0FBUyxDQUFrQjtRQUdsQyxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUE7SUFDdkIsQ0FBQztJQUVELEtBQUssQ0FBQyxLQUFLO1FBQ1QsT0FBTyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUE7SUFDM0IsQ0FBQztJQUVELEtBQUssQ0FBQyxLQUFLLENBQUMsVUFBa0I7UUFDNUIsSUFBSSxjQUFtQixDQUFBO1FBQ3ZCLE1BQU0sUUFBUSxHQUFRLElBQUksQ0FBQyxJQUFJLENBQUE7UUFDL0IsTUFBTSxhQUFhLEdBQUcsUUFBUSxDQUFDLGVBQWUsSUFBSSxNQUFNLFFBQVEsQ0FBQyxlQUFlLEVBQUUsS0FBSyxTQUFTLENBQUE7UUFFaEcsSUFBSyxhQUFhLEVBQUc7WUFDbkIsY0FBYyxHQUFHLE1BQU0sUUFBUSxDQUFDLGNBQWMsRUFBRSxDQUFBO1NBQ2pEO2FBQU07WUFDTCx3QkFBd0I7WUFDeEIsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENB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OEJBQThCO1FBQzlCLGtEQUFrRDtRQUNsRCxPQUFPLElBQUksbUJBQW1CLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFBO0lBQ2hELENBQUM7SUFFRCxLQUFLLENBQUMsaUJBQWlCLENBQUMsSUFBWTtRQUNsQyxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBQ3JDLFNBQVMsQ0FBQyxHQUFHLEVBQVksQ0FBQSxDQUFDLGtDQUFrQztRQUU1RCxPQUFPLE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBRSxTQUFTLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFFLENBQUE7SUFDdkQsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQmFzZURtRmlsZVJlYWRlciwgRGlyZWN0b3J5TWFuYWdlciwgRG1GaWxlUmVhZGVyLCBmaW5kRGlyZWN0b3J5V2l0aGluLCBnZXROYW1lQnlQYXRoLCByZW5hbWVGaWxlSW5EaXIgfSBmcm9tIFwiLi9EaXJlY3RvcnlNYW5hZ2Vyc1wiXG5pbXBvcnQgeyBkaXJlY3RvcnlSZWFkVG9BcnJheSB9IGZyb20gXCIuL2RpcmVjdG9yeVJlYWRUb0FycmF5LmZ1bmN0aW9uXCJcbmltcG9ydCB7IHBhdGggfSBmcm9tIFwiLi9wYXRoXCJcblxuZXhwb3J0IGNsYXNzIEJyb3dzZXJEbUZpbGVSZWFkZXIgZXh0ZW5kcyBCYXNlRG1GaWxlUmVhZGVyIGltcGxlbWVudHMgRG1GaWxlUmVhZGVyIHtcbiAgbmFtZTogc3RyaW5nXG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHVibGljIGZpbGU6IEZpbGUgfCBGaWxlU3lzdGVtRmlsZUhhbmRsZSxcbiAgICBwdWJsaWMgZGlyZWN0b3J5OiBEaXJlY3RvcnlNYW5hZ2VyXG4gICkge1xuICAgIHN1cGVyKClcbiAgICB0aGlzLm5hbWUgPSBmaWxlLm5hbWVcbiAgfVxuXG4gIGFzeW5jIHN0YXRzKCkge1xuICAgIHJldHVybiB0aGlzLmdldFJlYWxGaWxlKClcbiAgfVxuXG4gIGFzeW5jIHdyaXRlKGZpbGVTdHJpbmc6IHN0cmluZykge1xuICAgIGxldCB3cml0YWJsZVN0cmVhbTogYW55XG4gICAgY29uc3QgbGlrZUZpbGU6IGFueSA9IHRoaXMuZmlsZVxuICAgIGNvbnN0IGhhc1Blcm1pc3Npb24gPSBsaWtlRmlsZS5xdWVyeVBlcm1pc3Npb24gJiYgYXdhaXQgbGlrZUZpbGUucXVlcnlQZXJtaXNzaW9uKCkgPT09ICdncmFudGVkJ1xuXG4gICAgaWYgKCBoYXNQZXJtaXNzaW9uICkge1xuICAgICAgd3JpdGFibGVTdHJlYW0gPSBhd2FpdCBsaWtlRmlsZS5jcmVhdGVXcml0YWJsZSgpXG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIHJlcXVlc3Qgd2hlcmUgdG8gc2F2ZVxuICAgICAgY29uc3QgaWQgPSB0aGlzLm5hbWUucmVwbGFjZSgvW15hLXpBLVowLTldL2csJy0nKSsnLWZpbGVQaWNrZXInXG4gICAgICBjb25zdCBzYXZlUGlja2VyT3B0aW9ucyA9IHtcbiAgICAgICAgc3VnZ2VzdGVkTmFtZTogdGhpcy5uYW1lLFxuICAgICAgICAvKnR5cGVzOiBbe1xuICAgICAgICAgIGRlc2NyaXB0aW9uOiAnSlNPTicsXG4gICAgICAgICAgYWNjZXB0OiB7XG4gICAgICAgICAgICAnYXBwbGljYXRpb24vanNvbic6IFsnLmpzb24nXSxcbiAgICAgICAgICB9LFxuICAgICAgICB9XSwqL1xuICAgICAgfVxuXG4gICAgICAvLyBiZWxvdywgdGhvdWdodCB0byByZW1lbWJlciBsYXN0IG1hdGNoaW5nIGZpbGUgKGkgdGhpbmsgZGF0YSB0eXBpbmcgaXMganVzdCBtaXNzaW5nIGZvciBpdClcbiAgICAgIDsoc2F2ZVBpY2tlck9wdGlvbnMgYXMgYW55KS5pZCA9IGlkLnNsaWNlKDAsIDMyKVxuXG4gICAgICBjb25zdCBoYW5kbGUgPSBhd2FpdCB3aW5kb3cuc2hvd1NhdmVGaWxlUGlja2VyKHNhdmVQaWNrZXJPcHRpb25zKVxuICAgICAgXG4gICAgICB3cml0YWJsZVN0cmVhbSA9IGF3YWl0IGhhbmRsZS5jcmVhdGVXcml0YWJsZSgpXG4gICAgfVxuXG5cbiAgICAvLyB3cml0ZSBvdXIgZmlsZVxuICAgIGF3YWl0IHdyaXRhYmxlU3RyZWFtLndyaXRlKCBmaWxlU3RyaW5nIClcblxuICAgIC8vIGNsb3NlIHRoZSBmaWxlIGFuZCB3cml0ZSB0aGUgY29udGVudHMgdG8gZGlzay5cbiAgICBhd2FpdCB3cml0YWJsZVN0cmVhbS5jbG9zZSgpXG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGdldFJlYWxGaWxlKCk6IFByb21pc2U8RmlsZT4ge1xuICAgIGNvbnN0IGZpbGUgPSB0aGlzLmZpbGUgYXMgYW55XG4gICAgcmV0dXJuIGZpbGUuZ2V0RmlsZSA/IGF3YWl0IGZpbGUuZ2V0RmlsZSgpIDogUHJvbWlzZS5yZXNvbHZlKGZpbGUpXG4gIH1cbiAgXG4gIG92ZXJyaWRlIHJlYWRBc1RleHQoKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoYXN5bmMgKHJlcywgcmVqKSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICB2YXIgcmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKVxuICAgICAgICBjb25zdCBmaWxlID0gYXdhaXQgdGhpcy5nZXRSZWFsRmlsZSgpXG4gICAgICAgIHJlYWRlci5yZWFkQXNUZXh0KGZpbGUpXG4gICAgICAgIHJlYWRlci5vbmxvYWQgPSAoKSA9PiByZXMocmVhZGVyLnJlc3VsdCBhcyBzdHJpbmcpXG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgcmVqKGVycilcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgcmVhZEFzRGF0YVVSTCgpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZShhc3luYyAocmVzLCByZWopID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIHZhciByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpXG4gICAgICAgIGNvbnN0IGZpbGUgPSBhd2FpdCB0aGlzLmdldFJlYWxGaWxlKClcbiAgICAgICAgcmVhZGVyLnJlYWRBc0RhdGFVUkwoZmlsZSlcbiAgICAgICAgcmVhZGVyLm9ubG9hZCA9ICgpID0+IHJlcyhyZWFkZXIucmVzdWx0IGFzIHN0cmluZylcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICByZWooZXJyKVxuICAgICAgfVxuICAgIH0pXG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIEJyb3dzZXJEaXJlY3RvcnlNYW5hZ2VyIGltcGxlbWVudHMgRGlyZWN0b3J5TWFuYWdlciB7XG4gIG5hbWU6IHN0cmluZ1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyBwYXRoOiBzdHJpbmcsXG4gICAgcHVibGljIGZpbGVzOiBGaWxlU3lzdGVtRmlsZUhhbmRsZVtdLCAvLyBMaWtlRmlsZVtdLFxuICAgIHB1YmxpYyBkaXJlY3RvcnlIYW5kbGVyOiBGaWxlU3lzdGVtRGlyZWN0b3J5SGFuZGxlLFxuICApIHtcbiAgICB0aGlzLm5hbWUgPSBnZXROYW1lQnlQYXRoKHBhdGgpXG4gIH1cblxuICBmaW5kRGlyZWN0b3J5IChcbiAgICBwYXRoOiBzdHJpbmcsXG4gICAgb3B0aW9ucz86IEZpbGVTeXN0ZW1HZXREaXJlY3RvcnlPcHRpb25zLFxuICApOiBQcm9taXNlPERpcmVjdG9yeU1hbmFnZXIgfCB1bmRlZmluZWQ+IHtcbiAgICByZXR1cm4gZmluZERpcmVjdG9yeVdpdGhpbihwYXRoLCB0aGlzLCBvcHRpb25zKVxuICB9XG4gIFxuICBhc3luYyBsaXN0KCk6IFByb21pc2U8c3RyaW5nW10+IHtcbiAgICBjb25zdCBmaWxlcyA9IGF3YWl0IGRpcmVjdG9yeVJlYWRUb0FycmF5KHRoaXMuZGlyZWN0b3J5SGFuZGxlcilcbiAgICByZXR1cm4gZmlsZXMubWFwKGZpbGUgPT4gZmlsZS5uYW1lKVxuICB9XG4gIFxuICBhc3luYyBsaXN0Rm9sZGVycygpOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gICAgY29uc3QgaXRlbXMgPSBhd2FpdCBkaXJlY3RvcnlSZWFkVG9BcnJheSh0aGlzLmRpcmVjdG9yeUhhbmRsZXIpXG4gICAgcmV0dXJuIGl0ZW1zLmZpbHRlcigoZmlsZTogYW55KSA9PiBmaWxlLmtpbmQgJiYgKGZpbGUgYXMgYW55KS5raW5kID09PSAnZGlyZWN0b3J5JylcbiAgICAgIC5tYXAoZmlsZSA9PiBmaWxlLm5hbWUpXG4gIH1cbiAgXG4gIGFzeW5jIGxpc3RGaWxlcygpOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gICAgY29uc3QgaXRlbXMgPSBhd2FpdCBkaXJlY3RvcnlSZWFkVG9BcnJheSh0aGlzLmRpcmVjdG9yeUhhbmRsZXIpXG4gICAgcmV0dXJuIGl0ZW1zLmZpbHRlcigoZmlsZTogYW55KSA9PiBmaWxlLmtpbmQgPT09ICdmaWxlJylcbiAgICAgIC5tYXAoKGZpbGU6IGFueSkgPT4gZmlsZS5uYW1lKVxuICB9XG4gIFxuICBhc3luYyBnZXRGb2xkZXJzKCk6IFByb21pc2U8QnJvd3NlckRpcmVjdG9yeU1hbmFnZXJbXT4ge1xuICAgIGNvbnN0IG5hbWVzID0gYXdhaXQgdGhpcy5saXN0Rm9sZGVycygpXG4gICAgcmV0dXJuIFByb21pc2UuYWxsKFxuICAgICAgbmFtZXMubWFwKGFzeW5jIG5hbWUgPT4gYXdhaXQgdGhpcy5nZXREaXJlY3RvcnkobmFtZSkpXG4gICAgKVxuICB9XG4gIFxuICBhc3luYyBnZXRGaWxlcygpOiBQcm9taXNlPERtRmlsZVJlYWRlcltdPiB7XG4gICAgY29uc3QgZmlsZXMgPSBhd2FpdCBkaXJlY3RvcnlSZWFkVG9BcnJheSh0aGlzLmRpcmVjdG9yeUhhbmRsZXIpXG4gICAgcmV0dXJuIGZpbGVzLmZpbHRlcihmaWxlID0+IGZpbGUua2luZCA9PT0gJ2ZpbGUnKVxuICAgICAgLm1hcChmaWxlID0+IG5ldyBCcm93c2VyRG1GaWxlUmVhZGVyKGZpbGUsIHRoaXMpKVxuICB9XG5cbiAgY3JlYXRlRGlyZWN0b3J5KG5ld1BhdGg6IHN0cmluZykge1xuICAgIHJldHVybiB0aGlzLmdldERpcmVjdG9yeShuZXdQYXRoLCB7IGNyZWF0ZTogdHJ1ZSB9KVxuICB9XG5cbiAgYXN5bmMgZ2V0RGlyZWN0b3J5KFxuICAgIG5ld1BhdGg6IHN0cmluZyxcbiAgICBvcHRpb25zPzogRmlsZVN5c3RlbUdldERpcmVjdG9yeU9wdGlvbnNcbiAgKTogUHJvbWlzZTxCcm93c2VyRGlyZWN0b3J5TWFuYWdlcj4ge1xuICAgIGlmICggIW5ld1BhdGggKSB7XG4gICAgICByZXR1cm4gdGhpc1xuICAgIH1cblxuICAgIGNvbnN0IG5ld1BhdGhBcnJheSA9IG5ld1BhdGguc3BsaXQoL1xcXFx8XFwvLylcbiAgICBsZXQgZnVsbE5ld1BhdGggPSB0aGlzLnBhdGhcbiAgICBsZXQgZGlyOiBGaWxlU3lzdGVtRGlyZWN0b3J5SGFuZGxlXG5cbiAgICB0cnkge1xuICAgICAgLy8gdHJhdmVyc2UgdGhyb3VnaCBlYWNoIGZvbGRlclxuICAgICAgZGlyICA9IGF3YWl0IG5ld1BhdGhBcnJheS5yZWR1Y2UoYXN5bmMgKGxhc3QsY3VycmVudCkgPT4ge1xuICAgICAgICBjb25zdCBuZXh0OiBGaWxlU3lzdGVtRGlyZWN0b3J5SGFuZGxlID0gYXdhaXQgbGFzdFxuICAgICAgICBjb25zdCBuZXdIYW5kbGUgPSBuZXh0LmdldERpcmVjdG9yeUhhbmRsZShjdXJyZW50LCBvcHRpb25zKVxuICAgICAgICBjb25zdCBuYW1lID0gKGF3YWl0IG5ld0hhbmRsZSkubmFtZVxuICAgICAgICBmdWxsTmV3UGF0aCA9IHBhdGguam9pbihmdWxsTmV3UGF0aCwgbmFtZSlcbiAgICAgICAgcmV0dXJuIG5ld0hhbmRsZVxuICAgICAgfSwgUHJvbWlzZS5yZXNvbHZlKHRoaXMuZGlyZWN0b3J5SGFuZGxlcikpXG4gICAgfSBjYXRjaCAoZXJyOiBhbnkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihlcnIubWVzc2FnZSArIGAuICR7bmV3UGF0aH0gbm90IGZvdW5kIGluICR7dGhpcy5uYW1lfSAoJHt0aGlzLnBhdGh9KWApXG4gICAgfVxuXG4gICAgY29uc3QgZmlsZXM6IEZpbGVTeXN0ZW1GaWxlSGFuZGxlW10gPSBhd2FpdCBkaXJlY3RvcnlSZWFkVG9BcnJheShkaXIpXG4gICAgY29uc3QgbmV3RGlyID0gbmV3IEJyb3dzZXJEaXJlY3RvcnlNYW5hZ2VyKFxuICAgICAgZnVsbE5ld1BhdGgsXG4gICAgICBmaWxlcyxcbiAgICAgIGRpclxuICAgIClcbiAgICByZXR1cm4gbmV3RGlyXG4gIH1cblxuICBhc3luYyByZW1vdmVFbnRyeShcbiAgICBuYW1lOiBzdHJpbmcsXG4gICAgb3B0aW9ucz86IHsgcmVjdXJzaXZlOiBib29sZWFuIH1cbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3Qgc3BsaXQgPSBuYW1lLnNwbGl0KC9cXFxcfFxcLy8pXG4gICAgY29uc3QgbGFzdE5hbWUgPSBzcGxpdC5wb3AoKSBhcyBzdHJpbmcgLy8gcmVtb3ZlIGxhc3QgaXRlbVxuICAgIGNvbnN0IGRpciA9IHNwbGl0Lmxlbmd0aCA+PSAxID8gYXdhaXQgdGhpcy5nZXREaXJlY3RvcnkoIHNwbGl0LmpvaW4oJy8nKSApIDogdGhpc1xuICAgIHJldHVybiBkaXIuZGlyZWN0b3J5SGFuZGxlci5yZW1vdmVFbnRyeShsYXN0TmFtZSwgb3B0aW9ucylcbiAgfVxuXG4gIGFzeW5jIHJlbmFtZUZpbGUoXG4gICAgb2xkRmlsZU5hbWU6IHN0cmluZyxcbiAgICBuZXdGaWxlTmFtZTogc3RyaW5nXG4gICkge1xuICAgIHJldHVybiByZW5hbWVGaWxlSW5EaXIob2xkRmlsZU5hbWUsIG5ld0ZpbGVOYW1lLCB0aGlzKVxuICB9XG5cbiAgYXN5bmMgZmlsZShwYXRoOiBzdHJpbmcsIG9wdGlvbnM/OiBGaWxlU3lzdGVtR2V0RmlsZU9wdGlvbnMpIHtcbiAgICBjb25zdCBmaW5kRmlsZSA9IGF3YWl0IHRoaXMuZmluZEZpbGVCeVBhdGgocGF0aClcbiAgICBpZiAoIGZpbmRGaWxlICkge1xuICAgICAgcmV0dXJuIGZpbmRGaWxlXG4gICAgfVxuXG4gICAgY29uc3QgZGlyID0gYXdhaXQgdGhpcy5nZXREaXJGb3JGaWxlUGF0aChwYXRoKSBhcyBCcm93c2VyRGlyZWN0b3J5TWFuYWdlclxuICAgIGNvbnN0IGZpbGVOYW1lID0gcGF0aC5zcGxpdCgvXFxcXHxcXC8vKS5wb3AoKSBhcyBzdHJpbmdcblxuICAgIGNvbnN0IGZpbGVIYW5kbGUgPSBhd2FpdCBkaXIuZGlyZWN0b3J5SGFuZGxlci5nZXRGaWxlSGFuZGxlKGZpbGVOYW1lLCBvcHRpb25zKVxuICAgIHJldHVybiBuZXcgQnJvd3NlckRtRmlsZVJlYWRlcihmaWxlSGFuZGxlLCB0aGlzKVxuICB9XG5cbiAgYXN5bmMgZmluZEZpbGVCeVBhdGgoXG4gICAgcGF0aDogc3RyaW5nLFxuICAgIGRpcmVjdG9yeUhhbmRsZXI6IGFueSA9IHRoaXMuZGlyZWN0b3J5SGFuZGxlcixcbiAgKTogUHJvbWlzZTxCcm93c2VyRG1GaWxlUmVhZGVyIHwgdW5kZWZpbmVkPiB7XG4gICAgY29uc3QgcGF0aFNwbGl0ID0gcGF0aC5zcGxpdCgvXFxcXHxcXC8vKVxuICAgIGNvbnN0IGZpbGVOYW1lID0gcGF0aFNwbGl0LnBvcCgpIC8vIHBhdGhTcGxpdFsgcGF0aFNwbGl0Lmxlbmd0aC0xIF1cblxuICAgIC8vIGNocm9tZSB3ZSBkaWcgdGhyb3VnaCB0aGUgZmlyc3Qgc2VsZWN0ZWQgZGlyZWN0b3J5IGFuZCBzZWFyY2ggdGhlIHN1YnNcbiAgICBpZiAoIHBhdGhTcGxpdC5sZW5ndGggKSB7XG4gICAgICBjb25zdCBkaXIgPSBhd2FpdCB0aGlzLmdldERpcmVjdG9yeSggcGF0aFNwbGl0LmpvaW4oJy8nKSApXG4gICAgICBkaXJlY3RvcnlIYW5kbGVyID0gZGlyLmRpcmVjdG9yeUhhbmRsZXJcbiAgICB9XG4gICAgXG4gICAgbGV0IGZpbGVzID0gdGhpcy5maWxlc1xuICAgIGZpbGVzID0gYXdhaXQgZGlyZWN0b3J5UmVhZFRvQXJyYXkoZGlyZWN0b3J5SGFuZGxlcilcbiAgICBjb25zdCBsaWtlRmlsZSA9IGZpbGVzLmZpbmQoZmlsZSA9PiBmaWxlLm5hbWUgPT09IGZpbGVOYW1lKVxuICAgIGlmICggIWxpa2VGaWxlICkge1xuICAgICAgcmV0dXJuXG4gICAgfVxuICAgIFxuICAgIC8vIHdoZW4gZm91bmQsIGNvbnZlcnQgdG8gRmlsZVxuICAgIC8vIGNvbnN0IGZpbGUgPSBhd2FpdCB0aGlzLmdldFN5c3RlbUZpbGUobGlrZUZpbGUpXG4gICAgcmV0dXJuIG5ldyBCcm93c2VyRG1GaWxlUmVhZGVyKGxpa2VGaWxlLCB0aGlzKVxuICB9XG4gIFxuICBhc3luYyBnZXREaXJGb3JGaWxlUGF0aChwYXRoOiBzdHJpbmcpIHtcbiAgICBjb25zdCBwYXRoU3BsaXQgPSBwYXRoLnNwbGl0KC9cXFxcfFxcLy8pXG4gICAgcGF0aFNwbGl0LnBvcCgpIGFzIHN0cmluZyAvLyBwYXRoU3BsaXRbIHBhdGhTcGxpdC5sZW5ndGgtMSBdXG4gIFxuICAgIHJldHVybiBhd2FpdCB0aGlzLmdldERpcmVjdG9yeSggcGF0aFNwbGl0LmpvaW4oJy8nKSApXG4gIH1cbn1cblxuIl19