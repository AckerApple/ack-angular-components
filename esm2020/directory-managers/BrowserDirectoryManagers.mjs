import { BaseDmFileReader } from "./DirectoryManagers";
import { directoryReadToArray } from "./directoryReadToArray.function";
import { path } from "./path";
export class BrowserDmFileReader extends BaseDmFileReader {
    constructor(file, directory) {
        super();
        this.file = file;
        this.directory = directory;
        this.name = file.name;
    }
    async stats() {
        return this.getRealFile();
    }
    async write(fileString) {
        let writableStream;
        const likeFile = this.file;
        const hasPermission = likeFile.queryPermission && await likeFile.queryPermission() === 'granted';
        if (hasPermission) {
            writableStream = await likeFile.createWritable();
        }
        else {
            // request where to save
            const id = this.name.replace(/[^a-zA-Z0-9]/g, '-') + '-filePicker';
            const savePickerOptions = {
                suggestedName: this.name,
                /*types: [{
                  description: 'JSON',
                  accept: {
                    'application/json': ['.json'],
                  },
                }],*/
            };
            savePickerOptions.id = id.slice(0, 32);
            const handle = await window.showSaveFilePicker(savePickerOptions);
            writableStream = await handle.createWritable();
        }
        // write our file
        await writableStream.write(fileString);
        // close the file and write the contents to disk.
        await writableStream.close();
    }
    async getRealFile() {
        const file = this.file;
        return file.getFile ? await file.getFile() : Promise.resolve(file);
    }
    readAsText() {
        return new Promise(async (res, rej) => {
            try {
                var reader = new FileReader();
                const file = await this.getRealFile();
                reader.readAsText(file);
                reader.onload = () => res(reader.result);
            }
            catch (err) {
                rej(err);
            }
        });
    }
    readAsDataURL() {
        return new Promise(async (res, rej) => {
            try {
                var reader = new FileReader();
                const file = await this.getRealFile();
                reader.readAsDataURL(file);
                reader.onload = () => res(reader.result);
            }
            catch (err) {
                rej(err);
            }
        });
    }
}
export class BrowserDirectoryManager {
    constructor(path, files, // LikeFile[],
    directoryHandler) {
        this.path = path;
        this.files = files;
        this.directoryHandler = directoryHandler;
        this.name = getNameByPath(path);
    }
    findDirectory(path, options) {
        return findDirectoryWithin(path, this, options);
    }
    async list() {
        return this.files.map(file => file.name);
    }
    async listFolders() {
        return this.files.filter(file => file.kind && file.kind === 'directory')
            .map(file => file.name);
    }
    async listFiles() {
        return this.files.filter(file => file.kind === 'file')
            .map(file => file.name);
    }
    async getFolders() {
        return Promise.all(this.files.filter(file => file.kind && file.kind === 'directory')
            .map(async (file) => await this.getDirectory(file.name)));
    }
    async getFiles() {
        return this.files.filter(file => file.kind === 'file')
            .map(file => new BrowserDmFileReader(file, this));
    }
    async getDirectory(newPath, options) {
        const newPathArray = newPath.split('/');
        let fullNewPath = this.path;
        let dir;
        try {
            // traverse through each folder
            dir = await newPathArray.reduce(async (last, current) => {
                const next = await last;
                const newHandle = next.getDirectoryHandle(current, options);
                const name = (await newHandle).name;
                fullNewPath = path.join(fullNewPath, name);
                return newHandle;
            }, Promise.resolve(this.directoryHandler));
        }
        catch (err) {
            throw new Error(err.message + `. ${newPath} not found in ${this.name} (${this.path})`);
        }
        const files = await directoryReadToArray(dir);
        const newDir = new BrowserDirectoryManager(fullNewPath, files, dir);
        return newDir;
    }
    async file(fileName, options) {
        const findFile = await this.findFileByPath(fileName);
        if (findFile) {
            return findFile;
        }
        const fileHandle = await this.directoryHandler.getFileHandle(fileName, options);
        return new BrowserDmFileReader(fileHandle, this);
    }
    async findFileByPath(path, directoryHandler = this.directoryHandler) {
        if (!this.files.length) {
            return;
        }
        const pathSplit = path.split('/');
        const fileName = pathSplit[pathSplit.length - 1];
        // chrome we dig through the first selected directory and search the subs
        if (pathSplit.length > 1) {
            const lastParent = pathSplit.shift(); // remove index 0 of lastParent/firstParent/file.xyz
            const newHandler = await directoryHandler.getDirectoryHandle(lastParent);
            if (!newHandler) {
                console.debug('no matching upper folder', lastParent, directoryHandler);
                return;
            }
            const newPath = pathSplit.join('/');
            const dirMan = await this.getDirectory(lastParent);
            return dirMan.findFileByPath(newPath, newHandler);
        }
        let files = this.files;
        if (directoryHandler) {
            files = await directoryReadToArray(directoryHandler);
        }
        const likeFile = files.find(file => file.name === fileName);
        if (!likeFile) {
            return;
        }
        // when found, convert to File
        // const file = await this.getSystemFile(likeFile)
        return new BrowserDmFileReader(likeFile, this);
    }
}
export function getNameByPath(path) {
    const half = path.split(/\//).pop();
    return half.split(/\\/).pop();
}
export async function findDirectoryWithin(path, inDir, options) {
    const pathSplit = path.split('/');
    if (pathSplit.length > 1) {
        const lastParent = pathSplit.shift(); // remove index 0 of lastParent/firstParent/file.xyz
        const parent = await inDir.getDirectory(lastParent);
        if (!parent) {
            return; // undefined
        }
        return await findDirectoryWithin(lastParent, parent, options);
    }
    return inDir; // return last result
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQnJvd3NlckRpcmVjdG9yeU1hbmFnZXJzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2RpcmVjdG9yeS1tYW5hZ2Vycy9Ccm93c2VyRGlyZWN0b3J5TWFuYWdlcnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGdCQUFnQixFQUFrQyxNQUFNLHFCQUFxQixDQUFBO0FBQ3RGLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLGlDQUFpQyxDQUFBO0FBQ3RFLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxRQUFRLENBQUE7QUFFN0IsTUFBTSxPQUFPLG1CQUFvQixTQUFRLGdCQUFnQjtJQUd2RCxZQUNTLElBQWlDLEVBQ2pDLFNBQTJCO1FBRWxDLEtBQUssRUFBRSxDQUFBO1FBSEEsU0FBSSxHQUFKLElBQUksQ0FBNkI7UUFDakMsY0FBUyxHQUFULFNBQVMsQ0FBa0I7UUFHbEMsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFBO0lBQ3ZCLENBQUM7SUFFRCxLQUFLLENBQUMsS0FBSztRQUNULE9BQU8sSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFBO0lBQzNCLENBQUM7SUFFRCxLQUFLLENBQUMsS0FBSyxDQUFDLFVBQWtCO1FBQzVCLElBQUksY0FBbUIsQ0FBQTtRQUN2QixNQUFNLFFBQVEsR0FBUSxJQUFJLENBQUMsSUFBSSxDQUFBO1FBQy9CLE1BQU0sYUFBYSxHQUFHLFFBQVEsQ0FBQyxlQUFlLElBQUksTUFBTSxRQUFRLENBQUMsZUFBZSxFQUFFLEtBQUssU0FBUyxDQUFBO1FBRWhHLElBQUssYUFBYSxFQUFHO1lBQ25CLGNBQWMsR0FBRyxNQUFNLFFBQVEsQ0FBQyxjQUFjLEVBQUUsQ0FBQTtTQUNqRDthQUFNO1lBQ0wsd0JBQXdCO1lBQ3hCLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLGVBQWUsRUFBQyxHQUFHLENBQUMsR0FBQyxhQUFh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QU0sbUJBQW1CLENBQUMsVUFBVSxFQUFFLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQTtLQUM5RDtJQUVELE9BQU8sS0FBSyxDQUFBLENBQUMscUJBQXFCO0FBQ3BDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCYXNlRG1GaWxlUmVhZGVyLCBEaXJlY3RvcnlNYW5hZ2VyLCBEbUZpbGVSZWFkZXIgfSBmcm9tIFwiLi9EaXJlY3RvcnlNYW5hZ2Vyc1wiXG5pbXBvcnQgeyBkaXJlY3RvcnlSZWFkVG9BcnJheSB9IGZyb20gXCIuL2RpcmVjdG9yeVJlYWRUb0FycmF5LmZ1bmN0aW9uXCJcbmltcG9ydCB7IHBhdGggfSBmcm9tIFwiLi9wYXRoXCJcblxuZXhwb3J0IGNsYXNzIEJyb3dzZXJEbUZpbGVSZWFkZXIgZXh0ZW5kcyBCYXNlRG1GaWxlUmVhZGVyIGltcGxlbWVudHMgRG1GaWxlUmVhZGVyIHtcbiAgbmFtZTogc3RyaW5nXG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHVibGljIGZpbGU6IEZpbGUgfCBGaWxlU3lzdGVtRmlsZUhhbmRsZSxcbiAgICBwdWJsaWMgZGlyZWN0b3J5OiBEaXJlY3RvcnlNYW5hZ2VyXG4gICkge1xuICAgIHN1cGVyKClcbiAgICB0aGlzLm5hbWUgPSBmaWxlLm5hbWVcbiAgfVxuXG4gIGFzeW5jIHN0YXRzKCkge1xuICAgIHJldHVybiB0aGlzLmdldFJlYWxGaWxlKClcbiAgfVxuXG4gIGFzeW5jIHdyaXRlKGZpbGVTdHJpbmc6IHN0cmluZykge1xuICAgIGxldCB3cml0YWJsZVN0cmVhbTogYW55XG4gICAgY29uc3QgbGlrZUZpbGU6IGFueSA9IHRoaXMuZmlsZVxuICAgIGNvbnN0IGhhc1Blcm1pc3Npb24gPSBsaWtlRmlsZS5xdWVyeVBlcm1pc3Npb24gJiYgYXdhaXQgbGlrZUZpbGUucXVlcnlQZXJtaXNzaW9uKCkgPT09ICdncmFudGVkJ1xuXG4gICAgaWYgKCBoYXNQZXJtaXNzaW9uICkge1xuICAgICAgd3JpdGFibGVTdHJlYW0gPSBhd2FpdCBsaWtlRmlsZS5jcmVhdGVXcml0YWJsZSgpXG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIHJlcXVlc3Qgd2hlcmUgdG8gc2F2ZVxuICAgICAgY29uc3QgaWQgPSB0aGlzLm5hbWUucmVwbGFjZSgvW15hLXpBLVowLTldL2csJy0nKSsnLWZpbGVQaWNrZXInXG4gICAgICBjb25zdCBzYXZlUGlja2VyT3B0aW9ucyA9IHtcbiAgICAgICAgc3VnZ2VzdGVkTmFtZTogdGhpcy5uYW1lLFxuICAgICAgICAvKnR5cGVzOiBbe1xuICAgICAgICAgIGRlc2NyaXB0aW9uOiAnSlNPTicsXG4gICAgICAgICAgYWNjZXB0OiB7XG4gICAgICAgICAgICAnYXBwbGljYXRpb24vanNvbic6IFsnLmpzb24nXSxcbiAgICAgICAgICB9LFxuICAgICAgICB9XSwqL1xuICAgICAgfVxuXG4gICAgICAvLyBiZWxvdywgdGhvdWdodCB0byByZW1lbWJlciBsYXN0IG1hdGNoaW5nIGZpbGUgKGkgdGhpbmsgZGF0YSB0eXBpbmcgaXMganVzdCBtaXNzaW5nIGZvciBpdClcbiAgICAgIDsoc2F2ZVBpY2tlck9wdGlvbnMgYXMgYW55KS5pZCA9IGlkLnNsaWNlKDAsIDMyKVxuXG4gICAgICBjb25zdCBoYW5kbGUgPSBhd2FpdCB3aW5kb3cuc2hvd1NhdmVGaWxlUGlja2VyKHNhdmVQaWNrZXJPcHRpb25zKVxuICAgICAgXG4gICAgICB3cml0YWJsZVN0cmVhbSA9IGF3YWl0IGhhbmRsZS5jcmVhdGVXcml0YWJsZSgpXG4gICAgfVxuXG5cbiAgICAvLyB3cml0ZSBvdXIgZmlsZVxuICAgIGF3YWl0IHdyaXRhYmxlU3RyZWFtLndyaXRlKCBmaWxlU3RyaW5nIClcblxuICAgIC8vIGNsb3NlIHRoZSBmaWxlIGFuZCB3cml0ZSB0aGUgY29udGVudHMgdG8gZGlzay5cbiAgICBhd2FpdCB3cml0YWJsZVN0cmVhbS5jbG9zZSgpXG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGdldFJlYWxGaWxlKCk6IFByb21pc2U8RmlsZT4ge1xuICAgIGNvbnN0IGZpbGUgPSB0aGlzLmZpbGUgYXMgYW55XG4gICAgcmV0dXJuIGZpbGUuZ2V0RmlsZSA/IGF3YWl0IGZpbGUuZ2V0RmlsZSgpIDogUHJvbWlzZS5yZXNvbHZlKGZpbGUpXG4gIH1cbiAgXG4gIG92ZXJyaWRlIHJlYWRBc1RleHQoKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoYXN5bmMgKHJlcywgcmVqKSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICB2YXIgcmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKVxuICAgICAgICBjb25zdCBmaWxlID0gYXdhaXQgdGhpcy5nZXRSZWFsRmlsZSgpXG4gICAgICAgIHJlYWRlci5yZWFkQXNUZXh0KGZpbGUpXG4gICAgICAgIHJlYWRlci5vbmxvYWQgPSAoKSA9PiByZXMocmVhZGVyLnJlc3VsdCBhcyBzdHJpbmcpXG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgcmVqKGVycilcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgcmVhZEFzRGF0YVVSTCgpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZShhc3luYyAocmVzLCByZWopID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIHZhciByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpXG4gICAgICAgIGNvbnN0IGZpbGUgPSBhd2FpdCB0aGlzLmdldFJlYWxGaWxlKClcbiAgICAgICAgcmVhZGVyLnJlYWRBc0RhdGFVUkwoZmlsZSlcbiAgICAgICAgcmVhZGVyLm9ubG9hZCA9ICgpID0+IHJlcyhyZWFkZXIucmVzdWx0IGFzIHN0cmluZylcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICByZWooZXJyKVxuICAgICAgfVxuICAgIH0pXG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIEJyb3dzZXJEaXJlY3RvcnlNYW5hZ2VyIGltcGxlbWVudHMgRGlyZWN0b3J5TWFuYWdlciB7XG4gIG5hbWU6IHN0cmluZ1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyBwYXRoOiBzdHJpbmcsXG4gICAgcHVibGljIGZpbGVzOiBGaWxlU3lzdGVtRmlsZUhhbmRsZVtdLCAvLyBMaWtlRmlsZVtdLFxuICAgIHB1YmxpYyBkaXJlY3RvcnlIYW5kbGVyOiBGaWxlU3lzdGVtRGlyZWN0b3J5SGFuZGxlLFxuICApIHtcbiAgICB0aGlzLm5hbWUgPSBnZXROYW1lQnlQYXRoKHBhdGgpXG4gIH1cblxuICBmaW5kRGlyZWN0b3J5IChcbiAgICBwYXRoOiBzdHJpbmcsXG4gICAgb3B0aW9ucz86IEZpbGVTeXN0ZW1HZXREaXJlY3RvcnlPcHRpb25zLFxuICApOiBQcm9taXNlPERpcmVjdG9yeU1hbmFnZXIgfCB1bmRlZmluZWQ+IHtcbiAgICByZXR1cm4gZmluZERpcmVjdG9yeVdpdGhpbihwYXRoLCB0aGlzLCBvcHRpb25zKVxuICB9XG4gIFxuICBhc3luYyBsaXN0KCk6IFByb21pc2U8c3RyaW5nW10+IHtcbiAgICByZXR1cm4gdGhpcy5maWxlcy5tYXAoZmlsZSA9PiBmaWxlLm5hbWUpXG4gIH1cbiAgXG4gIGFzeW5jIGxpc3RGb2xkZXJzKCk6IFByb21pc2U8c3RyaW5nW10+IHtcbiAgICByZXR1cm4gdGhpcy5maWxlcy5maWx0ZXIoZmlsZSA9PiBmaWxlLmtpbmQgJiYgKGZpbGUgYXMgYW55KS5raW5kID09PSAnZGlyZWN0b3J5JylcbiAgICAgIC5tYXAoZmlsZSA9PiBmaWxlLm5hbWUpXG4gIH1cbiAgXG4gIGFzeW5jIGxpc3RGaWxlcygpOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gICAgcmV0dXJuIHRoaXMuZmlsZXMuZmlsdGVyKGZpbGUgPT4gZmlsZS5raW5kID09PSAnZmlsZScpXG4gICAgICAubWFwKGZpbGUgPT4gZmlsZS5uYW1lKVxuICB9XG4gIFxuICBhc3luYyBnZXRGb2xkZXJzKCk6IFByb21pc2U8QnJvd3NlckRpcmVjdG9yeU1hbmFnZXJbXT4ge1xuICAgIHJldHVybiBQcm9taXNlLmFsbChcbiAgICAgIHRoaXMuZmlsZXMuZmlsdGVyKGZpbGUgPT4gZmlsZS5raW5kICYmIChmaWxlIGFzIGFueSkua2luZCA9PT0gJ2RpcmVjdG9yeScpXG4gICAgICAgIC5tYXAoYXN5bmMgZmlsZSA9PiBhd2FpdCB0aGlzLmdldERpcmVjdG9yeShmaWxlLm5hbWUpKVxuICAgIClcbiAgfVxuICBcbiAgYXN5bmMgZ2V0RmlsZXMoKTogUHJvbWlzZTxEbUZpbGVSZWFkZXJbXT4ge1xuICAgIHJldHVybiB0aGlzLmZpbGVzLmZpbHRlcihmaWxlID0+IGZpbGUua2luZCA9PT0gJ2ZpbGUnKVxuICAgICAgLm1hcChmaWxlID0+IG5ldyBCcm93c2VyRG1GaWxlUmVhZGVyKGZpbGUsIHRoaXMpKVxuICB9XG5cbiAgYXN5bmMgZ2V0RGlyZWN0b3J5KFxuICAgIG5ld1BhdGg6IHN0cmluZyxcbiAgICBvcHRpb25zPzogRmlsZVN5c3RlbUdldERpcmVjdG9yeU9wdGlvbnNcbiAgKTogUHJvbWlzZTxCcm93c2VyRGlyZWN0b3J5TWFuYWdlcj4ge1xuICAgIGNvbnN0IG5ld1BhdGhBcnJheSA9IG5ld1BhdGguc3BsaXQoJy8nKVxuICAgIGxldCBmdWxsTmV3UGF0aCA9IHRoaXMucGF0aFxuICAgIGxldCBkaXI6IEZpbGVTeXN0ZW1EaXJlY3RvcnlIYW5kbGVcblxuICAgIHRyeSB7XG4gICAgICAvLyB0cmF2ZXJzZSB0aHJvdWdoIGVhY2ggZm9sZGVyXG4gICAgICBkaXIgID0gYXdhaXQgbmV3UGF0aEFycmF5LnJlZHVjZShhc3luYyAobGFzdCxjdXJyZW50KSA9PiB7XG4gICAgICAgIGNvbnN0IG5leHQ6IEZpbGVTeXN0ZW1EaXJlY3RvcnlIYW5kbGUgPSBhd2FpdCBsYXN0XG4gICAgICAgIGNvbnN0IG5ld0hhbmRsZSA9IG5leHQuZ2V0RGlyZWN0b3J5SGFuZGxlKGN1cnJlbnQsIG9wdGlvbnMpXG4gICAgICAgIGNvbnN0IG5hbWUgPSAoYXdhaXQgbmV3SGFuZGxlKS5uYW1lXG4gICAgICAgIGZ1bGxOZXdQYXRoID0gcGF0aC5qb2luKGZ1bGxOZXdQYXRoLCBuYW1lKVxuICAgICAgICByZXR1cm4gbmV3SGFuZGxlXG4gICAgICB9LCBQcm9taXNlLnJlc29sdmUodGhpcy5kaXJlY3RvcnlIYW5kbGVyKSlcbiAgICB9IGNhdGNoIChlcnI6IGFueSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGVyci5tZXNzYWdlICsgYC4gJHtuZXdQYXRofSBub3QgZm91bmQgaW4gJHt0aGlzLm5hbWV9ICgke3RoaXMucGF0aH0pYClcbiAgICB9XG5cbiAgICBjb25zdCBmaWxlczogRmlsZVN5c3RlbUZpbGVIYW5kbGVbXSA9IGF3YWl0IGRpcmVjdG9yeVJlYWRUb0FycmF5KGRpcilcbiAgICBjb25zdCBuZXdEaXIgPSBuZXcgQnJvd3NlckRpcmVjdG9yeU1hbmFnZXIoXG4gICAgICBmdWxsTmV3UGF0aCxcbiAgICAgIGZpbGVzLFxuICAgICAgZGlyXG4gICAgKVxuICAgIHJldHVybiBuZXdEaXJcbiAgfVxuXG4gIGFzeW5jIGZpbGUoZmlsZU5hbWU6IHN0cmluZywgb3B0aW9ucz86IEZpbGVTeXN0ZW1HZXRGaWxlT3B0aW9ucykge1xuICAgIGNvbnN0IGZpbmRGaWxlID0gYXdhaXQgdGhpcy5maW5kRmlsZUJ5UGF0aChmaWxlTmFtZSlcblxuICAgIGlmICggZmluZEZpbGUgKSB7XG4gICAgICByZXR1cm4gZmluZEZpbGVcbiAgICB9XG5cbiAgICBjb25zdCBmaWxlSGFuZGxlID0gYXdhaXQgdGhpcy5kaXJlY3RvcnlIYW5kbGVyLmdldEZpbGVIYW5kbGUoZmlsZU5hbWUsIG9wdGlvbnMpXG4gICAgcmV0dXJuIG5ldyBCcm93c2VyRG1GaWxlUmVhZGVyKGZpbGVIYW5kbGUsIHRoaXMpXG4gIH1cblxuICBhc3luYyBmaW5kRmlsZUJ5UGF0aChcbiAgICBwYXRoOiBzdHJpbmcsXG4gICAgZGlyZWN0b3J5SGFuZGxlcjogYW55ID0gdGhpcy5kaXJlY3RvcnlIYW5kbGVyLFxuICApOiBQcm9taXNlPEJyb3dzZXJEbUZpbGVSZWFkZXIgfCB1bmRlZmluZWQ+IHtcbiAgICBpZiAoICF0aGlzLmZpbGVzLmxlbmd0aCApIHtcbiAgICAgIHJldHVyblxuICAgIH1cblxuICAgIGNvbnN0IHBhdGhTcGxpdCA9IHBhdGguc3BsaXQoJy8nKVxuICAgIGNvbnN0IGZpbGVOYW1lID0gcGF0aFNwbGl0WyBwYXRoU3BsaXQubGVuZ3RoLTEgXVxuXG4gICAgLy8gY2hyb21lIHdlIGRpZyB0aHJvdWdoIHRoZSBmaXJzdCBzZWxlY3RlZCBkaXJlY3RvcnkgYW5kIHNlYXJjaCB0aGUgc3Vic1xuICAgIGlmICggcGF0aFNwbGl0Lmxlbmd0aCA+IDEgKSB7XG4gICAgICBjb25zdCBsYXN0UGFyZW50ID0gcGF0aFNwbGl0LnNoaWZ0KCkgYXMgc3RyaW5nIC8vIHJlbW92ZSBpbmRleCAwIG9mIGxhc3RQYXJlbnQvZmlyc3RQYXJlbnQvZmlsZS54eXpcbiAgICAgIGNvbnN0IG5ld0hhbmRsZXIgPSBhd2FpdCBkaXJlY3RvcnlIYW5kbGVyLmdldERpcmVjdG9yeUhhbmRsZSggbGFzdFBhcmVudCApXG4gICAgICBcbiAgICAgIGlmICggIW5ld0hhbmRsZXIgKSB7XG4gICAgICAgIGNvbnNvbGUuZGVidWcoJ25vIG1hdGNoaW5nIHVwcGVyIGZvbGRlcicsIGxhc3RQYXJlbnQsIGRpcmVjdG9yeUhhbmRsZXIpXG4gICAgICAgIHJldHVyblxuICAgICAgfVxuXG4gICAgICBjb25zdCBuZXdQYXRoID0gcGF0aFNwbGl0LmpvaW4oJy8nKVxuICAgICAgY29uc3QgZGlyTWFuID0gYXdhaXQgdGhpcy5nZXREaXJlY3RvcnkobGFzdFBhcmVudClcbiAgICAgIFxuICAgICAgcmV0dXJuIGRpck1hbi5maW5kRmlsZUJ5UGF0aChuZXdQYXRoLCBuZXdIYW5kbGVyKVxuICAgIH1cbiAgICBcbiAgICBsZXQgZmlsZXMgPSB0aGlzLmZpbGVzXG4gICAgaWYgKCBkaXJlY3RvcnlIYW5kbGVyICkge1xuICAgICAgZmlsZXMgPSBhd2FpdCBkaXJlY3RvcnlSZWFkVG9BcnJheShkaXJlY3RvcnlIYW5kbGVyKVxuICAgIH1cbiAgICBcbiAgICBjb25zdCBsaWtlRmlsZSA9IGZpbGVzLmZpbmQoZmlsZSA9PiBmaWxlLm5hbWUgPT09IGZpbGVOYW1lKVxuICAgIGlmICggIWxpa2VGaWxlICkge1xuICAgICAgcmV0dXJuXG4gICAgfVxuICAgIFxuICAgIC8vIHdoZW4gZm91bmQsIGNvbnZlcnQgdG8gRmlsZVxuICAgIC8vIGNvbnN0IGZpbGUgPSBhd2FpdCB0aGlzLmdldFN5c3RlbUZpbGUobGlrZUZpbGUpXG4gICAgXG4gICAgcmV0dXJuIG5ldyBCcm93c2VyRG1GaWxlUmVhZGVyKGxpa2VGaWxlLCB0aGlzKVxuICB9XG59XG5cblxuZXhwb3J0IGZ1bmN0aW9uIGdldE5hbWVCeVBhdGgocGF0aDogc3RyaW5nKSB7XG4gIGNvbnN0IGhhbGYgPSBwYXRoLnNwbGl0KC9cXC8vKS5wb3AoKSBhcyBzdHJpbmdcbiAgcmV0dXJuIGhhbGYuc3BsaXQoL1xcXFwvKS5wb3AoKSBhcyBzdHJpbmdcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGZpbmREaXJlY3RvcnlXaXRoaW4oXG4gIHBhdGg6IHN0cmluZyxcbiAgaW5EaXI6IERpcmVjdG9yeU1hbmFnZXIsXG4gIG9wdGlvbnM/OiBGaWxlU3lzdGVtR2V0RGlyZWN0b3J5T3B0aW9ucyxcbik6IFByb21pc2U8RGlyZWN0b3J5TWFuYWdlciB8IHVuZGVmaW5lZD4ge1xuICBjb25zdCBwYXRoU3BsaXQgPSBwYXRoLnNwbGl0KCcvJylcblxuICBpZiAoIHBhdGhTcGxpdC5sZW5ndGggPiAxICkge1xuICAgIGNvbnN0IGxhc3RQYXJlbnQgPSBwYXRoU3BsaXQuc2hpZnQoKSBhcyBzdHJpbmcgLy8gcmVtb3ZlIGluZGV4IDAgb2YgbGFzdFBhcmVudC9maXJzdFBhcmVudC9maWxlLnh5elxuICAgIGNvbnN0IHBhcmVudCA9IGF3YWl0IGluRGlyLmdldERpcmVjdG9yeShsYXN0UGFyZW50KVxuICAgIGlmICggIXBhcmVudCApIHtcbiAgICAgIHJldHVybiAvLyB1bmRlZmluZWRcbiAgICB9XG4gICAgcmV0dXJuIGF3YWl0IGZpbmREaXJlY3RvcnlXaXRoaW4obGFzdFBhcmVudCwgcGFyZW50LCBvcHRpb25zKVxuICB9XG5cbiAgcmV0dXJuIGluRGlyIC8vIHJldHVybiBsYXN0IHJlc3VsdFxufVxuIl19