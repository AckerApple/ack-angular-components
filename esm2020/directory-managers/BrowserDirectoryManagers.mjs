import { BaseDmFileReader, findDirectoryWithin, getNameByPath, renameFileInDir } from "./DirectoryManagers";
import { directoryReadToArray } from "./directoryReadToArray.function";
import { path } from "./path";
export class BrowserDmFileReader extends BaseDmFileReader {
    constructor(file, directory) {
        super();
        this.file = file;
        this.directory = directory;
        this.name = file.name;
    }
    async stats() {
        return this.getRealFile();
    }
    async write(fileString) {
        let writableStream;
        const likeFile = this.file;
        const hasPermission = likeFile.queryPermission && await likeFile.queryPermission() === 'granted';
        if (hasPermission) {
            writableStream = await likeFile.createWritable();
        }
        else {
            // request where to save
            const id = this.name.replace(/[^a-zA-Z0-9]/g, '-') + '-filePicker';
            const savePickerOptions = {
                suggestedName: this.name,
                /*types: [{
                  description: 'JSON',
                  accept: {
                    'application/json': ['.json'],
                  },
                }],*/
            };
            savePickerOptions.id = id.slice(0, 32);
            const handle = await window.showSaveFilePicker(savePickerOptions);
            writableStream = await handle.createWritable();
        }
        // write our file
        await writableStream.write(fileString);
        // close the file and write the contents to disk.
        await writableStream.close();
    }
    async getRealFile() {
        const file = this.file;
        return file.getFile ? await file.getFile() : Promise.resolve(file);
    }
    readAsText() {
        return new Promise(async (res, rej) => {
            try {
                var reader = new FileReader();
                const file = await this.getRealFile();
                reader.readAsText(file);
                reader.onload = () => res(reader.result);
            }
            catch (err) {
                rej(err);
            }
        });
    }
    readAsDataURL() {
        return new Promise(async (res, rej) => {
            try {
                var reader = new FileReader();
                const file = await this.getRealFile();
                reader.readAsDataURL(file);
                reader.onload = () => res(reader.result);
            }
            catch (err) {
                rej(err);
            }
        });
    }
}
export class BrowserDirectoryManager {
    constructor(path, files, // LikeFile[],
    directoryHandler) {
        this.path = path;
        this.files = files;
        this.directoryHandler = directoryHandler;
        this.name = getNameByPath(path);
    }
    findDirectory(path, options) {
        return findDirectoryWithin(path, this, options);
    }
    async list() {
        const files = await directoryReadToArray(this.directoryHandler);
        return files.map(file => file.name);
    }
    async listFolders() {
        const items = await directoryReadToArray(this.directoryHandler);
        return items.filter((file) => file.kind && file.kind === 'directory')
            .map(file => file.name);
    }
    async listFiles() {
        const items = await this.list();
        return items.filter((file) => file.kind === 'file')
            .map((file) => file.name);
    }
    async getFolders() {
        const names = await this.listFolders();
        return Promise.all(names.map(async (name) => await this.getDirectory(name)));
    }
    async getFiles() {
        const files = await directoryReadToArray(this.directoryHandler);
        return files.filter(file => file.kind === 'file')
            .map(file => new BrowserDmFileReader(file, this));
    }
    createDirectory(newPath) {
        return this.getDirectory(newPath, { create: true });
    }
    async getDirectory(newPath, options) {
        if (!newPath) {
            return this;
        }
        const newPathArray = newPath.split('/');
        let fullNewPath = this.path;
        let dir;
        try {
            // traverse through each folder
            dir = await newPathArray.reduce(async (last, current) => {
                const next = await last;
                const newHandle = next.getDirectoryHandle(current, options);
                const name = (await newHandle).name;
                fullNewPath = path.join(fullNewPath, name);
                return newHandle;
            }, Promise.resolve(this.directoryHandler));
        }
        catch (err) {
            throw new Error(err.message + `. ${newPath} not found in ${this.name} (${this.path})`);
        }
        const files = await directoryReadToArray(dir);
        const newDir = new BrowserDirectoryManager(fullNewPath, files, dir);
        return newDir;
    }
    async removeEntry(name, options) {
        const split = name.split('/');
        const lastName = split.pop(); // remove last item
        const dir = split.length >= 1 ? await this.getDirectory(split.join('/')) : this;
        return dir.directoryHandler.removeEntry(lastName, options);
    }
    async renameFile(oldFileName, newFileName) {
        return renameFileInDir(oldFileName, newFileName, this);
    }
    async file(path, options) {
        const findFile = await this.findFileByPath(path);
        if (findFile) {
            return findFile;
        }
        const dir = await this.getDirForFilePath(path);
        const fileName = path.split('/').pop();
        const fileHandle = await dir.directoryHandler.getFileHandle(fileName, options);
        return new BrowserDmFileReader(fileHandle, this);
    }
    async findFileByPath(path, directoryHandler = this.directoryHandler) {
        const pathSplit = path.split('/');
        const fileName = pathSplit.pop(); // pathSplit[ pathSplit.length-1 ]
        // chrome we dig through the first selected directory and search the subs
        if (pathSplit.length) {
            const dir = await this.getDirectory(pathSplit.join('/'));
            directoryHandler = dir.directoryHandler;
        }
        let files = this.files;
        files = await directoryReadToArray(directoryHandler);
        const likeFile = files.find(file => file.name === fileName);
        if (!likeFile) {
            return;
        }
        // when found, convert to File
        // const file = await this.getSystemFile(likeFile)
        return new BrowserDmFileReader(likeFile, this);
    }
    async getDirForFilePath(path) {
        const pathSplit = path.split('/');
        pathSplit.pop(); // pathSplit[ pathSplit.length-1 ]
        return await this.getDirectory(pathSplit.join('/'));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQnJvd3NlckRpcmVjdG9yeU1hbmFnZXJzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2RpcmVjdG9yeS1tYW5hZ2Vycy9Ccm93c2VyRGlyZWN0b3J5TWFuYWdlcnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGdCQUFnQixFQUFrQyxtQkFBbUIsRUFBRSxhQUFhLEVBQUUsZUFBZSxFQUFFLE1BQU0scUJBQXFCLENBQUE7QUFDM0ksT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0saUNBQWlDLENBQUE7QUFDdEUsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLFFBQVEsQ0FBQTtBQUU3QixNQUFNLE9BQU8sbUJBQW9CLFNBQVEsZ0JBQWdCO0lBR3ZELFlBQ1MsSUFBaUMsRUFDakMsU0FBMkI7UUFFbEMsS0FBSyxFQUFFLENBQUE7UUFIQSxTQUFJLEdBQUosSUFBSSxDQUE2QjtRQUNqQyxjQUFTLEdBQVQsU0FBUyxDQUFrQjtRQUdsQyxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUE7SUFDdkIsQ0FBQztJQUVELEtBQUssQ0FBQyxLQUFLO1FBQ1QsT0FBTyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUE7SUFDM0IsQ0FBQztJQUVELEtBQUssQ0FBQyxLQUFLLENBQUMsVUFBa0I7UUFDNUIsSUFBSSxjQUFtQixDQUFBO1FBQ3ZCLE1BQU0sUUFBUSxHQUFRLElBQUksQ0FBQyxJQUFJLENBQUE7UUFDL0IsTUFBTSxhQUFhLEdBQUcsUUFBUSxDQUFDLGVBQWUsSUFBSSxNQUFNLFFBQVEsQ0FBQyxlQUFlLEVBQUUsS0FBSyxTQUFTLENBQUE7UUFFaEcsSUFBSyxhQUFhLEVBQUc7WUFDbkIsY0FBYyxHQUFHLE1BQU0sUUFBUSxDQUFDLGNBQWMsRUFBRSxDQUFBO1NBQ2pEO2FBQU07WUFDTCx3QkFBd0I7WUFDeEIsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENB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REFBa0Q7UUFDbEQsT0FBTyxJQUFJLG1CQUFtQixDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQTtJQUNoRCxDQUFDO0lBRUQsS0FBSyxDQUFDLGlCQUFpQixDQUFDLElBQVk7UUFDbEMsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQTtRQUNqQyxTQUFTLENBQUMsR0FBRyxFQUFZLENBQUEsQ0FBQyxrQ0FBa0M7UUFFNUQsT0FBTyxNQUFNLElBQUksQ0FBQyxZQUFZLENBQUUsU0FBUyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBRSxDQUFBO0lBQ3ZELENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJhc2VEbUZpbGVSZWFkZXIsIERpcmVjdG9yeU1hbmFnZXIsIERtRmlsZVJlYWRlciwgZmluZERpcmVjdG9yeVdpdGhpbiwgZ2V0TmFtZUJ5UGF0aCwgcmVuYW1lRmlsZUluRGlyIH0gZnJvbSBcIi4vRGlyZWN0b3J5TWFuYWdlcnNcIlxuaW1wb3J0IHsgZGlyZWN0b3J5UmVhZFRvQXJyYXkgfSBmcm9tIFwiLi9kaXJlY3RvcnlSZWFkVG9BcnJheS5mdW5jdGlvblwiXG5pbXBvcnQgeyBwYXRoIH0gZnJvbSBcIi4vcGF0aFwiXG5cbmV4cG9ydCBjbGFzcyBCcm93c2VyRG1GaWxlUmVhZGVyIGV4dGVuZHMgQmFzZURtRmlsZVJlYWRlciBpbXBsZW1lbnRzIERtRmlsZVJlYWRlciB7XG4gIG5hbWU6IHN0cmluZ1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyBmaWxlOiBGaWxlIHwgRmlsZVN5c3RlbUZpbGVIYW5kbGUsXG4gICAgcHVibGljIGRpcmVjdG9yeTogRGlyZWN0b3J5TWFuYWdlclxuICApIHtcbiAgICBzdXBlcigpXG4gICAgdGhpcy5uYW1lID0gZmlsZS5uYW1lXG4gIH1cblxuICBhc3luYyBzdGF0cygpIHtcbiAgICByZXR1cm4gdGhpcy5nZXRSZWFsRmlsZSgpXG4gIH1cblxuICBhc3luYyB3cml0ZShmaWxlU3RyaW5nOiBzdHJpbmcpIHtcbiAgICBsZXQgd3JpdGFibGVTdHJlYW06IGFueVxuICAgIGNvbnN0IGxpa2VGaWxlOiBhbnkgPSB0aGlzLmZpbGVcbiAgICBjb25zdCBoYXNQZXJtaXNzaW9uID0gbGlrZUZpbGUucXVlcnlQZXJtaXNzaW9uICYmIGF3YWl0IGxpa2VGaWxlLnF1ZXJ5UGVybWlzc2lvbigpID09PSAnZ3JhbnRlZCdcblxuICAgIGlmICggaGFzUGVybWlzc2lvbiApIHtcbiAgICAgIHdyaXRhYmxlU3RyZWFtID0gYXdhaXQgbGlrZUZpbGUuY3JlYXRlV3JpdGFibGUoKVxuICAgIH0gZWxzZSB7XG4gICAgICAvLyByZXF1ZXN0IHdoZXJlIHRvIHNhdmVcbiAgICAgIGNvbnN0IGlkID0gdGhpcy5uYW1lLnJlcGxhY2UoL1teYS16QS1aMC05XS9nLCctJykrJy1maWxlUGlja2VyJ1xuICAgICAgY29uc3Qgc2F2ZVBpY2tlck9wdGlvbnMgPSB7XG4gICAgICAgIHN1Z2dlc3RlZE5hbWU6IHRoaXMubmFtZSxcbiAgICAgICAgLyp0eXBlczogW3tcbiAgICAgICAgICBkZXNjcmlwdGlvbjogJ0pTT04nLFxuICAgICAgICAgIGFjY2VwdDoge1xuICAgICAgICAgICAgJ2FwcGxpY2F0aW9uL2pzb24nOiBbJy5qc29uJ10sXG4gICAgICAgICAgfSxcbiAgICAgICAgfV0sKi9cbiAgICAgIH1cblxuICAgICAgLy8gYmVsb3csIHRob3VnaHQgdG8gcmVtZW1iZXIgbGFzdCBtYXRjaGluZyBmaWxlIChpIHRoaW5rIGRhdGEgdHlwaW5nIGlzIGp1c3QgbWlzc2luZyBmb3IgaXQpXG4gICAgICA7KHNhdmVQaWNrZXJPcHRpb25zIGFzIGFueSkuaWQgPSBpZC5zbGljZSgwLCAzMilcblxuICAgICAgY29uc3QgaGFuZGxlID0gYXdhaXQgd2luZG93LnNob3dTYXZlRmlsZVBpY2tlcihzYXZlUGlja2VyT3B0aW9ucylcbiAgICAgIFxuICAgICAgd3JpdGFibGVTdHJlYW0gPSBhd2FpdCBoYW5kbGUuY3JlYXRlV3JpdGFibGUoKVxuICAgIH1cblxuXG4gICAgLy8gd3JpdGUgb3VyIGZpbGVcbiAgICBhd2FpdCB3cml0YWJsZVN0cmVhbS53cml0ZSggZmlsZVN0cmluZyApXG5cbiAgICAvLyBjbG9zZSB0aGUgZmlsZSBhbmQgd3JpdGUgdGhlIGNvbnRlbnRzIHRvIGRpc2suXG4gICAgYXdhaXQgd3JpdGFibGVTdHJlYW0uY2xvc2UoKVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBnZXRSZWFsRmlsZSgpOiBQcm9taXNlPEZpbGU+IHtcbiAgICBjb25zdCBmaWxlID0gdGhpcy5maWxlIGFzIGFueVxuICAgIHJldHVybiBmaWxlLmdldEZpbGUgPyBhd2FpdCBmaWxlLmdldEZpbGUoKSA6IFByb21pc2UucmVzb2x2ZShmaWxlKVxuICB9XG4gIFxuICBvdmVycmlkZSByZWFkQXNUZXh0KCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGFzeW5jIChyZXMsIHJlaikgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgdmFyIHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKClcbiAgICAgICAgY29uc3QgZmlsZSA9IGF3YWl0IHRoaXMuZ2V0UmVhbEZpbGUoKVxuICAgICAgICByZWFkZXIucmVhZEFzVGV4dChmaWxlKVxuICAgICAgICByZWFkZXIub25sb2FkID0gKCkgPT4gcmVzKHJlYWRlci5yZXN1bHQgYXMgc3RyaW5nKVxuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHJlaihlcnIpXG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIHJlYWRBc0RhdGFVUkwoKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoYXN5bmMgKHJlcywgcmVqKSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICB2YXIgcmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKVxuICAgICAgICBjb25zdCBmaWxlID0gYXdhaXQgdGhpcy5nZXRSZWFsRmlsZSgpXG4gICAgICAgIHJlYWRlci5yZWFkQXNEYXRhVVJMKGZpbGUpXG4gICAgICAgIHJlYWRlci5vbmxvYWQgPSAoKSA9PiByZXMocmVhZGVyLnJlc3VsdCBhcyBzdHJpbmcpXG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgcmVqKGVycilcbiAgICAgIH1cbiAgICB9KVxuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBCcm93c2VyRGlyZWN0b3J5TWFuYWdlciBpbXBsZW1lbnRzIERpcmVjdG9yeU1hbmFnZXIge1xuICBuYW1lOiBzdHJpbmdcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgcGF0aDogc3RyaW5nLFxuICAgIHB1YmxpYyBmaWxlczogRmlsZVN5c3RlbUZpbGVIYW5kbGVbXSwgLy8gTGlrZUZpbGVbXSxcbiAgICBwdWJsaWMgZGlyZWN0b3J5SGFuZGxlcjogRmlsZVN5c3RlbURpcmVjdG9yeUhhbmRsZSxcbiAgKSB7XG4gICAgdGhpcy5uYW1lID0gZ2V0TmFtZUJ5UGF0aChwYXRoKVxuICB9XG5cbiAgZmluZERpcmVjdG9yeSAoXG4gICAgcGF0aDogc3RyaW5nLFxuICAgIG9wdGlvbnM/OiBGaWxlU3lzdGVtR2V0RGlyZWN0b3J5T3B0aW9ucyxcbiAgKTogUHJvbWlzZTxEaXJlY3RvcnlNYW5hZ2VyIHwgdW5kZWZpbmVkPiB7XG4gICAgcmV0dXJuIGZpbmREaXJlY3RvcnlXaXRoaW4ocGF0aCwgdGhpcywgb3B0aW9ucylcbiAgfVxuICBcbiAgYXN5bmMgbGlzdCgpOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gICAgY29uc3QgZmlsZXMgPSBhd2FpdCBkaXJlY3RvcnlSZWFkVG9BcnJheSh0aGlzLmRpcmVjdG9yeUhhbmRsZXIpXG4gICAgcmV0dXJuIGZpbGVzLm1hcChmaWxlID0+IGZpbGUubmFtZSlcbiAgfVxuICBcbiAgYXN5bmMgbGlzdEZvbGRlcnMoKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIGNvbnN0IGl0ZW1zID0gYXdhaXQgZGlyZWN0b3J5UmVhZFRvQXJyYXkodGhpcy5kaXJlY3RvcnlIYW5kbGVyKVxuICAgIHJldHVybiBpdGVtcy5maWx0ZXIoKGZpbGU6IGFueSkgPT4gZmlsZS5raW5kICYmIChmaWxlIGFzIGFueSkua2luZCA9PT0gJ2RpcmVjdG9yeScpXG4gICAgICAubWFwKGZpbGUgPT4gZmlsZS5uYW1lKVxuICB9XG4gIFxuICBhc3luYyBsaXN0RmlsZXMoKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIGNvbnN0IGl0ZW1zID0gYXdhaXQgdGhpcy5saXN0KCkgYXMgYW55XG4gICAgcmV0dXJuIGl0ZW1zLmZpbHRlcigoZmlsZTogYW55KSA9PiBmaWxlLmtpbmQgPT09ICdmaWxlJylcbiAgICAgIC5tYXAoKGZpbGU6IGFueSkgPT4gZmlsZS5uYW1lKVxuICB9XG4gIFxuICBhc3luYyBnZXRGb2xkZXJzKCk6IFByb21pc2U8QnJvd3NlckRpcmVjdG9yeU1hbmFnZXJbXT4ge1xuICAgIGNvbnN0IG5hbWVzID0gYXdhaXQgdGhpcy5saXN0Rm9sZGVycygpXG4gICAgcmV0dXJuIFByb21pc2UuYWxsKFxuICAgICAgbmFtZXMubWFwKGFzeW5jIG5hbWUgPT4gYXdhaXQgdGhpcy5nZXREaXJlY3RvcnkobmFtZSkpXG4gICAgKVxuICB9XG4gIFxuICBhc3luYyBnZXRGaWxlcygpOiBQcm9taXNlPERtRmlsZVJlYWRlcltdPiB7XG4gICAgY29uc3QgZmlsZXMgPSBhd2FpdCBkaXJlY3RvcnlSZWFkVG9BcnJheSh0aGlzLmRpcmVjdG9yeUhhbmRsZXIpXG4gICAgcmV0dXJuIGZpbGVzLmZpbHRlcihmaWxlID0+IGZpbGUua2luZCA9PT0gJ2ZpbGUnKVxuICAgICAgLm1hcChmaWxlID0+IG5ldyBCcm93c2VyRG1GaWxlUmVhZGVyKGZpbGUsIHRoaXMpKVxuICB9XG5cbiAgY3JlYXRlRGlyZWN0b3J5KG5ld1BhdGg6IHN0cmluZykge1xuICAgIHJldHVybiB0aGlzLmdldERpcmVjdG9yeShuZXdQYXRoLCB7IGNyZWF0ZTogdHJ1ZSB9KVxuICB9XG5cbiAgYXN5bmMgZ2V0RGlyZWN0b3J5KFxuICAgIG5ld1BhdGg6IHN0cmluZyxcbiAgICBvcHRpb25zPzogRmlsZVN5c3RlbUdldERpcmVjdG9yeU9wdGlvbnNcbiAgKTogUHJvbWlzZTxCcm93c2VyRGlyZWN0b3J5TWFuYWdlcj4ge1xuICAgIGlmICggIW5ld1BhdGggKSB7XG4gICAgICByZXR1cm4gdGhpc1xuICAgIH1cblxuICAgIGNvbnN0IG5ld1BhdGhBcnJheSA9IG5ld1BhdGguc3BsaXQoJy8nKVxuICAgIGxldCBmdWxsTmV3UGF0aCA9IHRoaXMucGF0aFxuICAgIGxldCBkaXI6IEZpbGVTeXN0ZW1EaXJlY3RvcnlIYW5kbGVcblxuICAgIHRyeSB7XG4gICAgICAvLyB0cmF2ZXJzZSB0aHJvdWdoIGVhY2ggZm9sZGVyXG4gICAgICBkaXIgID0gYXdhaXQgbmV3UGF0aEFycmF5LnJlZHVjZShhc3luYyAobGFzdCxjdXJyZW50KSA9PiB7XG4gICAgICAgIGNvbnN0IG5leHQ6IEZpbGVTeXN0ZW1EaXJlY3RvcnlIYW5kbGUgPSBhd2FpdCBsYXN0XG4gICAgICAgIGNvbnN0IG5ld0hhbmRsZSA9IG5leHQuZ2V0RGlyZWN0b3J5SGFuZGxlKGN1cnJlbnQsIG9wdGlvbnMpXG4gICAgICAgIGNvbnN0IG5hbWUgPSAoYXdhaXQgbmV3SGFuZGxlKS5uYW1lXG4gICAgICAgIGZ1bGxOZXdQYXRoID0gcGF0aC5qb2luKGZ1bGxOZXdQYXRoLCBuYW1lKVxuICAgICAgICByZXR1cm4gbmV3SGFuZGxlXG4gICAgICB9LCBQcm9taXNlLnJlc29sdmUodGhpcy5kaXJlY3RvcnlIYW5kbGVyKSlcbiAgICB9IGNhdGNoIChlcnI6IGFueSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGVyci5tZXNzYWdlICsgYC4gJHtuZXdQYXRofSBub3QgZm91bmQgaW4gJHt0aGlzLm5hbWV9ICgke3RoaXMucGF0aH0pYClcbiAgICB9XG5cbiAgICBjb25zdCBmaWxlczogRmlsZVN5c3RlbUZpbGVIYW5kbGVbXSA9IGF3YWl0IGRpcmVjdG9yeVJlYWRUb0FycmF5KGRpcilcbiAgICBjb25zdCBuZXdEaXIgPSBuZXcgQnJvd3NlckRpcmVjdG9yeU1hbmFnZXIoXG4gICAgICBmdWxsTmV3UGF0aCxcbiAgICAgIGZpbGVzLFxuICAgICAgZGlyXG4gICAgKVxuICAgIHJldHVybiBuZXdEaXJcbiAgfVxuXG4gIGFzeW5jIHJlbW92ZUVudHJ5KFxuICAgIG5hbWU6IHN0cmluZyxcbiAgICBvcHRpb25zPzogeyByZWN1cnNpdmU6IGJvb2xlYW4gfVxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBzcGxpdCA9IG5hbWUuc3BsaXQoJy8nKVxuICAgIGNvbnN0IGxhc3ROYW1lID0gc3BsaXQucG9wKCkgYXMgc3RyaW5nIC8vIHJlbW92ZSBsYXN0IGl0ZW1cbiAgICBjb25zdCBkaXIgPSBzcGxpdC5sZW5ndGggPj0gMSA/IGF3YWl0IHRoaXMuZ2V0RGlyZWN0b3J5KCBzcGxpdC5qb2luKCcvJykgKSA6IHRoaXNcbiAgICByZXR1cm4gZGlyLmRpcmVjdG9yeUhhbmRsZXIucmVtb3ZlRW50cnkobGFzdE5hbWUsIG9wdGlvbnMpXG4gIH1cblxuICBhc3luYyByZW5hbWVGaWxlKFxuICAgIG9sZEZpbGVOYW1lOiBzdHJpbmcsXG4gICAgbmV3RmlsZU5hbWU6IHN0cmluZ1xuICApIHtcbiAgICByZXR1cm4gcmVuYW1lRmlsZUluRGlyKG9sZEZpbGVOYW1lLCBuZXdGaWxlTmFtZSwgdGhpcylcbiAgfVxuXG4gIGFzeW5jIGZpbGUocGF0aDogc3RyaW5nLCBvcHRpb25zPzogRmlsZVN5c3RlbUdldEZpbGVPcHRpb25zKSB7XG4gICAgY29uc3QgZmluZEZpbGUgPSBhd2FpdCB0aGlzLmZpbmRGaWxlQnlQYXRoKHBhdGgpXG4gICAgaWYgKCBmaW5kRmlsZSApIHtcbiAgICAgIHJldHVybiBmaW5kRmlsZVxuICAgIH1cblxuICAgIGNvbnN0IGRpciA9IGF3YWl0IHRoaXMuZ2V0RGlyRm9yRmlsZVBhdGgocGF0aCkgYXMgQnJvd3NlckRpcmVjdG9yeU1hbmFnZXJcbiAgICBjb25zdCBmaWxlTmFtZSA9IHBhdGguc3BsaXQoJy8nKS5wb3AoKSBhcyBzdHJpbmdcblxuICAgIGNvbnN0IGZpbGVIYW5kbGUgPSBhd2FpdCBkaXIuZGlyZWN0b3J5SGFuZGxlci5nZXRGaWxlSGFuZGxlKGZpbGVOYW1lLCBvcHRpb25zKVxuICAgIHJldHVybiBuZXcgQnJvd3NlckRtRmlsZVJlYWRlcihmaWxlSGFuZGxlLCB0aGlzKVxuICB9XG5cbiAgYXN5bmMgZmluZEZpbGVCeVBhdGgoXG4gICAgcGF0aDogc3RyaW5nLFxuICAgIGRpcmVjdG9yeUhhbmRsZXI6IGFueSA9IHRoaXMuZGlyZWN0b3J5SGFuZGxlcixcbiAgKTogUHJvbWlzZTxCcm93c2VyRG1GaWxlUmVhZGVyIHwgdW5kZWZpbmVkPiB7XG4gICAgY29uc3QgcGF0aFNwbGl0ID0gcGF0aC5zcGxpdCgnLycpXG4gICAgY29uc3QgZmlsZU5hbWUgPSBwYXRoU3BsaXQucG9wKCkgLy8gcGF0aFNwbGl0WyBwYXRoU3BsaXQubGVuZ3RoLTEgXVxuXG4gICAgLy8gY2hyb21lIHdlIGRpZyB0aHJvdWdoIHRoZSBmaXJzdCBzZWxlY3RlZCBkaXJlY3RvcnkgYW5kIHNlYXJjaCB0aGUgc3Vic1xuICAgIGlmICggcGF0aFNwbGl0Lmxlbmd0aCApIHtcbiAgICAgIGNvbnN0IGRpciA9IGF3YWl0IHRoaXMuZ2V0RGlyZWN0b3J5KCBwYXRoU3BsaXQuam9pbignLycpIClcbiAgICAgIGRpcmVjdG9yeUhhbmRsZXIgPSBkaXIuZGlyZWN0b3J5SGFuZGxlclxuICAgIH1cbiAgICBcbiAgICBsZXQgZmlsZXMgPSB0aGlzLmZpbGVzXG4gICAgZmlsZXMgPSBhd2FpdCBkaXJlY3RvcnlSZWFkVG9BcnJheShkaXJlY3RvcnlIYW5kbGVyKVxuICAgIGNvbnN0IGxpa2VGaWxlID0gZmlsZXMuZmluZChmaWxlID0+IGZpbGUubmFtZSA9PT0gZmlsZU5hbWUpXG4gICAgaWYgKCAhbGlrZUZpbGUgKSB7XG4gICAgICByZXR1cm5cbiAgICB9XG4gICAgXG4gICAgLy8gd2hlbiBmb3VuZCwgY29udmVydCB0byBGaWxlXG4gICAgLy8gY29uc3QgZmlsZSA9IGF3YWl0IHRoaXMuZ2V0U3lzdGVtRmlsZShsaWtlRmlsZSlcbiAgICByZXR1cm4gbmV3IEJyb3dzZXJEbUZpbGVSZWFkZXIobGlrZUZpbGUsIHRoaXMpXG4gIH1cbiAgXG4gIGFzeW5jIGdldERpckZvckZpbGVQYXRoKHBhdGg6IHN0cmluZykge1xuICAgIGNvbnN0IHBhdGhTcGxpdCA9IHBhdGguc3BsaXQoJy8nKVxuICAgIHBhdGhTcGxpdC5wb3AoKSBhcyBzdHJpbmcgLy8gcGF0aFNwbGl0WyBwYXRoU3BsaXQubGVuZ3RoLTEgXVxuICBcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5nZXREaXJlY3RvcnkoIHBhdGhTcGxpdC5qb2luKCcvJykgKVxuICB9XG59XG5cbiJdfQ==