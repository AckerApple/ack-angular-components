import { BaseDmFileReader } from "./DirectoryManagers";
import { directoryReadToArray } from "./directoryReadToArray.function";
import { path } from "./path";
export class BrowserDmFileReader extends BaseDmFileReader {
    constructor(file, directory) {
        super();
        this.file = file;
        this.directory = directory;
        this.name = file.name;
    }
    async stats() {
        return this.getRealFile();
    }
    async write(fileString) {
        let writableStream;
        const likeFile = this.file;
        const hasPermission = likeFile.queryPermission && await likeFile.queryPermission() === 'granted';
        if (hasPermission) {
            writableStream = await likeFile.createWritable();
        }
        else {
            // request where to save
            const id = this.name.replace(/[^a-zA-Z0-9]/g, '-') + '-filePicker';
            const savePickerOptions = {
                suggestedName: this.name,
                /*types: [{
                  description: 'JSON',
                  accept: {
                    'application/json': ['.json'],
                  },
                }],*/
            };
            savePickerOptions.id = id.slice(0, 32);
            const handle = await window.showSaveFilePicker(savePickerOptions);
            writableStream = await handle.createWritable();
        }
        // write our file
        await writableStream.write(fileString);
        // close the file and write the contents to disk.
        await writableStream.close();
    }
    async getRealFile() {
        const file = this.file;
        return file.getFile ? await file.getFile() : Promise.resolve(file);
    }
    readAsText() {
        return new Promise(async (res, rej) => {
            try {
                var reader = new FileReader();
                const file = await this.getRealFile();
                reader.readAsText(file);
                reader.onload = () => res(reader.result);
            }
            catch (err) {
                rej(err);
            }
        });
    }
    readAsDataURL() {
        return new Promise(async (res, rej) => {
            try {
                var reader = new FileReader();
                const file = await this.getRealFile();
                reader.readAsDataURL(file);
                reader.onload = () => res(reader.result);
            }
            catch (err) {
                rej(err);
            }
        });
    }
}
export class BrowserDirectoryManager {
    constructor(path, files, // LikeFile[],
    directoryHandler) {
        this.path = path;
        this.files = files;
        this.directoryHandler = directoryHandler;
        this.name = getNameByPath(path);
    }
    async list() {
        return this.files.map(file => file.name);
    }
    async listFolders() {
        return this.files.filter(file => file.kind && file.kind === 'directory')
            .map(file => file.name);
    }
    async listFiles() {
        return this.files.filter(file => file.kind === 'file')
            .map(file => file.name);
    }
    async getFolders() {
        return Promise.all(this.files.filter(file => file.kind && file.kind === 'directory')
            .map(async (file) => await this.getDirectory(file.name)));
    }
    async getFiles() {
        return this.files.filter(file => file.kind === 'file')
            .map(file => new BrowserDmFileReader(file, this));
    }
    async getDirectory(newPath, options) {
        const newPathArray = newPath.split('/');
        let fullNewPath = this.path;
        let dir;
        try {
            // traverse through each folder
            dir = await newPathArray.reduce(async (last, current) => {
                const next = await last;
                const newHandle = next.getDirectoryHandle(current, options);
                const name = (await newHandle).name;
                fullNewPath = path.join(fullNewPath, name);
                return newHandle;
            }, Promise.resolve(this.directoryHandler));
        }
        catch (err) {
            throw new Error(err.message + `. ${newPath} not found in ${this.path}`);
        }
        const files = await directoryReadToArray(dir);
        const newDir = new BrowserDirectoryManager(fullNewPath, files, dir);
        return newDir;
    }
    async file(fileName, options) {
        const findFile = await this.findFileByPath(fileName);
        if (findFile) {
            return findFile;
        }
        const fileHandle = await this.directoryHandler.getFileHandle(fileName, options);
        return new BrowserDmFileReader(fileHandle, this);
    }
    async findFileByPath(path, directoryHandler = this.directoryHandler) {
        const pathSplit = path.split('/');
        const fileName = pathSplit[pathSplit.length - 1];
        if (!this.files.length) {
            return;
        }
        // chrome we dig through the first selected directory and search the subs
        if (pathSplit.length > 1) {
            const lastParent = pathSplit.shift(); // remove index 0 of lastParent/firstParent/file.xyz
            const newHandler = await directoryHandler.getDirectoryHandle(lastParent);
            if (!newHandler) {
                console.debug('no matching upper folder', lastParent, directoryHandler);
                return;
            }
            const newPath = pathSplit.join('/');
            const dirMan = await this.getDirectory(lastParent);
            return dirMan.findFileByPath(newPath, newHandler);
        }
        let files = this.files;
        if (directoryHandler) {
            files = await directoryReadToArray(directoryHandler);
        }
        const likeFile = files.find(file => file.name === fileName);
        if (!likeFile) {
            return;
        }
        // when found, convert to File
        // const file = await this.getSystemFile(likeFile)
        return new BrowserDmFileReader(likeFile, this);
    }
}
export function getNameByPath(path) {
    const half = path.split(/\//).pop();
    return half.split(/\\/).pop();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQnJvd3NlckRpcmVjdG9yeU1hbmFnZXJzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2RpcmVjdG9yeS1tYW5hZ2Vycy9Ccm93c2VyRGlyZWN0b3J5TWFuYWdlcnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGdCQUFnQixFQUFrQyxNQUFNLHFCQUFxQixDQUFBO0FBQ3RGLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLGlDQUFpQyxDQUFBO0FBQ3RFLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxRQUFRLENBQUE7QUFFN0IsTUFBTSxPQUFPLG1CQUFvQixTQUFRLGdCQUFnQjtJQUd2RCxZQUNTLElBQWlDLEVBQ2pDLFNBQTJCO1FBRWxDLEtBQUssRUFBRSxDQUFBO1FBSEEsU0FBSSxHQUFKLElBQUksQ0FBNkI7UUFDakMsY0FBUyxHQUFULFNBQVMsQ0FBa0I7UUFHbEMsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFBO0lBQ3ZCLENBQUM7SUFFRCxLQUFLLENBQUMsS0FBSztRQUNULE9BQU8sSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFBO0lBQzNCLENBQUM7SUFFRCxLQUFLLENBQUMsS0FBSyxDQUFDLFVBQWtCO1FBQzVCLElBQUksY0FBbUIsQ0FBQTtRQUN2QixNQUFNLFFBQVEsR0FBUSxJQUFJLENBQUMsSUFBSSxDQUFBO1FBQy9CLE1BQU0sYUFBYSxHQUFHLFFBQVEsQ0FBQyxlQUFlLElBQUksTUFBTSxRQUFRLENBQUMsZUFBZSxFQUFFLEtBQUssU0FBUyxDQUFBO1FBRWhHLElBQUssYUFBYSxFQUFHO1lBQ25CLGNBQWMsR0FBRyxNQUFNLFFBQVEsQ0FBQyxjQUFjLEVBQUUsQ0FBQTtTQUNqRDthQUFNO1lBQ0wsd0JBQXdCO1lBQ3hCLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLGVBQWUsRUFBQyxHQUFHLENBQUMsR0FBQyxhQUFh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b0IsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFBO1NBQ3JEO1FBRUQsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLEtBQUssUUFBUSxDQUFDLENBQUE7UUFDM0QsSUFBSyxDQUFDLFFBQVEsRUFBRztZQUNmLE9BQU07U0FDUDtRQUVELDhCQUE4QjtRQUM5QixrREFBa0Q7UUFFbEQsT0FBTyxJQUFJLG1CQUFtQixDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQTtJQUNoRCxDQUFDO0NBQ0Y7QUFHRCxNQUFNLFVBQVUsYUFBYSxDQUFDLElBQVk7SUFDeEMsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLEVBQVksQ0FBQTtJQUM3QyxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxFQUFZLENBQUE7QUFDekMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJhc2VEbUZpbGVSZWFkZXIsIERpcmVjdG9yeU1hbmFnZXIsIERtRmlsZVJlYWRlciB9IGZyb20gXCIuL0RpcmVjdG9yeU1hbmFnZXJzXCJcbmltcG9ydCB7IGRpcmVjdG9yeVJlYWRUb0FycmF5IH0gZnJvbSBcIi4vZGlyZWN0b3J5UmVhZFRvQXJyYXkuZnVuY3Rpb25cIlxuaW1wb3J0IHsgcGF0aCB9IGZyb20gXCIuL3BhdGhcIlxuXG5leHBvcnQgY2xhc3MgQnJvd3NlckRtRmlsZVJlYWRlciBleHRlbmRzIEJhc2VEbUZpbGVSZWFkZXIgaW1wbGVtZW50cyBEbUZpbGVSZWFkZXIge1xuICBuYW1lOiBzdHJpbmdcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgZmlsZTogRmlsZSB8IEZpbGVTeXN0ZW1GaWxlSGFuZGxlLFxuICAgIHB1YmxpYyBkaXJlY3Rvcnk6IERpcmVjdG9yeU1hbmFnZXJcbiAgKSB7XG4gICAgc3VwZXIoKVxuICAgIHRoaXMubmFtZSA9IGZpbGUubmFtZVxuICB9XG5cbiAgYXN5bmMgc3RhdHMoKSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0UmVhbEZpbGUoKVxuICB9XG5cbiAgYXN5bmMgd3JpdGUoZmlsZVN0cmluZzogc3RyaW5nKSB7XG4gICAgbGV0IHdyaXRhYmxlU3RyZWFtOiBhbnlcbiAgICBjb25zdCBsaWtlRmlsZTogYW55ID0gdGhpcy5maWxlXG4gICAgY29uc3QgaGFzUGVybWlzc2lvbiA9IGxpa2VGaWxlLnF1ZXJ5UGVybWlzc2lvbiAmJiBhd2FpdCBsaWtlRmlsZS5xdWVyeVBlcm1pc3Npb24oKSA9PT0gJ2dyYW50ZWQnXG5cbiAgICBpZiAoIGhhc1Blcm1pc3Npb24gKSB7XG4gICAgICB3cml0YWJsZVN0cmVhbSA9IGF3YWl0IGxpa2VGaWxlLmNyZWF0ZVdyaXRhYmxlKClcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gcmVxdWVzdCB3aGVyZSB0byBzYXZlXG4gICAgICBjb25zdCBpZCA9IHRoaXMubmFtZS5yZXBsYWNlKC9bXmEtekEtWjAtOV0vZywnLScpKyctZmlsZVBpY2tlcidcbiAgICAgIGNvbnN0IHNhdmVQaWNrZXJPcHRpb25zID0ge1xuICAgICAgICBzdWdnZXN0ZWROYW1lOiB0aGlzLm5hbWUsXG4gICAgICAgIC8qdHlwZXM6IFt7XG4gICAgICAgICAgZGVzY3JpcHRpb246ICdKU09OJyxcbiAgICAgICAgICBhY2NlcHQ6IHtcbiAgICAgICAgICAgICdhcHBsaWNhdGlvbi9qc29uJzogWycuanNvbiddLFxuICAgICAgICAgIH0sXG4gICAgICAgIH1dLCovXG4gICAgICB9XG5cbiAgICAgIC8vIGJlbG93LCB0aG91Z2h0IHRvIHJlbWVtYmVyIGxhc3QgbWF0Y2hpbmcgZmlsZSAoaSB0aGluayBkYXRhIHR5cGluZyBpcyBqdXN0IG1pc3NpbmcgZm9yIGl0KVxuICAgICAgOyhzYXZlUGlja2VyT3B0aW9ucyBhcyBhbnkpLmlkID0gaWQuc2xpY2UoMCwgMzIpXG5cbiAgICAgIGNvbnN0IGhhbmRsZSA9IGF3YWl0IHdpbmRvdy5zaG93U2F2ZUZpbGVQaWNrZXIoc2F2ZVBpY2tlck9wdGlvbnMpXG4gICAgICBcbiAgICAgIHdyaXRhYmxlU3RyZWFtID0gYXdhaXQgaGFuZGxlLmNyZWF0ZVdyaXRhYmxlKClcbiAgICB9XG5cblxuICAgIC8vIHdyaXRlIG91ciBmaWxlXG4gICAgYXdhaXQgd3JpdGFibGVTdHJlYW0ud3JpdGUoIGZpbGVTdHJpbmcgKVxuXG4gICAgLy8gY2xvc2UgdGhlIGZpbGUgYW5kIHdyaXRlIHRoZSBjb250ZW50cyB0byBkaXNrLlxuICAgIGF3YWl0IHdyaXRhYmxlU3RyZWFtLmNsb3NlKClcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZ2V0UmVhbEZpbGUoKTogUHJvbWlzZTxGaWxlPiB7XG4gICAgY29uc3QgZmlsZSA9IHRoaXMuZmlsZSBhcyBhbnlcbiAgICByZXR1cm4gZmlsZS5nZXRGaWxlID8gYXdhaXQgZmlsZS5nZXRGaWxlKCkgOiBQcm9taXNlLnJlc29sdmUoZmlsZSlcbiAgfVxuICBcbiAgb3ZlcnJpZGUgcmVhZEFzVGV4dCgpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZShhc3luYyAocmVzLCByZWopID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIHZhciByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpXG4gICAgICAgIGNvbnN0IGZpbGUgPSBhd2FpdCB0aGlzLmdldFJlYWxGaWxlKClcbiAgICAgICAgcmVhZGVyLnJlYWRBc1RleHQoZmlsZSlcbiAgICAgICAgcmVhZGVyLm9ubG9hZCA9ICgpID0+IHJlcyhyZWFkZXIucmVzdWx0IGFzIHN0cmluZylcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICByZWooZXJyKVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICByZWFkQXNEYXRhVVJMKCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGFzeW5jIChyZXMsIHJlaikgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgdmFyIHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKClcbiAgICAgICAgY29uc3QgZmlsZSA9IGF3YWl0IHRoaXMuZ2V0UmVhbEZpbGUoKVxuICAgICAgICByZWFkZXIucmVhZEFzRGF0YVVSTChmaWxlKVxuICAgICAgICByZWFkZXIub25sb2FkID0gKCkgPT4gcmVzKHJlYWRlci5yZXN1bHQgYXMgc3RyaW5nKVxuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHJlaihlcnIpXG4gICAgICB9XG4gICAgfSlcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgQnJvd3NlckRpcmVjdG9yeU1hbmFnZXIgaW1wbGVtZW50cyBEaXJlY3RvcnlNYW5hZ2VyIHtcbiAgbmFtZTogc3RyaW5nXG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHVibGljIHBhdGg6IHN0cmluZyxcbiAgICBwdWJsaWMgZmlsZXM6IEZpbGVTeXN0ZW1GaWxlSGFuZGxlW10sIC8vIExpa2VGaWxlW10sXG4gICAgcHVibGljIGRpcmVjdG9yeUhhbmRsZXI6IEZpbGVTeXN0ZW1EaXJlY3RvcnlIYW5kbGUsXG4gICkge1xuICAgIHRoaXMubmFtZSA9IGdldE5hbWVCeVBhdGgocGF0aClcbiAgfVxuXG4gIGFzeW5jIGxpc3QoKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIHJldHVybiB0aGlzLmZpbGVzLm1hcChmaWxlID0+IGZpbGUubmFtZSlcbiAgfVxuICBcbiAgYXN5bmMgbGlzdEZvbGRlcnMoKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIHJldHVybiB0aGlzLmZpbGVzLmZpbHRlcihmaWxlID0+IGZpbGUua2luZCAmJiAoZmlsZSBhcyBhbnkpLmtpbmQgPT09ICdkaXJlY3RvcnknKVxuICAgICAgLm1hcChmaWxlID0+IGZpbGUubmFtZSlcbiAgfVxuICBcbiAgYXN5bmMgbGlzdEZpbGVzKCk6IFByb21pc2U8c3RyaW5nW10+IHtcbiAgICByZXR1cm4gdGhpcy5maWxlcy5maWx0ZXIoZmlsZSA9PiBmaWxlLmtpbmQgPT09ICdmaWxlJylcbiAgICAgIC5tYXAoZmlsZSA9PiBmaWxlLm5hbWUpXG4gIH1cbiAgXG4gIGFzeW5jIGdldEZvbGRlcnMoKTogUHJvbWlzZTxCcm93c2VyRGlyZWN0b3J5TWFuYWdlcltdPiB7XG4gICAgcmV0dXJuIFByb21pc2UuYWxsKFxuICAgICAgdGhpcy5maWxlcy5maWx0ZXIoZmlsZSA9PiBmaWxlLmtpbmQgJiYgKGZpbGUgYXMgYW55KS5raW5kID09PSAnZGlyZWN0b3J5JylcbiAgICAgICAgLm1hcChhc3luYyBmaWxlID0+IGF3YWl0IHRoaXMuZ2V0RGlyZWN0b3J5KGZpbGUubmFtZSkpXG4gICAgKVxuICB9XG4gIFxuICBhc3luYyBnZXRGaWxlcygpOiBQcm9taXNlPERtRmlsZVJlYWRlcltdPiB7XG4gICAgcmV0dXJuIHRoaXMuZmlsZXMuZmlsdGVyKGZpbGUgPT4gZmlsZS5raW5kID09PSAnZmlsZScpXG4gICAgICAubWFwKGZpbGUgPT4gbmV3IEJyb3dzZXJEbUZpbGVSZWFkZXIoZmlsZSwgdGhpcykpXG4gIH1cblxuICBhc3luYyBnZXREaXJlY3RvcnkoXG4gICAgbmV3UGF0aDogc3RyaW5nLFxuICAgIG9wdGlvbnM/OiBGaWxlU3lzdGVtR2V0RGlyZWN0b3J5T3B0aW9uc1xuICApIHtcbiAgICBjb25zdCBuZXdQYXRoQXJyYXkgPSBuZXdQYXRoLnNwbGl0KCcvJylcbiAgICBsZXQgZnVsbE5ld1BhdGggPSB0aGlzLnBhdGhcbiAgICBsZXQgZGlyOiBGaWxlU3lzdGVtRGlyZWN0b3J5SGFuZGxlXG5cbiAgICB0cnkge1xuICAgICAgLy8gdHJhdmVyc2UgdGhyb3VnaCBlYWNoIGZvbGRlclxuICAgICAgZGlyICA9IGF3YWl0IG5ld1BhdGhBcnJheS5yZWR1Y2UoYXN5bmMgKGxhc3QsY3VycmVudCkgPT4ge1xuICAgICAgICBjb25zdCBuZXh0OiBGaWxlU3lzdGVtRGlyZWN0b3J5SGFuZGxlID0gYXdhaXQgbGFzdFxuICAgICAgICBjb25zdCBuZXdIYW5kbGUgPSBuZXh0LmdldERpcmVjdG9yeUhhbmRsZShjdXJyZW50LCBvcHRpb25zKVxuICAgICAgICBjb25zdCBuYW1lID0gKGF3YWl0IG5ld0hhbmRsZSkubmFtZVxuICAgICAgICBmdWxsTmV3UGF0aCA9IHBhdGguam9pbihmdWxsTmV3UGF0aCwgbmFtZSlcbiAgICAgICAgcmV0dXJuIG5ld0hhbmRsZVxuICAgICAgfSwgUHJvbWlzZS5yZXNvbHZlKHRoaXMuZGlyZWN0b3J5SGFuZGxlcikpXG4gICAgfSBjYXRjaCAoZXJyOiBhbnkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihlcnIubWVzc2FnZSArIGAuICR7bmV3UGF0aH0gbm90IGZvdW5kIGluICR7dGhpcy5wYXRofWApXG4gICAgfVxuXG4gICAgY29uc3QgZmlsZXM6IEZpbGVTeXN0ZW1GaWxlSGFuZGxlW10gPSBhd2FpdCBkaXJlY3RvcnlSZWFkVG9BcnJheShkaXIpXG4gICAgY29uc3QgbmV3RGlyID0gbmV3IEJyb3dzZXJEaXJlY3RvcnlNYW5hZ2VyKFxuICAgICAgZnVsbE5ld1BhdGgsXG4gICAgICBmaWxlcyxcbiAgICAgIGRpclxuICAgIClcbiAgICByZXR1cm4gbmV3RGlyXG4gIH1cblxuICBhc3luYyBmaWxlKGZpbGVOYW1lOiBzdHJpbmcsIG9wdGlvbnM/OiBGaWxlU3lzdGVtR2V0RmlsZU9wdGlvbnMpIHtcbiAgICBjb25zdCBmaW5kRmlsZSA9IGF3YWl0IHRoaXMuZmluZEZpbGVCeVBhdGgoZmlsZU5hbWUpXG5cbiAgICBpZiAoIGZpbmRGaWxlICkge1xuICAgICAgcmV0dXJuIGZpbmRGaWxlXG4gICAgfVxuXG4gICAgY29uc3QgZmlsZUhhbmRsZSA9IGF3YWl0IHRoaXMuZGlyZWN0b3J5SGFuZGxlci5nZXRGaWxlSGFuZGxlKGZpbGVOYW1lLCBvcHRpb25zKVxuICAgIHJldHVybiBuZXcgQnJvd3NlckRtRmlsZVJlYWRlcihmaWxlSGFuZGxlLCB0aGlzKVxuICB9XG5cbiAgYXN5bmMgZmluZEZpbGVCeVBhdGgoXG4gICAgcGF0aDogc3RyaW5nLFxuICAgIGRpcmVjdG9yeUhhbmRsZXI6IGFueSA9IHRoaXMuZGlyZWN0b3J5SGFuZGxlcixcbiAgKTogUHJvbWlzZTxCcm93c2VyRG1GaWxlUmVhZGVyIHwgdW5kZWZpbmVkPiB7XG4gICAgY29uc3QgcGF0aFNwbGl0ID0gcGF0aC5zcGxpdCgnLycpXG4gICAgY29uc3QgZmlsZU5hbWUgPSBwYXRoU3BsaXRbIHBhdGhTcGxpdC5sZW5ndGgtMSBdXG4gICAgaWYgKCAhdGhpcy5maWxlcy5sZW5ndGggKSB7XG4gICAgICByZXR1cm5cbiAgICB9XG5cbiAgICAvLyBjaHJvbWUgd2UgZGlnIHRocm91Z2ggdGhlIGZpcnN0IHNlbGVjdGVkIGRpcmVjdG9yeSBhbmQgc2VhcmNoIHRoZSBzdWJzXG4gICAgaWYgKCBwYXRoU3BsaXQubGVuZ3RoID4gMSApIHtcbiAgICAgIGNvbnN0IGxhc3RQYXJlbnQgPSBwYXRoU3BsaXQuc2hpZnQoKSBhcyBzdHJpbmcgLy8gcmVtb3ZlIGluZGV4IDAgb2YgbGFzdFBhcmVudC9maXJzdFBhcmVudC9maWxlLnh5elxuICAgICAgY29uc3QgbmV3SGFuZGxlciA9IGF3YWl0IGRpcmVjdG9yeUhhbmRsZXIuZ2V0RGlyZWN0b3J5SGFuZGxlKCBsYXN0UGFyZW50IClcbiAgICAgIFxuICAgICAgaWYgKCAhbmV3SGFuZGxlciApIHtcbiAgICAgICAgY29uc29sZS5kZWJ1Zygnbm8gbWF0Y2hpbmcgdXBwZXIgZm9sZGVyJywgbGFzdFBhcmVudCwgZGlyZWN0b3J5SGFuZGxlcilcbiAgICAgICAgcmV0dXJuXG4gICAgICB9XG5cbiAgICAgIGNvbnN0IG5ld1BhdGggPSBwYXRoU3BsaXQuam9pbignLycpXG4gICAgICBjb25zdCBkaXJNYW4gPSBhd2FpdCB0aGlzLmdldERpcmVjdG9yeShsYXN0UGFyZW50KVxuICAgICAgXG4gICAgICByZXR1cm4gZGlyTWFuLmZpbmRGaWxlQnlQYXRoKG5ld1BhdGgsIG5ld0hhbmRsZXIpXG4gICAgfVxuICAgIFxuICAgIGxldCBmaWxlcyA9IHRoaXMuZmlsZXNcbiAgICBpZiAoIGRpcmVjdG9yeUhhbmRsZXIgKSB7XG4gICAgICBmaWxlcyA9IGF3YWl0IGRpcmVjdG9yeVJlYWRUb0FycmF5KGRpcmVjdG9yeUhhbmRsZXIpXG4gICAgfVxuICAgIFxuICAgIGNvbnN0IGxpa2VGaWxlID0gZmlsZXMuZmluZChmaWxlID0+IGZpbGUubmFtZSA9PT0gZmlsZU5hbWUpXG4gICAgaWYgKCAhbGlrZUZpbGUgKSB7XG4gICAgICByZXR1cm5cbiAgICB9XG4gICAgXG4gICAgLy8gd2hlbiBmb3VuZCwgY29udmVydCB0byBGaWxlXG4gICAgLy8gY29uc3QgZmlsZSA9IGF3YWl0IHRoaXMuZ2V0U3lzdGVtRmlsZShsaWtlRmlsZSlcbiAgICBcbiAgICByZXR1cm4gbmV3IEJyb3dzZXJEbUZpbGVSZWFkZXIobGlrZUZpbGUsIHRoaXMpXG4gIH1cbn1cblxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0TmFtZUJ5UGF0aChwYXRoOiBzdHJpbmcpIHtcbiAgY29uc3QgaGFsZiA9IHBhdGguc3BsaXQoL1xcLy8pLnBvcCgpIGFzIHN0cmluZ1xuICByZXR1cm4gaGFsZi5zcGxpdCgvXFxcXC8pLnBvcCgpIGFzIHN0cmluZ1xufSJdfQ==