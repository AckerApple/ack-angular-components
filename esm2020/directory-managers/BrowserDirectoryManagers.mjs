import { BaseDmFileReader, findDirectoryWithin, getNameByPath } from "./DirectoryManagers";
import { directoryReadToArray } from "./directoryReadToArray.function";
import { path } from "./path";
export class BrowserDmFileReader extends BaseDmFileReader {
    constructor(file, directory) {
        super();
        this.file = file;
        this.directory = directory;
        this.name = file.name;
    }
    async stats() {
        return this.getRealFile();
    }
    async write(fileString) {
        let writableStream;
        const likeFile = this.file;
        const hasPermission = likeFile.queryPermission && await likeFile.queryPermission() === 'granted';
        if (hasPermission) {
            writableStream = await likeFile.createWritable();
        }
        else {
            // request where to save
            const id = this.name.replace(/[^a-zA-Z0-9]/g, '-') + '-filePicker';
            const savePickerOptions = {
                suggestedName: this.name,
                /*types: [{
                  description: 'JSON',
                  accept: {
                    'application/json': ['.json'],
                  },
                }],*/
            };
            savePickerOptions.id = id.slice(0, 32);
            const handle = await window.showSaveFilePicker(savePickerOptions);
            writableStream = await handle.createWritable();
        }
        // write our file
        await writableStream.write(fileString);
        // close the file and write the contents to disk.
        await writableStream.close();
    }
    async getRealFile() {
        const file = this.file;
        return file.getFile ? await file.getFile() : Promise.resolve(file);
    }
    readAsText() {
        return new Promise(async (res, rej) => {
            try {
                var reader = new FileReader();
                const file = await this.getRealFile();
                reader.readAsText(file);
                reader.onload = () => res(reader.result);
            }
            catch (err) {
                rej(err);
            }
        });
    }
    readAsDataURL() {
        return new Promise(async (res, rej) => {
            try {
                var reader = new FileReader();
                const file = await this.getRealFile();
                reader.readAsDataURL(file);
                reader.onload = () => res(reader.result);
            }
            catch (err) {
                rej(err);
            }
        });
    }
}
export class BrowserDirectoryManager {
    constructor(path, files, // LikeFile[],
    directoryHandler) {
        this.path = path;
        this.files = files;
        this.directoryHandler = directoryHandler;
        this.name = getNameByPath(path);
    }
    findDirectory(path, options) {
        return findDirectoryWithin(path, this, options);
    }
    async list() {
        return this.files.map(file => file.name);
    }
    async listFolders() {
        return this.files.filter(file => file.kind && file.kind === 'directory')
            .map(file => file.name);
    }
    async listFiles() {
        return this.files.filter(file => file.kind === 'file')
            .map(file => file.name);
    }
    async getFolders() {
        return Promise.all(this.files.filter(file => file.kind && file.kind === 'directory')
            .map(async (file) => await this.getDirectory(file.name)));
    }
    async getFiles() {
        return this.files.filter(file => file.kind === 'file')
            .map(file => new BrowserDmFileReader(file, this));
    }
    async getDirectory(newPath, options) {
        const newPathArray = newPath.split('/');
        let fullNewPath = this.path;
        let dir;
        try {
            // traverse through each folder
            dir = await newPathArray.reduce(async (last, current) => {
                const next = await last;
                const newHandle = next.getDirectoryHandle(current, options);
                const name = (await newHandle).name;
                fullNewPath = path.join(fullNewPath, name);
                return newHandle;
            }, Promise.resolve(this.directoryHandler));
        }
        catch (err) {
            throw new Error(err.message + `. ${newPath} not found in ${this.name} (${this.path})`);
        }
        const files = await directoryReadToArray(dir);
        const newDir = new BrowserDirectoryManager(fullNewPath, files, dir);
        return newDir;
    }
    async file(fileName, options) {
        const findFile = await this.findFileByPath(fileName);
        if (findFile) {
            return findFile;
        }
        const fileHandle = await this.directoryHandler.getFileHandle(fileName, options);
        return new BrowserDmFileReader(fileHandle, this);
    }
    async findFileByPath(path, directoryHandler = this.directoryHandler) {
        if (!this.files.length) {
            return;
        }
        const pathSplit = path.split('/');
        const fileName = pathSplit[pathSplit.length - 1];
        // chrome we dig through the first selected directory and search the subs
        if (pathSplit.length > 1) {
            const lastParent = pathSplit.shift(); // remove index 0 of lastParent/firstParent/file.xyz
            const newHandler = await directoryHandler.getDirectoryHandle(lastParent);
            if (!newHandler) {
                console.debug('no matching upper folder', lastParent, directoryHandler);
                return;
            }
            const newPath = pathSplit.join('/');
            const dirMan = await this.getDirectory(lastParent);
            return dirMan.findFileByPath(newPath, newHandler);
        }
        let files = this.files;
        if (directoryHandler) {
            files = await directoryReadToArray(directoryHandler);
        }
        const likeFile = files.find(file => file.name === fileName);
        if (!likeFile) {
            return;
        }
        // when found, convert to File
        // const file = await this.getSystemFile(likeFile)
        return new BrowserDmFileReader(likeFile, this);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQnJvd3NlckRpcmVjdG9yeU1hbmFnZXJzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2RpcmVjdG9yeS1tYW5hZ2Vycy9Ccm93c2VyRGlyZWN0b3J5TWFuYWdlcnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGdCQUFnQixFQUFrQyxtQkFBbUIsRUFBRSxhQUFhLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQTtBQUMxSCxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQTtBQUN0RSxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sUUFBUSxDQUFBO0FBRTdCLE1BQU0sT0FBTyxtQkFBb0IsU0FBUSxnQkFBZ0I7SUFHdkQsWUFDUyxJQUFpQyxFQUNqQyxTQUEyQjtRQUVsQyxLQUFLLEVBQUUsQ0FBQTtRQUhBLFNBQUksR0FBSixJQUFJLENBQTZCO1FBQ2pDLGNBQVMsR0FBVCxTQUFTLENBQWtCO1FBR2xDLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQTtJQUN2QixDQUFDO0lBRUQsS0FBSyxDQUFDLEtBQUs7UUFDVCxPQUFPLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQTtJQUMzQixDQUFDO0lBRUQsS0FBSyxDQUFDLEtBQUssQ0FBQyxVQUFrQjtRQUM1QixJQUFJLGNBQW1CLENBQUE7UUFDdkIsTUFBTSxRQUFRLEdBQVEsSUFBSSxDQUFDLElBQUksQ0FBQTtRQUMvQixNQUFNLGFBQWEsR0FBRyxRQUFRLENBQUMsZUFBZSxJQUFJLE1BQU0sUUFBUSxDQUFDLGVBQWUsRUFBRSxLQUFLLFNBQVMsQ0FBQTtRQUVoRyxJQUFLLGFBQWEsRUFBRztZQUNuQixjQUFjLEdBQUcsTUFBTSxRQUFRLENBQUMsY0FBYyxFQUFFLENBQUE7U0FDakQ7YUFBTTtZQUNMLHdCQUF3QjtZQUN4QixNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxlQUFlLEVB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QU8sTUFBTSxDQUFDLGNBQWMsQ0FBQyxPQUFPLEVBQUUsVUFBVSxDQUFDLENBQUE7U0FDbEQ7UUFFRCxJQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFBO1FBQ3RCLElBQUssZ0JBQWdCLEVBQUc7WUFDdEIsS0FBSyxHQUFHLE1BQU0sb0JBQW9CLENBQUMsZ0JBQWdCLENBQUMsQ0FBQTtTQUNyRDtRQUVELE1BQU0sUUFBUSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxLQUFLLFFBQVEsQ0FBQyxDQUFBO1FBQzNELElBQUssQ0FBQyxRQUFRLEVBQUc7WUFDZixPQUFNO1NBQ1A7UUFFRCw4QkFBOEI7UUFDOUIsa0RBQWtEO1FBRWxELE9BQU8sSUFBSSxtQkFBbUIsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUE7SUFDaEQsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQmFzZURtRmlsZVJlYWRlciwgRGlyZWN0b3J5TWFuYWdlciwgRG1GaWxlUmVhZGVyLCBmaW5kRGlyZWN0b3J5V2l0aGluLCBnZXROYW1lQnlQYXRoIH0gZnJvbSBcIi4vRGlyZWN0b3J5TWFuYWdlcnNcIlxuaW1wb3J0IHsgZGlyZWN0b3J5UmVhZFRvQXJyYXkgfSBmcm9tIFwiLi9kaXJlY3RvcnlSZWFkVG9BcnJheS5mdW5jdGlvblwiXG5pbXBvcnQgeyBwYXRoIH0gZnJvbSBcIi4vcGF0aFwiXG5cbmV4cG9ydCBjbGFzcyBCcm93c2VyRG1GaWxlUmVhZGVyIGV4dGVuZHMgQmFzZURtRmlsZVJlYWRlciBpbXBsZW1lbnRzIERtRmlsZVJlYWRlciB7XG4gIG5hbWU6IHN0cmluZ1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyBmaWxlOiBGaWxlIHwgRmlsZVN5c3RlbUZpbGVIYW5kbGUsXG4gICAgcHVibGljIGRpcmVjdG9yeTogRGlyZWN0b3J5TWFuYWdlclxuICApIHtcbiAgICBzdXBlcigpXG4gICAgdGhpcy5uYW1lID0gZmlsZS5uYW1lXG4gIH1cblxuICBhc3luYyBzdGF0cygpIHtcbiAgICByZXR1cm4gdGhpcy5nZXRSZWFsRmlsZSgpXG4gIH1cblxuICBhc3luYyB3cml0ZShmaWxlU3RyaW5nOiBzdHJpbmcpIHtcbiAgICBsZXQgd3JpdGFibGVTdHJlYW06IGFueVxuICAgIGNvbnN0IGxpa2VGaWxlOiBhbnkgPSB0aGlzLmZpbGVcbiAgICBjb25zdCBoYXNQZXJtaXNzaW9uID0gbGlrZUZpbGUucXVlcnlQZXJtaXNzaW9uICYmIGF3YWl0IGxpa2VGaWxlLnF1ZXJ5UGVybWlzc2lvbigpID09PSAnZ3JhbnRlZCdcblxuICAgIGlmICggaGFzUGVybWlzc2lvbiApIHtcbiAgICAgIHdyaXRhYmxlU3RyZWFtID0gYXdhaXQgbGlrZUZpbGUuY3JlYXRlV3JpdGFibGUoKVxuICAgIH0gZWxzZSB7XG4gICAgICAvLyByZXF1ZXN0IHdoZXJlIHRvIHNhdmVcbiAgICAgIGNvbnN0IGlkID0gdGhpcy5uYW1lLnJlcGxhY2UoL1teYS16QS1aMC05XS9nLCctJykrJy1maWxlUGlja2VyJ1xuICAgICAgY29uc3Qgc2F2ZVBpY2tlck9wdGlvbnMgPSB7XG4gICAgICAgIHN1Z2dlc3RlZE5hbWU6IHRoaXMubmFtZSxcbiAgICAgICAgLyp0eXBlczogW3tcbiAgICAgICAgICBkZXNjcmlwdGlvbjogJ0pTT04nLFxuICAgICAgICAgIGFjY2VwdDoge1xuICAgICAgICAgICAgJ2FwcGxpY2F0aW9uL2pzb24nOiBbJy5qc29uJ10sXG4gICAgICAgICAgfSxcbiAgICAgICAgfV0sKi9cbiAgICAgIH1cblxuICAgICAgLy8gYmVsb3csIHRob3VnaHQgdG8gcmVtZW1iZXIgbGFzdCBtYXRjaGluZyBmaWxlIChpIHRoaW5rIGRhdGEgdHlwaW5nIGlzIGp1c3QgbWlzc2luZyBmb3IgaXQpXG4gICAgICA7KHNhdmVQaWNrZXJPcHRpb25zIGFzIGFueSkuaWQgPSBpZC5zbGljZSgwLCAzMilcblxuICAgICAgY29uc3QgaGFuZGxlID0gYXdhaXQgd2luZG93LnNob3dTYXZlRmlsZVBpY2tlcihzYXZlUGlja2VyT3B0aW9ucylcbiAgICAgIFxuICAgICAgd3JpdGFibGVTdHJlYW0gPSBhd2FpdCBoYW5kbGUuY3JlYXRlV3JpdGFibGUoKVxuICAgIH1cblxuXG4gICAgLy8gd3JpdGUgb3VyIGZpbGVcbiAgICBhd2FpdCB3cml0YWJsZVN0cmVhbS53cml0ZSggZmlsZVN0cmluZyApXG5cbiAgICAvLyBjbG9zZSB0aGUgZmlsZSBhbmQgd3JpdGUgdGhlIGNvbnRlbnRzIHRvIGRpc2suXG4gICAgYXdhaXQgd3JpdGFibGVTdHJlYW0uY2xvc2UoKVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBnZXRSZWFsRmlsZSgpOiBQcm9taXNlPEZpbGU+IHtcbiAgICBjb25zdCBmaWxlID0gdGhpcy5maWxlIGFzIGFueVxuICAgIHJldHVybiBmaWxlLmdldEZpbGUgPyBhd2FpdCBmaWxlLmdldEZpbGUoKSA6IFByb21pc2UucmVzb2x2ZShmaWxlKVxuICB9XG4gIFxuICBvdmVycmlkZSByZWFkQXNUZXh0KCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGFzeW5jIChyZXMsIHJlaikgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgdmFyIHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKClcbiAgICAgICAgY29uc3QgZmlsZSA9IGF3YWl0IHRoaXMuZ2V0UmVhbEZpbGUoKVxuICAgICAgICByZWFkZXIucmVhZEFzVGV4dChmaWxlKVxuICAgICAgICByZWFkZXIub25sb2FkID0gKCkgPT4gcmVzKHJlYWRlci5yZXN1bHQgYXMgc3RyaW5nKVxuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHJlaihlcnIpXG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIHJlYWRBc0RhdGFVUkwoKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoYXN5bmMgKHJlcywgcmVqKSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICB2YXIgcmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKVxuICAgICAgICBjb25zdCBmaWxlID0gYXdhaXQgdGhpcy5nZXRSZWFsRmlsZSgpXG4gICAgICAgIHJlYWRlci5yZWFkQXNEYXRhVVJMKGZpbGUpXG4gICAgICAgIHJlYWRlci5vbmxvYWQgPSAoKSA9PiByZXMocmVhZGVyLnJlc3VsdCBhcyBzdHJpbmcpXG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgcmVqKGVycilcbiAgICAgIH1cbiAgICB9KVxuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBCcm93c2VyRGlyZWN0b3J5TWFuYWdlciBpbXBsZW1lbnRzIERpcmVjdG9yeU1hbmFnZXIge1xuICBuYW1lOiBzdHJpbmdcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgcGF0aDogc3RyaW5nLFxuICAgIHB1YmxpYyBmaWxlczogRmlsZVN5c3RlbUZpbGVIYW5kbGVbXSwgLy8gTGlrZUZpbGVbXSxcbiAgICBwdWJsaWMgZGlyZWN0b3J5SGFuZGxlcjogRmlsZVN5c3RlbURpcmVjdG9yeUhhbmRsZSxcbiAgKSB7XG4gICAgdGhpcy5uYW1lID0gZ2V0TmFtZUJ5UGF0aChwYXRoKVxuICB9XG5cbiAgZmluZERpcmVjdG9yeSAoXG4gICAgcGF0aDogc3RyaW5nLFxuICAgIG9wdGlvbnM/OiBGaWxlU3lzdGVtR2V0RGlyZWN0b3J5T3B0aW9ucyxcbiAgKTogUHJvbWlzZTxEaXJlY3RvcnlNYW5hZ2VyIHwgdW5kZWZpbmVkPiB7XG4gICAgcmV0dXJuIGZpbmREaXJlY3RvcnlXaXRoaW4ocGF0aCwgdGhpcywgb3B0aW9ucylcbiAgfVxuICBcbiAgYXN5bmMgbGlzdCgpOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gICAgcmV0dXJuIHRoaXMuZmlsZXMubWFwKGZpbGUgPT4gZmlsZS5uYW1lKVxuICB9XG4gIFxuICBhc3luYyBsaXN0Rm9sZGVycygpOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gICAgcmV0dXJuIHRoaXMuZmlsZXMuZmlsdGVyKGZpbGUgPT4gZmlsZS5raW5kICYmIChmaWxlIGFzIGFueSkua2luZCA9PT0gJ2RpcmVjdG9yeScpXG4gICAgICAubWFwKGZpbGUgPT4gZmlsZS5uYW1lKVxuICB9XG4gIFxuICBhc3luYyBsaXN0RmlsZXMoKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIHJldHVybiB0aGlzLmZpbGVzLmZpbHRlcihmaWxlID0+IGZpbGUua2luZCA9PT0gJ2ZpbGUnKVxuICAgICAgLm1hcChmaWxlID0+IGZpbGUubmFtZSlcbiAgfVxuICBcbiAgYXN5bmMgZ2V0Rm9sZGVycygpOiBQcm9taXNlPEJyb3dzZXJEaXJlY3RvcnlNYW5hZ2VyW10+IHtcbiAgICByZXR1cm4gUHJvbWlzZS5hbGwoXG4gICAgICB0aGlzLmZpbGVzLmZpbHRlcihmaWxlID0+IGZpbGUua2luZCAmJiAoZmlsZSBhcyBhbnkpLmtpbmQgPT09ICdkaXJlY3RvcnknKVxuICAgICAgICAubWFwKGFzeW5jIGZpbGUgPT4gYXdhaXQgdGhpcy5nZXREaXJlY3RvcnkoZmlsZS5uYW1lKSlcbiAgICApXG4gIH1cbiAgXG4gIGFzeW5jIGdldEZpbGVzKCk6IFByb21pc2U8RG1GaWxlUmVhZGVyW10+IHtcbiAgICByZXR1cm4gdGhpcy5maWxlcy5maWx0ZXIoZmlsZSA9PiBmaWxlLmtpbmQgPT09ICdmaWxlJylcbiAgICAgIC5tYXAoZmlsZSA9PiBuZXcgQnJvd3NlckRtRmlsZVJlYWRlcihmaWxlLCB0aGlzKSlcbiAgfVxuXG4gIGFzeW5jIGdldERpcmVjdG9yeShcbiAgICBuZXdQYXRoOiBzdHJpbmcsXG4gICAgb3B0aW9ucz86IEZpbGVTeXN0ZW1HZXREaXJlY3RvcnlPcHRpb25zXG4gICk6IFByb21pc2U8QnJvd3NlckRpcmVjdG9yeU1hbmFnZXI+IHtcbiAgICBjb25zdCBuZXdQYXRoQXJyYXkgPSBuZXdQYXRoLnNwbGl0KCcvJylcbiAgICBsZXQgZnVsbE5ld1BhdGggPSB0aGlzLnBhdGhcbiAgICBsZXQgZGlyOiBGaWxlU3lzdGVtRGlyZWN0b3J5SGFuZGxlXG5cbiAgICB0cnkge1xuICAgICAgLy8gdHJhdmVyc2UgdGhyb3VnaCBlYWNoIGZvbGRlclxuICAgICAgZGlyICA9IGF3YWl0IG5ld1BhdGhBcnJheS5yZWR1Y2UoYXN5bmMgKGxhc3QsY3VycmVudCkgPT4ge1xuICAgICAgICBjb25zdCBuZXh0OiBGaWxlU3lzdGVtRGlyZWN0b3J5SGFuZGxlID0gYXdhaXQgbGFzdFxuICAgICAgICBjb25zdCBuZXdIYW5kbGUgPSBuZXh0LmdldERpcmVjdG9yeUhhbmRsZShjdXJyZW50LCBvcHRpb25zKVxuICAgICAgICBjb25zdCBuYW1lID0gKGF3YWl0IG5ld0hhbmRsZSkubmFtZVxuICAgICAgICBmdWxsTmV3UGF0aCA9IHBhdGguam9pbihmdWxsTmV3UGF0aCwgbmFtZSlcbiAgICAgICAgcmV0dXJuIG5ld0hhbmRsZVxuICAgICAgfSwgUHJvbWlzZS5yZXNvbHZlKHRoaXMuZGlyZWN0b3J5SGFuZGxlcikpXG4gICAgfSBjYXRjaCAoZXJyOiBhbnkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihlcnIubWVzc2FnZSArIGAuICR7bmV3UGF0aH0gbm90IGZvdW5kIGluICR7dGhpcy5uYW1lfSAoJHt0aGlzLnBhdGh9KWApXG4gICAgfVxuXG4gICAgY29uc3QgZmlsZXM6IEZpbGVTeXN0ZW1GaWxlSGFuZGxlW10gPSBhd2FpdCBkaXJlY3RvcnlSZWFkVG9BcnJheShkaXIpXG4gICAgY29uc3QgbmV3RGlyID0gbmV3IEJyb3dzZXJEaXJlY3RvcnlNYW5hZ2VyKFxuICAgICAgZnVsbE5ld1BhdGgsXG4gICAgICBmaWxlcyxcbiAgICAgIGRpclxuICAgIClcbiAgICByZXR1cm4gbmV3RGlyXG4gIH1cblxuICBhc3luYyBmaWxlKGZpbGVOYW1lOiBzdHJpbmcsIG9wdGlvbnM/OiBGaWxlU3lzdGVtR2V0RmlsZU9wdGlvbnMpIHtcbiAgICBjb25zdCBmaW5kRmlsZSA9IGF3YWl0IHRoaXMuZmluZEZpbGVCeVBhdGgoZmlsZU5hbWUpXG5cbiAgICBpZiAoIGZpbmRGaWxlICkge1xuICAgICAgcmV0dXJuIGZpbmRGaWxlXG4gICAgfVxuXG4gICAgY29uc3QgZmlsZUhhbmRsZSA9IGF3YWl0IHRoaXMuZGlyZWN0b3J5SGFuZGxlci5nZXRGaWxlSGFuZGxlKGZpbGVOYW1lLCBvcHRpb25zKVxuICAgIHJldHVybiBuZXcgQnJvd3NlckRtRmlsZVJlYWRlcihmaWxlSGFuZGxlLCB0aGlzKVxuICB9XG5cbiAgYXN5bmMgZmluZEZpbGVCeVBhdGgoXG4gICAgcGF0aDogc3RyaW5nLFxuICAgIGRpcmVjdG9yeUhhbmRsZXI6IGFueSA9IHRoaXMuZGlyZWN0b3J5SGFuZGxlcixcbiAgKTogUHJvbWlzZTxCcm93c2VyRG1GaWxlUmVhZGVyIHwgdW5kZWZpbmVkPiB7XG4gICAgaWYgKCAhdGhpcy5maWxlcy5sZW5ndGggKSB7XG4gICAgICByZXR1cm5cbiAgICB9XG5cbiAgICBjb25zdCBwYXRoU3BsaXQgPSBwYXRoLnNwbGl0KCcvJylcbiAgICBjb25zdCBmaWxlTmFtZSA9IHBhdGhTcGxpdFsgcGF0aFNwbGl0Lmxlbmd0aC0xIF1cblxuICAgIC8vIGNocm9tZSB3ZSBkaWcgdGhyb3VnaCB0aGUgZmlyc3Qgc2VsZWN0ZWQgZGlyZWN0b3J5IGFuZCBzZWFyY2ggdGhlIHN1YnNcbiAgICBpZiAoIHBhdGhTcGxpdC5sZW5ndGggPiAxICkge1xuICAgICAgY29uc3QgbGFzdFBhcmVudCA9IHBhdGhTcGxpdC5zaGlmdCgpIGFzIHN0cmluZyAvLyByZW1vdmUgaW5kZXggMCBvZiBsYXN0UGFyZW50L2ZpcnN0UGFyZW50L2ZpbGUueHl6XG4gICAgICBjb25zdCBuZXdIYW5kbGVyID0gYXdhaXQgZGlyZWN0b3J5SGFuZGxlci5nZXREaXJlY3RvcnlIYW5kbGUoIGxhc3RQYXJlbnQgKVxuICAgICAgXG4gICAgICBpZiAoICFuZXdIYW5kbGVyICkge1xuICAgICAgICBjb25zb2xlLmRlYnVnKCdubyBtYXRjaGluZyB1cHBlciBmb2xkZXInLCBsYXN0UGFyZW50LCBkaXJlY3RvcnlIYW5kbGVyKVxuICAgICAgICByZXR1cm5cbiAgICAgIH1cblxuICAgICAgY29uc3QgbmV3UGF0aCA9IHBhdGhTcGxpdC5qb2luKCcvJylcbiAgICAgIGNvbnN0IGRpck1hbiA9IGF3YWl0IHRoaXMuZ2V0RGlyZWN0b3J5KGxhc3RQYXJlbnQpXG4gICAgICBcbiAgICAgIHJldHVybiBkaXJNYW4uZmluZEZpbGVCeVBhdGgobmV3UGF0aCwgbmV3SGFuZGxlcilcbiAgICB9XG4gICAgXG4gICAgbGV0IGZpbGVzID0gdGhpcy5maWxlc1xuICAgIGlmICggZGlyZWN0b3J5SGFuZGxlciApIHtcbiAgICAgIGZpbGVzID0gYXdhaXQgZGlyZWN0b3J5UmVhZFRvQXJyYXkoZGlyZWN0b3J5SGFuZGxlcilcbiAgICB9XG4gICAgXG4gICAgY29uc3QgbGlrZUZpbGUgPSBmaWxlcy5maW5kKGZpbGUgPT4gZmlsZS5uYW1lID09PSBmaWxlTmFtZSlcbiAgICBpZiAoICFsaWtlRmlsZSApIHtcbiAgICAgIHJldHVyblxuICAgIH1cbiAgICBcbiAgICAvLyB3aGVuIGZvdW5kLCBjb252ZXJ0IHRvIEZpbGVcbiAgICAvLyBjb25zdCBmaWxlID0gYXdhaXQgdGhpcy5nZXRTeXN0ZW1GaWxlKGxpa2VGaWxlKVxuICAgIFxuICAgIHJldHVybiBuZXcgQnJvd3NlckRtRmlsZVJlYWRlcihsaWtlRmlsZSwgdGhpcylcbiAgfVxufVxuIl19