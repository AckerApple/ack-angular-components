import { convertSlashes } from "./convertSlashes";
import { BaseDmFileReader, findDirectoryWithin, getDirForFilePath, getNameByPath, renameFileInDir } from "./DirectoryManagers";
import { path } from "./path";
const fs = typeof Neutralino === 'object' ? Neutralino.filesystem : {};
export class NeutralinoDmFileReader extends BaseDmFileReader {
    constructor(filePath, directory) {
        super();
        this.filePath = filePath;
        this.directory = directory;
        this.name = filePath.split(/\\|\//).pop();
    }
    async stats() {
        const stats = await fs.getStats(this.filePath);
        stats.name = stats.name || this.name;
        return stats;
    }
    readAsText() {
        return fs.readFile(this.filePath); // .toString()
    }
    async readAsDataURL() {
        let data = await fs.readBinaryFile(this.filePath);
        const view = new Uint8Array(data);
        var decoder = new TextDecoder('utf8');
        var b64encoded = btoa(decoder.decode(view));
        return b64encoded;
    }
    async write(fileString) {
        return fs.writeFile(this.filePath, fileString);
    }
}
export class NeutralinoDirectoryManager {
    constructor(path) {
        this.path = path;
        this.name = getNameByPath(path);
    }
    findDirectory(path, options) {
        return findDirectoryWithin(path, this, options);
    }
    async list() {
        const reads = await Neutralino.filesystem.readDirectory(this.path);
        return reads.filter(read => !['.', '..'].includes(read.entry)).map(read => read.entry);
    }
    async listFolders() {
        const reads = await Neutralino.filesystem.readDirectory(this.path);
        return reads.filter(read => !['.', '..'].includes(read.entry) && read.type === 'DIRECTORY')
            .map(read => read.entry);
    }
    async listFiles() {
        const reads = await Neutralino.filesystem.readDirectory(this.path);
        return reads.filter(read => !['.', '..'].includes(read.entry) && read.type !== 'DIRECTORY')
            .map(read => read.entry);
    }
    async getFolders() {
        return Promise.all((await this.listFolders()).map(async (name) => await this.getDirectory(name)));
    }
    async getFiles() {
        const reads = await Neutralino.filesystem.readDirectory(this.path);
        return reads.filter(read => !['.', '..'].includes(read.entry) && read.type !== 'DIRECTORY')
            .map(read => new NeutralinoDmFileReader(this.getFullPath(read.entry), this));
    }
    async createDirectory(newPath) {
        try {
            const fullPath = path.join(this.path, convertSlashes(newPath));
            await Neutralino.filesystem.readDirectory(fullPath);
            // it exists, just read it
            return this.getDirectory(newPath);
        }
        catch (err) {
            if (err.code === 'NE_FS_NOPATHE') {
                const splitPath = convertSlashes(newPath).split('/');
                let pathTo = this.path;
                while (splitPath.length) {
                    const nowName = splitPath.shift();
                    pathTo = path.join(pathTo, nowName);
                    await Neutralino.filesystem.createDirectory(pathTo);
                }
                const fullPath = pathTo; // path.join(this.path, newPath)
                return new NeutralinoDirectoryManager(fullPath);
            }
            throw err;
        }
    }
    async getDirectory(newPath, options) {
        if (!newPath) {
            return this;
        }
        const pathTo = path.join(this.path, newPath);
        try {
            // ensure path exists
            await Neutralino.filesystem.readDirectory(pathTo);
            return new NeutralinoDirectoryManager(pathTo);
        }
        catch (err) {
            if (err.code === 'NE_FS_NOPATHE' && options?.create) {
                return this.createDirectory(newPath);
            }
            throw err; // rethrow
        }
    }
    async findFileByPath(path) {
        const pathSplit = path.split(/\\|\//);
        const fileName = pathSplit.pop().toLowerCase(); // pathSplit[ pathSplit.length-1 ]
        let dir = this;
        // chrome we dig through the first selected directory and search the subs
        if (pathSplit.length) {
            const findDir = await this.findDirectory(pathSplit.join('/'));
            if (!findDir) {
                return;
            }
            dir = findDir;
        }
        const files = await dir.listFiles();
        const matchName = files.find(listName => listName.toLowerCase() === fileName);
        if (!matchName) {
            return;
        }
        const fullPath = dir.getFullPath(matchName);
        return new NeutralinoDmFileReader(fullPath, dir);
    }
    async file(pathTo, options) {
        const existingFile = await this.findFileByPath(pathTo);
        if (existingFile) {
            return existingFile;
        }
        const dirOptions = { create: options?.create };
        const dir = await getDirForFilePath(pathTo, this, dirOptions);
        const fileName = pathTo.split(/\\|\//).pop();
        const fullPath = path.join(dir.path, fileName);
        return new NeutralinoDmFileReader(fullPath, dir);
    }
    getFullPath(itemPath) {
        let fullFilePath = path.join(this.path, itemPath);
        return convertSlashes(fullFilePath);
    }
    async renameFile(oldFileName, newFileName) {
        return renameFileInDir(oldFileName, newFileName, this);
    }
    async removeEntry(name, options) {
        const split = name.split(/\\|\//);
        const lastName = split.pop(); // remove last item
        const dir = split.length >= 1 ? await this.getDirectory(split.join('/')) : this;
        const pathTo = path.join(dir.path, lastName);
        const fileNames = await dir.listFiles();
        if (fileNames.includes(lastName)) {
            return Neutralino.filesystem.removeFile(pathTo);
        }
        try {
            await Neutralino.filesystem.removeDirectory(pathTo);
        }
        catch (err) {
            // if folder delete failed, it may have items within Neutralino does not have recursive delete
            if (err.code === 'NE_FS_RMDIRER' && options?.recursive) {
                return recurseRemoveDir(await dir.getDirectory(lastName));
            }
            throw err;
        }
        return;
    }
}
async function recurseRemoveDir(dir) {
    // remove all folders within
    const folders = await dir.getFolders();
    for (const subdir of folders) {
        await recurseRemoveDir(subdir);
    }
    // remove all files within
    const list = await dir.listFiles();
    for (const fileName of list) {
        await dir.removeEntry(fileName);
    }
    // try now to delete again
    return Neutralino.filesystem.removeDirectory(dir.path);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTmV1dHJhbGlub0RpcmVjdG9yeU1hbmFnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvZGlyZWN0b3J5LW1hbmFnZXJzL05ldXRyYWxpbm9EaXJlY3RvcnlNYW5hZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQTtBQUNqRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQWtDLG1CQUFtQixFQUFFLGlCQUFpQixFQUFFLGFBQWEsRUFBRSxlQUFlLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQTtBQUM5SixPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sUUFBUSxDQUFBO0FBa0I3QixNQUFNLEVBQUUsR0FBRyxPQUFPLFVBQVUsS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLEVBQW1CLENBQUE7QUFFdkYsTUFBTSxPQUFPLHNCQUF1QixTQUFRLGdCQUFnQjtJQUcxRCxZQUNTLFFBQWdCLEVBQ2hCLFNBQXFDO1FBRTVDLEtBQUssRUFBRSxDQUFBO1FBSEEsYUFBUSxHQUFSLFFBQVEsQ0FBUTtRQUNoQixjQUFTLEdBQVQsU0FBUyxDQUE0QjtRQUc1QyxJQUFJLENBQUMsSUFBSSxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBRyxFQUFZLENBQUE7SUFDckQsQ0FBQztJQUVELEtBQUssQ0FBQyxLQUFLO1FBQ1QsTUFBTSxLQUFLLEdBQUcsTUFBTSxFQUFFLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQTtRQUM5QyxLQUFLLENBQUMsSUFBSSxHQUFHLEtBQUssQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQTtRQUNwQyxPQUFPLEtBQUssQ0FBQTtJQUNkLENBQUM7SUFFUSxVQUFVO1FBQ2pCLE9BQU8sRUFBRSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMs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O1NBQ2hEO1FBRUQsSUFBSTtZQUNGLE1BQU0sVUFBVSxDQUFDLFVBQVUsQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLENBQUE7U0FDcEQ7UUFBQyxPQUFPLEdBQVEsRUFBRTtZQUNqQiw4RkFBOEY7WUFDOUYsSUFBSyxHQUFHLENBQUMsSUFBSSxLQUFLLGVBQWUsSUFBSSxPQUFPLEVBQUUsU0FBUyxFQUFHO2dCQUN4RCxPQUFPLGdCQUFnQixDQUFFLE1BQU0sR0FBRyxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBRSxDQUFBO2FBQzVEO1lBQ0QsTUFBTSxHQUFHLENBQUE7U0FDVjtRQUNELE9BQU07SUFDUixDQUFDO0NBQ0Y7QUFFRCxLQUFLLFVBQVUsZ0JBQWdCLENBQzdCLEdBQStCO0lBRS9CLDRCQUE0QjtJQUM1QixNQUFNLE9BQU8sR0FBRyxNQUFNLEdBQUcsQ0FBQyxVQUFVLEVBQUUsQ0FBQTtJQUN0QyxLQUFLLE1BQU0sTUFBTSxJQUFJLE9BQU8sRUFBRTtRQUM1QixNQUFNLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxDQUFBO0tBQy9CO0lBRUQsMEJBQTBCO0lBQzFCLE1BQU0sSUFBSSxHQUFHLE1BQU0sR0FBRyxDQUFDLFNBQVMsRUFBRSxDQUFBO0lBQ2xDLEtBQUssTUFBTSxRQUFRLElBQUksSUFBSSxFQUFFO1FBQzNCLE1BQU0sR0FBRyxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQTtLQUNoQztJQUVELDBCQUEwQjtJQUMxQixPQUFPLFVBQVUsQ0FBQyxVQUFVLENBQUMsZUFBZSxDQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUUsQ0FBQTtBQUMxRCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgY29udmVydFNsYXNoZXMgfSBmcm9tIFwiLi9jb252ZXJ0U2xhc2hlc1wiXG5pbXBvcnQgeyBCYXNlRG1GaWxlUmVhZGVyLCBEaXJlY3RvcnlNYW5hZ2VyLCBEbUZpbGVSZWFkZXIsIGZpbmREaXJlY3RvcnlXaXRoaW4sIGdldERpckZvckZpbGVQYXRoLCBnZXROYW1lQnlQYXRoLCByZW5hbWVGaWxlSW5EaXIgfSBmcm9tIFwiLi9EaXJlY3RvcnlNYW5hZ2Vyc1wiXG5pbXBvcnQgeyBwYXRoIH0gZnJvbSBcIi4vcGF0aFwiXG5cbmludGVyZmFjZSBJTmV1dHJhbGlubyB7XG4gIGZpbGVzeXN0ZW06IElOZXV0cmFsaW5vRnNcbn1cbmludGVyZmFjZSBJTmV1dHJhbGlub0ZzIHtcbiAgZ2V0U3RhdHM6IChwYXRoOiBzdHJpbmcpID0+IGFueVxuICByZWFkRmlsZTogKHBhdGg6IHN0cmluZykgPT4gYW55XG4gIHJlYWRCaW5hcnlGaWxlOiAocGF0aDogc3RyaW5nKSA9PiBhbnlcbiAgd3JpdGVGaWxlOiAocGF0aDogc3RyaW5nLCBkYXRhOiBzdHJpbmcgfCBBcnJheUJ1ZmZlcikgPT4gYW55XG4gIHJlbW92ZUZpbGU6IChwYXRoOiBzdHJpbmcpID0+IGFueVxuICByZW1vdmVEaXJlY3Rvcnk6IChwYXRoOiBzdHJpbmcpID0+IGFueVxuICBcbiAgY3JlYXRlRGlyZWN0b3J5OiAocGF0aDogc3RyaW5nKSA9PiBQcm9taXNlPHtlbnRyeTogJ0ZJTEUnIHwgJ0RJUkVDVE9SWScsIHR5cGU6IHN0cmluZ31bXT5cbiAgcmVhZERpcmVjdG9yeTogKHBhdGg6IHN0cmluZykgPT4gUHJvbWlzZTx7ZW50cnk6ICdGSUxFJyB8ICdESVJFQ1RPUlknLCB0eXBlOiBzdHJpbmd9W10+XG59XG5cbmRlY2xhcmUgY29uc3QgTmV1dHJhbGlubzogSU5ldXRyYWxpbm9cbmNvbnN0IGZzID0gdHlwZW9mIE5ldXRyYWxpbm8gPT09ICdvYmplY3QnID8gTmV1dHJhbGluby5maWxlc3lzdGVtIDoge30gYXMgSU5ldXRyYWxpbm9Gc1xuXG5leHBvcnQgY2xhc3MgTmV1dHJhbGlub0RtRmlsZVJlYWRlciBleHRlbmRzIEJhc2VEbUZpbGVSZWFkZXIgaW1wbGVtZW50cyBEbUZpbGVSZWFkZXIge1xuICBuYW1lOiBzdHJpbmdcbiAgXG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyBmaWxlUGF0aDogc3RyaW5nLFxuICAgIHB1YmxpYyBkaXJlY3Rvcnk6IE5ldXRyYWxpbm9EaXJlY3RvcnlNYW5hZ2VyLFxuICApIHtcbiAgICBzdXBlcigpXG4gICAgdGhpcy5uYW1lID0gZmlsZVBhdGguc3BsaXQoL1xcXFx8XFwvLykucG9wKCkgYXMgc3RyaW5nXG4gIH1cblxuICBhc3luYyBzdGF0cygpIHtcbiAgICBjb25zdCBzdGF0cyA9IGF3YWl0IGZzLmdldFN0YXRzKHRoaXMuZmlsZVBhdGgpXG4gICAgc3RhdHMubmFtZSA9IHN0YXRzLm5hbWUgfHwgdGhpcy5uYW1lXG4gICAgcmV0dXJuIHN0YXRzXG4gIH1cblxuICBvdmVycmlkZSByZWFkQXNUZXh0KCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgcmV0dXJuIGZzLnJlYWRGaWxlKHRoaXMuZmlsZVBhdGgpIC8vIC50b1N0cmluZygpXG4gIH1cbiAgXG4gIGFzeW5jIHJlYWRBc0RhdGFVUkwoKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBsZXQgZGF0YSA9IGF3YWl0IGZzLnJlYWRCaW5hcnlGaWxlKHRoaXMuZmlsZVBhdGgpXG4gICAgY29uc3QgdmlldyA9IG5ldyBVaW50OEFycmF5KGRhdGEpO1xuICAgIHZhciBkZWNvZGVyID0gbmV3IFRleHREZWNvZGVyKCd1dGY4Jyk7XG4gICAgdmFyIGI2NGVuY29kZWQgPSBidG9hKGRlY29kZXIuZGVjb2RlKHZpZXcpKVxuICAgIHJldHVybiBiNjRlbmNvZGVkXG4gIH1cblxuICBhc3luYyB3cml0ZShmaWxlU3RyaW5nOiBzdHJpbmcgfCBBcnJheUJ1ZmZlcikge1xuICAgIHJldHVybiBmcy53cml0ZUZpbGUodGhpcy5maWxlUGF0aCwgZmlsZVN0cmluZylcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgTmV1dHJhbGlub0RpcmVjdG9yeU1hbmFnZXIgaW1wbGVtZW50cyBEaXJlY3RvcnlNYW5hZ2VyIHtcbiAgbmFtZTogc3RyaW5nXG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHVibGljIHBhdGg6IHN0cmluZyxcbiAgKSB7XG4gICAgdGhpcy5uYW1lID0gZ2V0TmFtZUJ5UGF0aChwYXRoKVxuICB9XG5cbiAgZmluZERpcmVjdG9yeSAoXG4gICAgcGF0aDogc3RyaW5nLFxuICAgIG9wdGlvbnM/OiBGaWxlU3lzdGVtR2V0RGlyZWN0b3J5T3B0aW9ucyxcbiAgKTogUHJvbWlzZTxOZXV0cmFsaW5vRGlyZWN0b3J5TWFuYWdlciB8IHVuZGVmaW5lZD4ge1xuICAgIHJldHVybiBmaW5kRGlyZWN0b3J5V2l0aGluKHBhdGgsIHRoaXMsIG9wdGlvbnMpIGFzIFByb21pc2U8TmV1dHJhbGlub0RpcmVjdG9yeU1hbmFnZXIgfCB1bmRlZmluZWQ+XG4gIH1cblxuICBhc3luYyBsaXN0KCk6IFByb21pc2U8c3RyaW5nW10+IHtcbiAgICBjb25zdCByZWFkcyA9IGF3YWl0IE5ldXRyYWxpbm8uZmlsZXN5c3RlbS5yZWFkRGlyZWN0b3J5KCB0aGlzLnBhdGggKVxuICAgIHJldHVybiByZWFkcy5maWx0ZXIocmVhZCA9PiAhWycuJywnLi4nXS5pbmNsdWRlcyhyZWFkLmVudHJ5KSkubWFwKHJlYWQgPT4gcmVhZC5lbnRyeSlcbiAgfVxuXG4gIGFzeW5jIGxpc3RGb2xkZXJzKCk6IFByb21pc2U8c3RyaW5nW10+IHtcbiAgICBjb25zdCByZWFkcyA9IGF3YWl0IE5ldXRyYWxpbm8uZmlsZXN5c3RlbS5yZWFkRGlyZWN0b3J5KCB0aGlzLnBhdGggKVxuICAgIHJldHVybiByZWFkcy5maWx0ZXIocmVhZCA9PiAhWycuJywnLi4nXS5pbmNsdWRlcyhyZWFkLmVudHJ5KSAmJiByZWFkLnR5cGUgPT09ICdESVJFQ1RPUlknKVxuICAgICAgLm1hcChyZWFkID0+IHJlYWQuZW50cnkpXG4gIH1cblxuICBhc3luYyBsaXN0RmlsZXMoKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIGNvbnN0IHJlYWRzID0gYXdhaXQgTmV1dHJhbGluby5maWxlc3lzdGVtLnJlYWREaXJlY3RvcnkoIHRoaXMucGF0aCApXG4gICAgcmV0dXJuIHJlYWRzLmZpbHRlcihyZWFkID0+ICFbJy4nLCcuLiddLmluY2x1ZGVzKHJlYWQuZW50cnkpICYmIHJlYWQudHlwZSAhPT0gJ0RJUkVDVE9SWScpXG4gICAgICAubWFwKHJlYWQgPT4gcmVhZC5lbnRyeSlcbiAgfVxuXG4gIGFzeW5jIGdldEZvbGRlcnMoKTogUHJvbWlzZTxOZXV0cmFsaW5vRGlyZWN0b3J5TWFuYWdlcltdPiB7XG4gICAgcmV0dXJuIFByb21pc2UuYWxsKFxuICAgICAgKGF3YWl0IHRoaXMubGlzdEZvbGRlcnMoKSkubWFwKGFzeW5jIG5hbWUgPT4gYXdhaXQgdGhpcy5nZXREaXJlY3RvcnkobmFtZSkpXG4gICAgKVxuICB9XG5cbiAgYXN5bmMgZ2V0RmlsZXMoKTogUHJvbWlzZTxEbUZpbGVSZWFkZXJbXT4ge1xuICAgIGNvbnN0IHJlYWRzID0gYXdhaXQgTmV1dHJhbGluby5maWxlc3lzdGVtLnJlYWREaXJlY3RvcnkoIHRoaXMucGF0aCApXG4gICAgcmV0dXJuIHJlYWRzLmZpbHRlcihyZWFkID0+ICFbJy4nLCcuLiddLmluY2x1ZGVzKHJlYWQuZW50cnkpICYmIHJlYWQudHlwZSAhPT0gJ0RJUkVDVE9SWScpXG4gICAgICAubWFwKHJlYWQgPT4gbmV3IE5ldXRyYWxpbm9EbUZpbGVSZWFkZXIodGhpcy5nZXRGdWxsUGF0aChyZWFkLmVudHJ5KSwgdGhpcykpXG4gIH1cblxuICBhc3luYyBjcmVhdGVEaXJlY3RvcnkoXG4gICAgbmV3UGF0aDogc3RyaW5nXG4gICk6IFByb21pc2U8TmV1dHJhbGlub0RpcmVjdG9yeU1hbmFnZXI+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgZnVsbFBhdGggPSBwYXRoLmpvaW4odGhpcy5wYXRoLCBjb252ZXJ0U2xhc2hlcyhuZXdQYXRoKSlcbiAgICAgIGF3YWl0IE5ldXRyYWxpbm8uZmlsZXN5c3RlbS5yZWFkRGlyZWN0b3J5KCBmdWxsUGF0aCApXG5cbiAgICAgIC8vIGl0IGV4aXN0cywganVzdCByZWFkIGl0XG4gICAgICByZXR1cm4gdGhpcy5nZXREaXJlY3RvcnkobmV3UGF0aClcbiAgICB9IGNhdGNoKCBlcnI6IGFueSApe1xuICAgICAgaWYgKCBlcnIuY29kZSA9PT0gJ05FX0ZTX05PUEFUSEUnICkge1xuICAgICAgICBjb25zdCBzcGxpdFBhdGggPSBjb252ZXJ0U2xhc2hlcyhuZXdQYXRoKS5zcGxpdCgnLycpXG4gICAgICAgIGxldCBwYXRoVG8gPSB0aGlzLnBhdGhcbiAgICAgICAgXG4gICAgICAgIHdoaWxlKCBzcGxpdFBhdGgubGVuZ3RoICkge1xuICAgICAgICAgIGNvbnN0IG5vd05hbWUgPSBzcGxpdFBhdGguc2hpZnQoKSBhcyBzdHJpbmdcbiAgICAgICAgICBwYXRoVG8gPSBwYXRoLmpvaW4ocGF0aFRvLCBub3dOYW1lKVxuICAgICAgICAgIGF3YWl0IE5ldXRyYWxpbm8uZmlsZXN5c3RlbS5jcmVhdGVEaXJlY3RvcnkocGF0aFRvKVxuICAgICAgICB9XG4gICAgXG4gICAgICAgIGNvbnN0IGZ1bGxQYXRoID0gcGF0aFRvIC8vIHBhdGguam9pbih0aGlzLnBhdGgsIG5ld1BhdGgpXG4gICAgICAgIHJldHVybiBuZXcgTmV1dHJhbGlub0RpcmVjdG9yeU1hbmFnZXIoIGZ1bGxQYXRoICkgICAgXG4gICAgICB9XG4gICAgICB0aHJvdyBlcnJcbiAgICB9XG4gIH1cblxuICBhc3luYyBnZXREaXJlY3RvcnkoXG4gICAgbmV3UGF0aDogc3RyaW5nLFxuICAgIG9wdGlvbnM/OiBGaWxlU3lzdGVtR2V0RGlyZWN0b3J5T3B0aW9uc1xuICApOiBQcm9taXNlPE5ldXRyYWxpbm9EaXJlY3RvcnlNYW5hZ2VyPiB7XG4gICAgaWYgKCAhbmV3UGF0aCApIHtcbiAgICAgIHJldHVybiB0aGlzXG4gICAgfVxuICAgIFxuICAgIGNvbnN0IHBhdGhUbyA9IHBhdGguam9pbih0aGlzLnBhdGgsIG5ld1BhdGgpXG4gICAgXG4gICAgdHJ5IHtcbiAgICAgIC8vIGVuc3VyZSBwYXRoIGV4aXN0c1xuICAgICAgYXdhaXQgTmV1dHJhbGluby5maWxlc3lzdGVtLnJlYWREaXJlY3RvcnkocGF0aFRvKVxuICAgICAgcmV0dXJuIG5ldyBOZXV0cmFsaW5vRGlyZWN0b3J5TWFuYWdlciggcGF0aFRvIClcbiAgICB9IGNhdGNoIChlcnI6IGFueSkge1xuICAgICAgaWYgKCBlcnIuY29kZSA9PT0gJ05FX0ZTX05PUEFUSEUnICYmIG9wdGlvbnM/LmNyZWF0ZSApIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlRGlyZWN0b3J5KG5ld1BhdGgpXG4gICAgICB9XG4gICAgICB0aHJvdyBlcnIgLy8gcmV0aHJvd1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGZpbmRGaWxlQnlQYXRoIChcbiAgICBwYXRoOiBzdHJpbmcsXG4gICk6IFByb21pc2U8TmV1dHJhbGlub0RtRmlsZVJlYWRlciB8IHVuZGVmaW5lZD4ge1xuICAgIGNvbnN0IHBhdGhTcGxpdCA9IHBhdGguc3BsaXQoL1xcXFx8XFwvLylcbiAgICBjb25zdCBmaWxlTmFtZSA9IChwYXRoU3BsaXQucG9wKCkgYXMgc3RyaW5nKS50b0xvd2VyQ2FzZSgpIC8vIHBhdGhTcGxpdFsgcGF0aFNwbGl0Lmxlbmd0aC0xIF1cbiAgICBsZXQgZGlyOiBOZXV0cmFsaW5vRGlyZWN0b3J5TWFuYWdlciA9IHRoaXNcblxuICAgIC8vIGNocm9tZSB3ZSBkaWcgdGhyb3VnaCB0aGUgZmlyc3Qgc2VsZWN0ZWQgZGlyZWN0b3J5IGFuZCBzZWFyY2ggdGhlIHN1YnNcbiAgICBpZiAoIHBhdGhTcGxpdC5sZW5ndGggKSB7XG4gICAgICBjb25zdCBmaW5kRGlyID0gYXdhaXQgdGhpcy5maW5kRGlyZWN0b3J5KCBwYXRoU3BsaXQuam9pbignLycpIClcbiAgICAgIFxuICAgICAgaWYgKCAhZmluZERpciApIHtcbiAgICAgICAgcmV0dXJuXG4gICAgICB9XG4gICAgICBcbiAgICAgIGRpciA9IGZpbmREaXJcbiAgICB9XG4gICAgXG4gICAgY29uc3QgZmlsZXMgPSBhd2FpdCBkaXIubGlzdEZpbGVzKClcbiAgICBjb25zdCBtYXRjaE5hbWUgPSBmaWxlcy5maW5kKGxpc3ROYW1lID0+IGxpc3ROYW1lLnRvTG93ZXJDYXNlKCkgPT09IGZpbGVOYW1lKVxuICAgIGlmICggIW1hdGNoTmFtZSApIHtcbiAgICAgIHJldHVyblxuICAgIH1cblxuICAgIGNvbnN0IGZ1bGxQYXRoID0gZGlyLmdldEZ1bGxQYXRoKG1hdGNoTmFtZSlcbiAgICByZXR1cm4gbmV3IE5ldXRyYWxpbm9EbUZpbGVSZWFkZXIoZnVsbFBhdGgsIGRpcilcbiAgfVxuXG4gIGFzeW5jIGZpbGUoXG4gICAgcGF0aFRvOiBzdHJpbmcsXG4gICAgb3B0aW9ucz86IEZpbGVTeXN0ZW1HZXRGaWxlT3B0aW9uc1xuICApIHtcbiAgICBjb25zdCBleGlzdGluZ0ZpbGUgPSBhd2FpdCB0aGlzLmZpbmRGaWxlQnlQYXRoKHBhdGhUbylcblxuICAgIGlmICggZXhpc3RpbmdGaWxlICkge1xuICAgICAgcmV0dXJuIGV4aXN0aW5nRmlsZVxuICAgIH1cblxuICAgIGNvbnN0IGRpck9wdGlvbnMgPSB7IGNyZWF0ZTogb3B0aW9ucz8uY3JlYXRlIH1cbiAgICBjb25zdCBkaXIgPSBhd2FpdCBnZXREaXJGb3JGaWxlUGF0aChwYXRoVG8sIHRoaXMsIGRpck9wdGlvbnMpIGFzIE5ldXRyYWxpbm9EaXJlY3RvcnlNYW5hZ2VyXG4gICAgY29uc3QgZmlsZU5hbWUgPSBwYXRoVG8uc3BsaXQoL1xcXFx8XFwvLykucG9wKCkgYXMgc3RyaW5nXG4gICAgY29uc3QgZnVsbFBhdGggPSBwYXRoLmpvaW4oZGlyLnBhdGgsIGZpbGVOYW1lKVxuXG4gICAgcmV0dXJuIG5ldyBOZXV0cmFsaW5vRG1GaWxlUmVhZGVyKGZ1bGxQYXRoLCBkaXIpXG4gIH1cblxuICBnZXRGdWxsUGF0aChpdGVtUGF0aDogc3RyaW5nKSB7XG4gICAgbGV0IGZ1bGxGaWxlUGF0aCA9IHBhdGguam9pbih0aGlzLnBhdGgsIGl0ZW1QYXRoKVxuICAgIHJldHVybiBjb252ZXJ0U2xhc2hlcyhmdWxsRmlsZVBhdGgpXG4gIH1cblxuICBhc3luYyByZW5hbWVGaWxlKFxuICAgIG9sZEZpbGVOYW1lOiBzdHJpbmcsXG4gICAgbmV3RmlsZU5hbWU6IHN0cmluZ1xuICApIHtcbiAgICByZXR1cm4gcmVuYW1lRmlsZUluRGlyKG9sZEZpbGVOYW1lLCBuZXdGaWxlTmFtZSwgdGhpcylcbiAgfVxuXG4gIGFzeW5jIHJlbW92ZUVudHJ5KFxuICAgIG5hbWU6IHN0cmluZyxcbiAgICBvcHRpb25zPzogeyByZWN1cnNpdmU6IGJvb2xlYW4gfVxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBzcGxpdCA9IG5hbWUuc3BsaXQoL1xcXFx8XFwvLylcbiAgICBjb25zdCBsYXN0TmFtZSA9IHNwbGl0LnBvcCgpIGFzIHN0cmluZyAvLyByZW1vdmUgbGFzdCBpdGVtXG4gICAgY29uc3QgZGlyID0gc3BsaXQubGVuZ3RoID49IDEgPyBhd2FpdCB0aGlzLmdldERpcmVjdG9yeSggc3BsaXQuam9pbignLycpICkgOiB0aGlzXG5cbiAgICBjb25zdCBwYXRoVG8gPSBwYXRoLmpvaW4oZGlyLnBhdGgsIGxhc3ROYW1lKVxuICAgIFxuICAgIGNvbnN0IGZpbGVOYW1lcyA9IGF3YWl0IGRpci5saXN0RmlsZXMoKVxuICAgIGlmICggZmlsZU5hbWVzLmluY2x1ZGVzKGxhc3ROYW1lKSApIHtcbiAgICAgIHJldHVybiBOZXV0cmFsaW5vLmZpbGVzeXN0ZW0ucmVtb3ZlRmlsZShwYXRoVG8pXG4gICAgfVxuICAgICAgICBcbiAgICB0cnkge1xuICAgICAgYXdhaXQgTmV1dHJhbGluby5maWxlc3lzdGVtLnJlbW92ZURpcmVjdG9yeShwYXRoVG8pXG4gICAgfSBjYXRjaCAoZXJyOiBhbnkpIHtcbiAgICAgIC8vIGlmIGZvbGRlciBkZWxldGUgZmFpbGVkLCBpdCBtYXkgaGF2ZSBpdGVtcyB3aXRoaW4gTmV1dHJhbGlubyBkb2VzIG5vdCBoYXZlIHJlY3Vyc2l2ZSBkZWxldGVcbiAgICAgIGlmICggZXJyLmNvZGUgPT09ICdORV9GU19STURJUkVSJyAmJiBvcHRpb25zPy5yZWN1cnNpdmUgKSB7XG4gICAgICAgIHJldHVybiByZWN1cnNlUmVtb3ZlRGlyKCBhd2FpdCBkaXIuZ2V0RGlyZWN0b3J5KGxhc3ROYW1lKSApXG4gICAgICB9XG4gICAgICB0aHJvdyBlcnJcbiAgICB9XG4gICAgcmV0dXJuXG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gcmVjdXJzZVJlbW92ZURpcihcbiAgZGlyOiBOZXV0cmFsaW5vRGlyZWN0b3J5TWFuYWdlclxuKSB7XG4gIC8vIHJlbW92ZSBhbGwgZm9sZGVycyB3aXRoaW5cbiAgY29uc3QgZm9sZGVycyA9IGF3YWl0IGRpci5nZXRGb2xkZXJzKClcbiAgZm9yIChjb25zdCBzdWJkaXIgb2YgZm9sZGVycykge1xuICAgIGF3YWl0IHJlY3Vyc2VSZW1vdmVEaXIoc3ViZGlyKVxuICB9XG5cbiAgLy8gcmVtb3ZlIGFsbCBmaWxlcyB3aXRoaW5cbiAgY29uc3QgbGlzdCA9IGF3YWl0IGRpci5saXN0RmlsZXMoKVxuICBmb3IgKGNvbnN0IGZpbGVOYW1lIG9mIGxpc3QpIHtcbiAgICBhd2FpdCBkaXIucmVtb3ZlRW50cnkoZmlsZU5hbWUpXG4gIH1cblxuICAvLyB0cnkgbm93IHRvIGRlbGV0ZSBhZ2FpblxuICByZXR1cm4gTmV1dHJhbGluby5maWxlc3lzdGVtLnJlbW92ZURpcmVjdG9yeSggZGlyLnBhdGggKVxufSJdfQ==