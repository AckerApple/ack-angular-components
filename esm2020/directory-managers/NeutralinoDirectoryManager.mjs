import { convertSlashes } from "./convertSlashes";
import { BaseDmFileReader, findDirectoryWithin, getNameByPath, renameFileInDir } from "./DirectoryManagers";
import { path } from "./path";
const fs = typeof Neutralino === 'object' ? Neutralino.filesystem : {};
export class NeutralinoDmFileReader extends BaseDmFileReader {
    constructor(filePath, directory) {
        super();
        this.filePath = filePath;
        this.directory = directory;
        this.name = filePath.split(/\\|\//).pop();
    }
    async stats() {
        const stats = await fs.getStats(this.filePath);
        stats.name = stats.name || this.name;
        return stats;
    }
    readAsText() {
        return fs.readFile(this.filePath); // .toString()
    }
    async readAsDataURL() {
        let data = await fs.readBinaryFile(this.filePath);
        const view = new Uint8Array(data);
        var decoder = new TextDecoder('utf8');
        var b64encoded = btoa(decoder.decode(view));
        return b64encoded;
    }
    async write(fileString) {
        return fs.writeFile(this.filePath, fileString);
    }
}
export class NeutralinoDirectoryManager {
    constructor(path) {
        this.path = path;
        this.name = getNameByPath(path);
    }
    findDirectory(path, options) {
        return findDirectoryWithin(path, this, options);
    }
    async list() {
        const reads = await Neutralino.filesystem.readDirectory(this.path);
        return reads.filter(read => !['.', '..'].includes(read.entry)).map(read => read.entry);
    }
    async listFolders() {
        const reads = await Neutralino.filesystem.readDirectory(this.path);
        return reads.filter(read => !['.', '..'].includes(read.entry) && read.type === 'DIRECTORY')
            .map(read => read.entry);
    }
    async listFiles() {
        const reads = await Neutralino.filesystem.readDirectory(this.path);
        return reads.filter(read => !['.', '..'].includes(read.entry) && read.type !== 'DIRECTORY')
            .map(read => read.entry);
    }
    async getFolders() {
        return Promise.all((await this.listFolders()).map(async (name) => await this.getDirectory(name)));
    }
    async getFiles() {
        const reads = await Neutralino.filesystem.readDirectory(this.path);
        return reads.filter(read => !['.', '..'].includes(read.entry) && read.type !== 'DIRECTORY')
            .map(read => new NeutralinoDmFileReader(this.getFullPath(read.entry), this));
    }
    async createDirectory(newPath) {
        const pathTo = path.join(this.path, newPath);
        await Neutralino.filesystem.createDirectory(pathTo);
        return this.getDirectory(newPath);
    }
    async getDirectory(newPath) {
        if (!newPath) {
            return this;
        }
        const pathTo = path.join(this.path, newPath);
        // ensure path exists
        await Neutralino.filesystem.readDirectory(pathTo);
        return new NeutralinoDirectoryManager(pathTo);
    }
    async findFileByPath(filePath) {
        const fullFilePath = this.getFullPath(filePath);
        return new NeutralinoDmFileReader(fullFilePath, this);
    }
    file(fileName, _options) {
        return this.findFileByPath(fileName);
    }
    getFullPath(itemPath) {
        let fullFilePath = path.join(this.path, itemPath);
        return convertSlashes(fullFilePath);
    }
    async renameFile(oldFileName, newFileName) {
        return renameFileInDir(oldFileName, newFileName, this);
    }
    async removeEntry(name) {
        const split = name.split(/\\|\//);
        const lastName = split.pop(); // remove last item
        const dir = split.length >= 1 ? await this.getDirectory(split.join('/')) : this;
        const pathTo = path.join(dir.path, name);
        const fileNames = await dir.listFiles();
        if (fileNames.includes(lastName)) {
            return Neutralino.filesystem.removeFile(pathTo);
        }
        await Neutralino.filesystem.removeDirectory(pathTo);
        return;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTmV1dHJhbGlub0RpcmVjdG9yeU1hbmFnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvZGlyZWN0b3J5LW1hbmFnZXJzL05ldXRyYWxpbm9EaXJlY3RvcnlNYW5hZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQTtBQUNqRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQWtDLG1CQUFtQixFQUFFLGFBQWEsRUFBRSxlQUFlLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQTtBQUMzSSxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sUUFBUSxDQUFBO0FBa0I3QixNQUFNLEVBQUUsR0FBRyxPQUFPLFVBQVUsS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLEVBQW1CLENBQUE7QUFFdkYsTUFBTSxPQUFPLHNCQUF1QixTQUFRLGdCQUFnQjtJQUcxRCxZQUNTLFFBQWdCLEVBQ2hCLFNBQXFDO1FBRTVDLEtBQUssRUFBRSxDQUFBO1FBSEEsYUFBUSxHQUFSLFFBQVEsQ0FBUTtRQUNoQixjQUFTLEdBQVQsU0FBUyxDQUE0QjtRQUc1QyxJQUFJLENBQUMsSUFBSSxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBRyxFQUFZLENBQUE7SUFDckQsQ0FBQztJQUVELEtBQUssQ0FBQyxLQUFLO1FBQ1QsTUFBTSxLQUFLLEdBQUcsTUFBTSxFQUFFLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQTtRQUM5QyxLQUFLLENBQUMsSUFBSSxHQUFHLEtBQUssQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQTtRQUNwQyxPQUFPLEtBQUssQ0FBQTtJQUNkLENBQUM7SUFFUSxVQUFVO1FBQ2pCLE9BQU8sRUFBRSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENB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QVEsQ0FBQyxRQUFRLENBQUMsRUFBRztZQUNsQyxPQUFPLFVBQVUsQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1NBQ2hEO1FBRUQsTUFBTSxVQUFVLENBQUMsVUFBVSxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsQ0FBQTtRQUNuRCxPQUFNO0lBQ1IsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgY29udmVydFNsYXNoZXMgfSBmcm9tIFwiLi9jb252ZXJ0U2xhc2hlc1wiXG5pbXBvcnQgeyBCYXNlRG1GaWxlUmVhZGVyLCBEaXJlY3RvcnlNYW5hZ2VyLCBEbUZpbGVSZWFkZXIsIGZpbmREaXJlY3RvcnlXaXRoaW4sIGdldE5hbWVCeVBhdGgsIHJlbmFtZUZpbGVJbkRpciB9IGZyb20gXCIuL0RpcmVjdG9yeU1hbmFnZXJzXCJcbmltcG9ydCB7IHBhdGggfSBmcm9tIFwiLi9wYXRoXCJcblxuaW50ZXJmYWNlIElOZXV0cmFsaW5vIHtcbiAgZmlsZXN5c3RlbTogSU5ldXRyYWxpbm9Gc1xufVxuaW50ZXJmYWNlIElOZXV0cmFsaW5vRnMge1xuICBnZXRTdGF0czogKHBhdGg6IHN0cmluZykgPT4gYW55XG4gIHJlYWRGaWxlOiAocGF0aDogc3RyaW5nKSA9PiBhbnlcbiAgcmVhZEJpbmFyeUZpbGU6IChwYXRoOiBzdHJpbmcpID0+IGFueVxuICB3cml0ZUZpbGU6IChwYXRoOiBzdHJpbmcsIGRhdGE6IHN0cmluZykgPT4gYW55XG4gIHJlbW92ZUZpbGU6IChwYXRoOiBzdHJpbmcpID0+IGFueVxuICByZW1vdmVEaXJlY3Rvcnk6IChwYXRoOiBzdHJpbmcpID0+IGFueVxuICBcbiAgY3JlYXRlRGlyZWN0b3J5OiAocGF0aDogc3RyaW5nKSA9PiBQcm9taXNlPHtlbnRyeTogJ0ZJTEUnIHwgJ0RJUkVDVE9SWScsIHR5cGU6IHN0cmluZ31bXT5cbiAgcmVhZERpcmVjdG9yeTogKHBhdGg6IHN0cmluZykgPT4gUHJvbWlzZTx7ZW50cnk6ICdGSUxFJyB8ICdESVJFQ1RPUlknLCB0eXBlOiBzdHJpbmd9W10+XG59XG5cbmRlY2xhcmUgY29uc3QgTmV1dHJhbGlubzogSU5ldXRyYWxpbm9cbmNvbnN0IGZzID0gdHlwZW9mIE5ldXRyYWxpbm8gPT09ICdvYmplY3QnID8gTmV1dHJhbGluby5maWxlc3lzdGVtIDoge30gYXMgSU5ldXRyYWxpbm9Gc1xuXG5leHBvcnQgY2xhc3MgTmV1dHJhbGlub0RtRmlsZVJlYWRlciBleHRlbmRzIEJhc2VEbUZpbGVSZWFkZXIgaW1wbGVtZW50cyBEbUZpbGVSZWFkZXIge1xuICBuYW1lOiBzdHJpbmdcbiAgXG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyBmaWxlUGF0aDogc3RyaW5nLFxuICAgIHB1YmxpYyBkaXJlY3Rvcnk6IE5ldXRyYWxpbm9EaXJlY3RvcnlNYW5hZ2VyLFxuICApIHtcbiAgICBzdXBlcigpXG4gICAgdGhpcy5uYW1lID0gZmlsZVBhdGguc3BsaXQoL1xcXFx8XFwvLykucG9wKCkgYXMgc3RyaW5nXG4gIH1cblxuICBhc3luYyBzdGF0cygpIHtcbiAgICBjb25zdCBzdGF0cyA9IGF3YWl0IGZzLmdldFN0YXRzKHRoaXMuZmlsZVBhdGgpXG4gICAgc3RhdHMubmFtZSA9IHN0YXRzLm5hbWUgfHwgdGhpcy5uYW1lXG4gICAgcmV0dXJuIHN0YXRzXG4gIH1cblxuICBvdmVycmlkZSByZWFkQXNUZXh0KCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgcmV0dXJuIGZzLnJlYWRGaWxlKHRoaXMuZmlsZVBhdGgpIC8vIC50b1N0cmluZygpXG4gIH1cbiAgXG4gIGFzeW5jIHJlYWRBc0RhdGFVUkwoKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBsZXQgZGF0YSA9IGF3YWl0IGZzLnJlYWRCaW5hcnlGaWxlKHRoaXMuZmlsZVBhdGgpXG4gICAgY29uc3QgdmlldyA9IG5ldyBVaW50OEFycmF5KGRhdGEpO1xuICAgIHZhciBkZWNvZGVyID0gbmV3IFRleHREZWNvZGVyKCd1dGY4Jyk7XG4gICAgdmFyIGI2NGVuY29kZWQgPSBidG9hKGRlY29kZXIuZGVjb2RlKHZpZXcpKVxuICAgIHJldHVybiBiNjRlbmNvZGVkXG4gIH1cblxuICBhc3luYyB3cml0ZShmaWxlU3RyaW5nOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gZnMud3JpdGVGaWxlKHRoaXMuZmlsZVBhdGgsIGZpbGVTdHJpbmcpXG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIE5ldXRyYWxpbm9EaXJlY3RvcnlNYW5hZ2VyIGltcGxlbWVudHMgRGlyZWN0b3J5TWFuYWdlciB7XG4gIG5hbWU6IHN0cmluZ1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyBwYXRoOiBzdHJpbmcsXG4gICkge1xuICAgIHRoaXMubmFtZSA9IGdldE5hbWVCeVBhdGgocGF0aClcbiAgfVxuXG4gIGZpbmREaXJlY3RvcnkgKFxuICAgIHBhdGg6IHN0cmluZyxcbiAgICBvcHRpb25zPzogRmlsZVN5c3RlbUdldERpcmVjdG9yeU9wdGlvbnMsXG4gICk6IFByb21pc2U8RGlyZWN0b3J5TWFuYWdlciB8IHVuZGVmaW5lZD4ge1xuICAgIHJldHVybiBmaW5kRGlyZWN0b3J5V2l0aGluKHBhdGgsIHRoaXMsIG9wdGlvbnMpXG4gIH1cblxuICBhc3luYyBsaXN0KCk6IFByb21pc2U8c3RyaW5nW10+IHtcbiAgICBjb25zdCByZWFkcyA9IGF3YWl0IE5ldXRyYWxpbm8uZmlsZXN5c3RlbS5yZWFkRGlyZWN0b3J5KCB0aGlzLnBhdGggKVxuICAgIHJldHVybiByZWFkcy5maWx0ZXIocmVhZCA9PiAhWycuJywnLi4nXS5pbmNsdWRlcyhyZWFkLmVudHJ5KSkubWFwKHJlYWQgPT4gcmVhZC5lbnRyeSlcbiAgfVxuXG4gIGFzeW5jIGxpc3RGb2xkZXJzKCk6IFByb21pc2U8c3RyaW5nW10+IHtcbiAgICBjb25zdCByZWFkcyA9IGF3YWl0IE5ldXRyYWxpbm8uZmlsZXN5c3RlbS5yZWFkRGlyZWN0b3J5KCB0aGlzLnBhdGggKVxuICAgIHJldHVybiByZWFkcy5maWx0ZXIocmVhZCA9PiAhWycuJywnLi4nXS5pbmNsdWRlcyhyZWFkLmVudHJ5KSAmJiByZWFkLnR5cGUgPT09ICdESVJFQ1RPUlknKVxuICAgICAgLm1hcChyZWFkID0+IHJlYWQuZW50cnkpXG4gIH1cblxuICBhc3luYyBsaXN0RmlsZXMoKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIGNvbnN0IHJlYWRzID0gYXdhaXQgTmV1dHJhbGluby5maWxlc3lzdGVtLnJlYWREaXJlY3RvcnkoIHRoaXMucGF0aCApXG4gICAgcmV0dXJuIHJlYWRzLmZpbHRlcihyZWFkID0+ICFbJy4nLCcuLiddLmluY2x1ZGVzKHJlYWQuZW50cnkpICYmIHJlYWQudHlwZSAhPT0gJ0RJUkVDVE9SWScpXG4gICAgICAubWFwKHJlYWQgPT4gcmVhZC5lbnRyeSlcbiAgfVxuXG4gIGFzeW5jIGdldEZvbGRlcnMoKTogUHJvbWlzZTxOZXV0cmFsaW5vRGlyZWN0b3J5TWFuYWdlcltdPiB7XG4gICAgcmV0dXJuIFByb21pc2UuYWxsKFxuICAgICAgKGF3YWl0IHRoaXMubGlzdEZvbGRlcnMoKSkubWFwKGFzeW5jIG5hbWUgPT4gYXdhaXQgdGhpcy5nZXREaXJlY3RvcnkobmFtZSkpXG4gICAgKVxuICB9XG5cbiAgYXN5bmMgZ2V0RmlsZXMoKTogUHJvbWlzZTxEbUZpbGVSZWFkZXJbXT4ge1xuICAgIGNvbnN0IHJlYWRzID0gYXdhaXQgTmV1dHJhbGluby5maWxlc3lzdGVtLnJlYWREaXJlY3RvcnkoIHRoaXMucGF0aCApXG4gICAgcmV0dXJuIHJlYWRzLmZpbHRlcihyZWFkID0+ICFbJy4nLCcuLiddLmluY2x1ZGVzKHJlYWQuZW50cnkpICYmIHJlYWQudHlwZSAhPT0gJ0RJUkVDVE9SWScpXG4gICAgICAubWFwKHJlYWQgPT4gbmV3IE5ldXRyYWxpbm9EbUZpbGVSZWFkZXIodGhpcy5nZXRGdWxsUGF0aChyZWFkLmVudHJ5KSwgdGhpcykpXG4gIH1cblxuICBhc3luYyBjcmVhdGVEaXJlY3RvcnkobmV3UGF0aDogc3RyaW5nKTogUHJvbWlzZTxEaXJlY3RvcnlNYW5hZ2VyPiB7XG4gICAgY29uc3QgcGF0aFRvID0gcGF0aC5qb2luKHRoaXMucGF0aCwgbmV3UGF0aClcbiAgICBhd2FpdCBOZXV0cmFsaW5vLmZpbGVzeXN0ZW0uY3JlYXRlRGlyZWN0b3J5KHBhdGhUbylcbiAgICByZXR1cm4gdGhpcy5nZXREaXJlY3RvcnkobmV3UGF0aClcbiAgfVxuXG4gIGFzeW5jIGdldERpcmVjdG9yeShuZXdQYXRoOiBzdHJpbmcpIHtcbiAgICBpZiAoICFuZXdQYXRoICkge1xuICAgICAgcmV0dXJuIHRoaXNcbiAgICB9XG4gICAgXG4gICAgY29uc3QgcGF0aFRvID0gcGF0aC5qb2luKHRoaXMucGF0aCwgbmV3UGF0aClcbiAgICBcbiAgICAvLyBlbnN1cmUgcGF0aCBleGlzdHNcbiAgICBhd2FpdCBOZXV0cmFsaW5vLmZpbGVzeXN0ZW0ucmVhZERpcmVjdG9yeShwYXRoVG8pXG4gICAgXG4gICAgcmV0dXJuIG5ldyBOZXV0cmFsaW5vRGlyZWN0b3J5TWFuYWdlciggcGF0aFRvIClcbiAgfVxuXG4gIGFzeW5jIGZpbmRGaWxlQnlQYXRoIChcbiAgICBmaWxlUGF0aDogc3RyaW5nLFxuICApOiBQcm9taXNlPE5ldXRyYWxpbm9EbUZpbGVSZWFkZXI+IHtcbiAgICBjb25zdCBmdWxsRmlsZVBhdGggPSB0aGlzLmdldEZ1bGxQYXRoKGZpbGVQYXRoKVxuICAgIHJldHVybiBuZXcgTmV1dHJhbGlub0RtRmlsZVJlYWRlcihmdWxsRmlsZVBhdGgsIHRoaXMpXG4gIH1cblxuICBmaWxlKGZpbGVOYW1lOiBzdHJpbmcsIF9vcHRpb25zPzogRmlsZVN5c3RlbUdldEZpbGVPcHRpb25zKSB7XG4gICAgcmV0dXJuIHRoaXMuZmluZEZpbGVCeVBhdGgoZmlsZU5hbWUpXG4gIH1cblxuICBnZXRGdWxsUGF0aChpdGVtUGF0aDogc3RyaW5nKSB7XG4gICAgbGV0IGZ1bGxGaWxlUGF0aCA9IHBhdGguam9pbih0aGlzLnBhdGgsIGl0ZW1QYXRoKVxuICAgIHJldHVybiBjb252ZXJ0U2xhc2hlcyhmdWxsRmlsZVBhdGgpXG4gIH1cblxuICBhc3luYyByZW5hbWVGaWxlKFxuICAgIG9sZEZpbGVOYW1lOiBzdHJpbmcsXG4gICAgbmV3RmlsZU5hbWU6IHN0cmluZ1xuICApIHtcbiAgICByZXR1cm4gcmVuYW1lRmlsZUluRGlyKG9sZEZpbGVOYW1lLCBuZXdGaWxlTmFtZSwgdGhpcylcbiAgfVxuXG4gIGFzeW5jIHJlbW92ZUVudHJ5KFxuICAgIG5hbWU6IHN0cmluZyxcbiAgICAvLyBvcHRpb25zPzogeyByZWN1cnNpdmU6IGJvb2xlYW4gfVxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBzcGxpdCA9IG5hbWUuc3BsaXQoL1xcXFx8XFwvLylcbiAgICBjb25zdCBsYXN0TmFtZSA9IHNwbGl0LnBvcCgpIGFzIHN0cmluZyAvLyByZW1vdmUgbGFzdCBpdGVtXG4gICAgY29uc3QgZGlyID0gc3BsaXQubGVuZ3RoID49IDEgPyBhd2FpdCB0aGlzLmdldERpcmVjdG9yeSggc3BsaXQuam9pbignLycpICkgOiB0aGlzXG5cbiAgICBjb25zdCBwYXRoVG8gPSBwYXRoLmpvaW4oZGlyLnBhdGgsIG5hbWUpXG4gICAgXG4gICAgY29uc3QgZmlsZU5hbWVzID0gYXdhaXQgZGlyLmxpc3RGaWxlcygpXG4gICAgaWYgKCBmaWxlTmFtZXMuaW5jbHVkZXMobGFzdE5hbWUpICkge1xuICAgICAgcmV0dXJuIE5ldXRyYWxpbm8uZmlsZXN5c3RlbS5yZW1vdmVGaWxlKHBhdGhUbylcbiAgICB9XG4gICAgXG4gICAgYXdhaXQgTmV1dHJhbGluby5maWxlc3lzdGVtLnJlbW92ZURpcmVjdG9yeShwYXRoVG8pXG4gICAgcmV0dXJuXG4gIH1cbn1cbiJdfQ==