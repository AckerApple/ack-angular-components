import { BrowserDmFileReader, getNameByPath } from "./BrowserDirectoryManagers";
import { path } from "./path";
export class SafariDirectoryManager {
    constructor(path = '', files) {
        this.path = path;
        this.files = files;
        this.name = getNameByPath(path);
    }
    async getDirectory(path) {
        // safari gives you all items up front
        const nextItems = this.files.filter(file => {
            const relative = getWebkitPathRelativeTo(file, this.path);
            return relative.substring(0, path.length).toLowerCase() === path.toLowerCase();
        });
        return new SafariDirectoryManager(path, nextItems);
    }
    getRelativeItems() {
        return this.files.filter(file => {
            const relative = getWebkitPathRelativeTo(file, this.path);
            return relative.split('/').length === 1; // lives within same directory
        });
    }
    async list() {
        return this.getRelativeItems().map(file => file.name);
    }
    async listFolders() {
        return this.getRelativeItems()
            .filter(file => file.name.split('.').length === 1)
            .map(file => file.name);
    }
    async listFiles() {
        return this.getRelativeItems().map(file => file.name);
    }
    async getFolders() {
        return Promise.all((await this.listFolders()).map(async (name) => await this.getDirectory(name)));
    }
    async getFiles() {
        return this.getRelativeItems().map(file => new BrowserDmFileReader(file, this));
    }
    async findFileByPath(filePath) {
        if (!this.files.length) {
            return;
        }
        // safari include the parent folder name so we need to prepend it to the file search
        const rootName = this.files[0].webkitRelativePath.split('/').shift();
        filePath = path.join(rootName, this.path, filePath);
        // safari just gives us every files upfront, find within that (huge) array
        const file = this.files.find(file => file.webkitRelativePath === filePath);
        return file ? new BrowserDmFileReader(file, this) : undefined;
    }
    async file(fileName, _options) {
        const findFile = await this.findFileByPath(fileName);
        if (findFile) {
            return findFile;
        }
        const superFile = new BrowserDmFileReader(new File([], fileName), this);
        return Promise.resolve(superFile);
    }
}
function getWebkitPathRelativeTo(file, path) {
    const relativeSplit = file.webkitRelativePath.split('/');
    relativeSplit.shift(); // remove the first notation on safari results
    if (path !== '') {
        let splitCount = path.split('/').length;
        while (splitCount) {
            relativeSplit.shift(); // remove starting notations on safari results
            --splitCount;
        }
    }
    return relativeSplit.join('/');
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2FmYXJpRGlyZWN0b3J5TWFuYWdlcnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvZGlyZWN0b3J5LW1hbmFnZXJzL1NhZmFyaURpcmVjdG9yeU1hbmFnZXJzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxhQUFhLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQTtBQUMvRSxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sUUFBUSxDQUFBO0FBRTdCLE1BQU0sT0FBTyxzQkFBc0I7SUFHakMsWUFDUyxPQUFlLEVBQUUsRUFDakIsS0FBYTtRQURiLFNBQUksR0FBSixJQUFJLENBQWE7UUFDakIsVUFBSyxHQUFMLEtBQUssQ0FBUTtRQUVwQixJQUFJLENBQUMsSUFBSSxHQUFHLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUNqQyxDQUFDO0lBRUQsS0FBSyxDQUFDLFlBQVksQ0FBQyxJQUFZO1FBQzdCLHNDQUFzQztRQUN0QyxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUN6QyxNQUFNLFFBQVEsR0FBRyx1QkFBdUIsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO1lBQ3pELE9BQU8sUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLFdBQVcsRUFBRSxLQUFLLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQTtRQUNoRixDQUFDLENBQUMsQ0FBQTtRQUNGLE9BQU8sSUFBSSxzQkFBc0IsQ0FBQyxJQUFJLEVBQUUsU0FBUyxDQUFDLENBQUE7SUFDcEQsQ0FBQztJQUVELGdCQUFnQjtRQUNkLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDOUIsTUFBTSxRQUFRLEdBQUcsdUJBQXVCLENBQUMsSUFBSSxFQUFF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QUFZO0lBQ3ZELE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUE7SUFDeEQsYUFBYSxDQUFDLEtBQUssRUFBRSxDQUFBLENBQUMsOENBQThDO0lBQ3BFLElBQUssSUFBSSxLQUFLLEVBQUUsRUFBRztRQUNqQixJQUFJLFVBQVUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQTtRQUN2QyxPQUFPLFVBQVUsRUFBRTtZQUNqQixhQUFhLENBQUMsS0FBSyxFQUFFLENBQUEsQ0FBQyw4Q0FBOEM7WUFDcEUsRUFBRSxVQUFVLENBQUE7U0FDYjtLQUNGO0lBQ0QsT0FBTyxhQUFhLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFBO0FBQ2hDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEaXJlY3RvcnlNYW5hZ2VyLCBEbUZpbGVSZWFkZXIgfSBmcm9tIFwiLi9EaXJlY3RvcnlNYW5hZ2Vyc1wiXG5pbXBvcnQgeyBCcm93c2VyRG1GaWxlUmVhZGVyLCBnZXROYW1lQnlQYXRoIH0gZnJvbSBcIi4vQnJvd3NlckRpcmVjdG9yeU1hbmFnZXJzXCJcbmltcG9ydCB7IHBhdGggfSBmcm9tIFwiLi9wYXRoXCJcblxuZXhwb3J0IGNsYXNzIFNhZmFyaURpcmVjdG9yeU1hbmFnZXIgaW1wbGVtZW50cyBEaXJlY3RvcnlNYW5hZ2VyIHtcbiAgbmFtZTogc3RyaW5nXG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHVibGljIHBhdGg6IHN0cmluZyA9ICcnLFxuICAgIHB1YmxpYyBmaWxlczogRmlsZVtdLFxuICApIHtcbiAgICB0aGlzLm5hbWUgPSBnZXROYW1lQnlQYXRoKHBhdGgpXG4gIH1cblxuICBhc3luYyBnZXREaXJlY3RvcnkocGF0aDogc3RyaW5nKSB7XG4gICAgLy8gc2FmYXJpIGdpdmVzIHlvdSBhbGwgaXRlbXMgdXAgZnJvbnRcbiAgICBjb25zdCBuZXh0SXRlbXMgPSB0aGlzLmZpbGVzLmZpbHRlcihmaWxlID0+IHtcbiAgICAgIGNvbnN0IHJlbGF0aXZlID0gZ2V0V2Via2l0UGF0aFJlbGF0aXZlVG8oZmlsZSwgdGhpcy5wYXRoKVxuICAgICAgcmV0dXJuIHJlbGF0aXZlLnN1YnN0cmluZygwLCBwYXRoLmxlbmd0aCkudG9Mb3dlckNhc2UoKSA9PT0gcGF0aC50b0xvd2VyQ2FzZSgpXG4gICAgfSlcbiAgICByZXR1cm4gbmV3IFNhZmFyaURpcmVjdG9yeU1hbmFnZXIocGF0aCwgbmV4dEl0ZW1zKVxuICB9XG5cbiAgZ2V0UmVsYXRpdmVJdGVtcygpIHtcbiAgICByZXR1cm4gdGhpcy5maWxlcy5maWx0ZXIoZmlsZSA9PiB7XG4gICAgICBjb25zdCByZWxhdGl2ZSA9IGdldFdlYmtpdFBhdGhSZWxhdGl2ZVRvKGZpbGUsIHRoaXMucGF0aClcbiAgICAgIHJldHVybiByZWxhdGl2ZS5zcGxpdCgnLycpLmxlbmd0aCA9PT0gMSAvLyBsaXZlcyB3aXRoaW4gc2FtZSBkaXJlY3RvcnlcbiAgICB9KVxuICB9XG5cbiAgYXN5bmMgbGlzdCgpOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0UmVsYXRpdmVJdGVtcygpLm1hcChmaWxlID0+IGZpbGUubmFtZSlcbiAgfVxuXG4gIGFzeW5jIGxpc3RGb2xkZXJzKCk6IFByb21pc2U8c3RyaW5nW10+IHtcbiAgICByZXR1cm4gdGhpcy5nZXRSZWxhdGl2ZUl0ZW1zKClcbiAgICAgIC5maWx0ZXIoZmlsZSA9PiBmaWxlLm5hbWUuc3BsaXQoJy4nKS5sZW5ndGggPT09IDEpXG4gICAgICAubWFwKGZpbGUgPT4gZmlsZS5uYW1lKVxuICB9XG5cbiAgYXN5bmMgbGlzdEZpbGVzKCk6IFByb21pc2U8c3RyaW5nW10+IHtcbiAgICByZXR1cm4gdGhpcy5nZXRSZWxhdGl2ZUl0ZW1zKCkubWFwKGZpbGUgPT4gZmlsZS5uYW1lKVxuICB9XG4gIFxuICBhc3luYyBnZXRGb2xkZXJzKCk6IFByb21pc2U8U2FmYXJpRGlyZWN0b3J5TWFuYWdlcltdPiB7XG4gICAgcmV0dXJuIFByb21pc2UuYWxsKFxuICAgICAgKGF3YWl0IHRoaXMubGlzdEZvbGRlcnMoKSkubWFwKGFzeW5jIG5hbWUgPT4gYXdhaXQgdGhpcy5nZXREaXJlY3RvcnkobmFtZSkpXG4gICAgKVxuICB9XG5cbiAgYXN5bmMgZ2V0RmlsZXMoKTogUHJvbWlzZTxEbUZpbGVSZWFkZXJbXT4ge1xuICAgIHJldHVybiB0aGlzLmdldFJlbGF0aXZlSXRlbXMoKS5tYXAoZmlsZSA9PiBuZXcgQnJvd3NlckRtRmlsZVJlYWRlcihmaWxlLCB0aGlzKSlcbiAgfVxuXG4gIGFzeW5jIGZpbmRGaWxlQnlQYXRoIChmaWxlUGF0aDogc3RyaW5nICk6IFByb21pc2U8QnJvd3NlckRtRmlsZVJlYWRlciB8IHVuZGVmaW5lZD4ge1xuICAgIGlmICggIXRoaXMuZmlsZXMubGVuZ3RoICkge1xuICAgICAgcmV0dXJuXG4gICAgfVxuXG4gICAgLy8gc2FmYXJpIGluY2x1ZGUgdGhlIHBhcmVudCBmb2xkZXIgbmFtZSBzbyB3ZSBuZWVkIHRvIHByZXBlbmQgaXQgdG8gdGhlIGZpbGUgc2VhcmNoXG4gICAgY29uc3Qgcm9vdE5hbWUgPSB0aGlzLmZpbGVzWzBdLndlYmtpdFJlbGF0aXZlUGF0aC5zcGxpdCgnLycpLnNoaWZ0KCkgYXMgc3RyaW5nXG4gICAgZmlsZVBhdGggPSBwYXRoLmpvaW4ocm9vdE5hbWUsIHRoaXMucGF0aCwgZmlsZVBhdGgpXG4gICAgXG4gICAgLy8gc2FmYXJpIGp1c3QgZ2l2ZXMgdXMgZXZlcnkgZmlsZXMgdXBmcm9udCwgZmluZCB3aXRoaW4gdGhhdCAoaHVnZSkgYXJyYXlcbiAgICBjb25zdCBmaWxlID0gdGhpcy5maWxlcy5maW5kKGZpbGUgPT4gZmlsZS53ZWJraXRSZWxhdGl2ZVBhdGggPT09IGZpbGVQYXRoKSBhcyBGaWxlIHwgdW5kZWZpbmVkXG4gICAgcmV0dXJuIGZpbGUgPyBuZXcgQnJvd3NlckRtRmlsZVJlYWRlcihmaWxlLCB0aGlzKSA6IHVuZGVmaW5lZFxuICB9XG5cbiAgYXN5bmMgZmlsZShmaWxlTmFtZTogc3RyaW5nLCBfb3B0aW9ucz86IEZpbGVTeXN0ZW1HZXRGaWxlT3B0aW9ucykge1xuICAgIGNvbnN0IGZpbmRGaWxlID0gYXdhaXQgdGhpcy5maW5kRmlsZUJ5UGF0aChmaWxlTmFtZSlcblxuICAgIGlmICggZmluZEZpbGUgKSB7XG4gICAgICByZXR1cm4gZmluZEZpbGVcbiAgICB9XG5cbiAgICBjb25zdCBzdXBlckZpbGUgPSBuZXcgQnJvd3NlckRtRmlsZVJlYWRlcihuZXcgRmlsZShbXSwgZmlsZU5hbWUpLCB0aGlzKVxuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoc3VwZXJGaWxlKVxuICB9XG59XG5cbmZ1bmN0aW9uIGdldFdlYmtpdFBhdGhSZWxhdGl2ZVRvKGZpbGU6IEZpbGUsIHBhdGg6IHN0cmluZykge1xuICBjb25zdCByZWxhdGl2ZVNwbGl0ID0gZmlsZS53ZWJraXRSZWxhdGl2ZVBhdGguc3BsaXQoJy8nKVxuICByZWxhdGl2ZVNwbGl0LnNoaWZ0KCkgLy8gcmVtb3ZlIHRoZSBmaXJzdCBub3RhdGlvbiBvbiBzYWZhcmkgcmVzdWx0c1xuICBpZiAoIHBhdGggIT09ICcnICkge1xuICAgIGxldCBzcGxpdENvdW50ID0gcGF0aC5zcGxpdCgnLycpLmxlbmd0aFxuICAgIHdoaWxlIChzcGxpdENvdW50KSB7XG4gICAgICByZWxhdGl2ZVNwbGl0LnNoaWZ0KCkgLy8gcmVtb3ZlIHN0YXJ0aW5nIG5vdGF0aW9ucyBvbiBzYWZhcmkgcmVzdWx0c1xuICAgICAgLS1zcGxpdENvdW50XG4gICAgfVxuICB9XG4gIHJldHVybiByZWxhdGl2ZVNwbGl0LmpvaW4oJy8nKVxufSJdfQ==