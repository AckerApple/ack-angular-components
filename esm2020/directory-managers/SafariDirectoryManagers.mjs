import { BrowserDmFileReader } from "./BrowserDirectoryManagers";
import { path } from "./path";
export class SafariDirectoryManager {
    constructor(path = '', files) {
        this.path = path;
        this.files = files;
    }
    async getDirectory(path) {
        // safari gives you all items up front
        const nextItems = this.files.filter(file => {
            const relative = getWebkitPathRelativeTo(file, this.path);
            return relative.substring(0, path.length).toLowerCase() === path.toLowerCase();
        });
        return new SafariDirectoryManager(path, nextItems);
    }
    getRelativeItems() {
        return this.files.filter(file => {
            const relative = getWebkitPathRelativeTo(file, this.path);
            return relative.split('/').length === 1; // lives within same directory
        });
    }
    async list() {
        return this.getRelativeItems().map(file => file.name);
    }
    async listFolders() {
        return this.getRelativeItems()
            .filter(file => file.name.split('.').length === 1)
            .map(file => file.name);
    }
    async listFiles() {
        return this.getRelativeItems().map(file => new BrowserDmFileReader(file, this));
    }
    async findFileByPath(filePath) {
        if (!this.files.length) {
            return;
        }
        // safari include the parent folder name so we need to prepend it to the file search
        const rootName = this.files[0].webkitRelativePath.split('/').shift();
        filePath = path.join(rootName, this.path, filePath);
        // safari just gives us every files upfront, find within that (huge) array
        const file = this.files.find(file => file.webkitRelativePath === filePath);
        return file ? new BrowserDmFileReader(file, this) : undefined;
    }
    async file(fileName, _options) {
        const findFile = await this.findFileByPath(fileName);
        if (findFile) {
            return findFile;
        }
        const superFile = new BrowserDmFileReader(new File([], fileName), this);
        return Promise.resolve(superFile);
    }
}
function getWebkitPathRelativeTo(file, path) {
    const relativeSplit = file.webkitRelativePath.split('/');
    relativeSplit.shift(); // remove the first notation on safari results
    if (path !== '') {
        let splitCount = path.split('/').length;
        while (splitCount) {
            relativeSplit.shift(); // remove starting notations on safari results
            --splitCount;
        }
    }
    return relativeSplit.join('/');
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2FmYXJpRGlyZWN0b3J5TWFuYWdlcnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvZGlyZWN0b3J5LW1hbmFnZXJzL1NhZmFyaURpcmVjdG9yeU1hbmFnZXJzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLDRCQUE0QixDQUFBO0FBQ2hFLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxRQUFRLENBQUE7QUFFN0IsTUFBTSxPQUFPLHNCQUFzQjtJQUNqQyxZQUNTLE9BQWUsRUFBRSxFQUNqQixLQUFhO1FBRGIsU0FBSSxHQUFKLElBQUksQ0FBYTtRQUNqQixVQUFLLEdBQUwsS0FBSyxDQUFRO0lBQ25CLENBQUM7SUFFSixLQUFLLENBQUMsWUFBWSxDQUFDLElBQVk7UUFDN0Isc0NBQXNDO1FBQ3RDLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQ3pDLE1BQU0sUUFBUSxHQUFHLHVCQUF1QixDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7WUFDekQsT0FBTyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsV0FBVyxFQUFFLEtBQUssSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFBO1FBQ2hGLENBQUMsQ0FBQyxDQUFBO1FBQ0YsT0FBTyxJQUFJLHNCQUFzQixDQUFDLElBQUksRUFBRSxTQUFTLENBQUMsQ0FBQTtJQUNwRCxDQUFDO0lBRUQsZ0JBQWdCO1FBQ2QsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUM5QixNQUFNLFFBQVEsR0FBRyx1QkFBdUIsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO1lBQ3pELE9BQU8sUUFBUSxDQUFDLEtBQUssQ0FBQyxHQUFH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ZW50IjpbImltcG9ydCB7IERpcmVjdG9yeU1hbmFnZXIsIERtRmlsZVJlYWRlciB9IGZyb20gXCIuL0RpcmVjdG9yeU1hbmFnZXJzXCJcbmltcG9ydCB7IEJyb3dzZXJEbUZpbGVSZWFkZXIgfSBmcm9tIFwiLi9Ccm93c2VyRGlyZWN0b3J5TWFuYWdlcnNcIlxuaW1wb3J0IHsgcGF0aCB9IGZyb20gXCIuL3BhdGhcIlxuXG5leHBvcnQgY2xhc3MgU2FmYXJpRGlyZWN0b3J5TWFuYWdlciBpbXBsZW1lbnRzIERpcmVjdG9yeU1hbmFnZXIge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgcGF0aDogc3RyaW5nID0gJycsXG4gICAgcHVibGljIGZpbGVzOiBGaWxlW10sXG4gICkge31cblxuICBhc3luYyBnZXREaXJlY3RvcnkocGF0aDogc3RyaW5nKSB7XG4gICAgLy8gc2FmYXJpIGdpdmVzIHlvdSBhbGwgaXRlbXMgdXAgZnJvbnRcbiAgICBjb25zdCBuZXh0SXRlbXMgPSB0aGlzLmZpbGVzLmZpbHRlcihmaWxlID0+IHtcbiAgICAgIGNvbnN0IHJlbGF0aXZlID0gZ2V0V2Via2l0UGF0aFJlbGF0aXZlVG8oZmlsZSwgdGhpcy5wYXRoKVxuICAgICAgcmV0dXJuIHJlbGF0aXZlLnN1YnN0cmluZygwLCBwYXRoLmxlbmd0aCkudG9Mb3dlckNhc2UoKSA9PT0gcGF0aC50b0xvd2VyQ2FzZSgpXG4gICAgfSlcbiAgICByZXR1cm4gbmV3IFNhZmFyaURpcmVjdG9yeU1hbmFnZXIocGF0aCwgbmV4dEl0ZW1zKVxuICB9XG5cbiAgZ2V0UmVsYXRpdmVJdGVtcygpIHtcbiAgICByZXR1cm4gdGhpcy5maWxlcy5maWx0ZXIoZmlsZSA9PiB7XG4gICAgICBjb25zdCByZWxhdGl2ZSA9IGdldFdlYmtpdFBhdGhSZWxhdGl2ZVRvKGZpbGUsIHRoaXMucGF0aClcbiAgICAgIHJldHVybiByZWxhdGl2ZS5zcGxpdCgnLycpLmxlbmd0aCA9PT0gMSAvLyBsaXZlcyB3aXRoaW4gc2FtZSBkaXJlY3RvcnlcbiAgICB9KVxuICB9XG5cbiAgYXN5bmMgbGlzdCgpOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0UmVsYXRpdmVJdGVtcygpLm1hcChmaWxlID0+IGZpbGUubmFtZSlcbiAgfVxuXG4gIGFzeW5jIGxpc3RGb2xkZXJzKCk6IFByb21pc2U8c3RyaW5nW10+IHtcbiAgICByZXR1cm4gdGhpcy5nZXRSZWxhdGl2ZUl0ZW1zKClcbiAgICAgIC5maWx0ZXIoZmlsZSA9PiBmaWxlLm5hbWUuc3BsaXQoJy4nKS5sZW5ndGggPT09IDEpXG4gICAgICAubWFwKGZpbGUgPT4gZmlsZS5uYW1lKVxuICB9XG5cbiAgYXN5bmMgbGlzdEZpbGVzKCk6IFByb21pc2U8RG1GaWxlUmVhZGVyW10+IHtcbiAgICByZXR1cm4gdGhpcy5nZXRSZWxhdGl2ZUl0ZW1zKCkubWFwKGZpbGUgPT4gbmV3IEJyb3dzZXJEbUZpbGVSZWFkZXIoZmlsZSwgdGhpcykpXG4gIH1cblxuICBhc3luYyBmaW5kRmlsZUJ5UGF0aCAoZmlsZVBhdGg6IHN0cmluZyApOiBQcm9taXNlPEJyb3dzZXJEbUZpbGVSZWFkZXIgfCB1bmRlZmluZWQ+IHtcbiAgICBpZiAoICF0aGlzLmZpbGVzLmxlbmd0aCApIHtcbiAgICAgIHJldHVyblxuICAgIH1cblxuICAgIC8vIHNhZmFyaSBpbmNsdWRlIHRoZSBwYXJlbnQgZm9sZGVyIG5hbWUgc28gd2UgbmVlZCB0byBwcmVwZW5kIGl0IHRvIHRoZSBmaWxlIHNlYXJjaFxuICAgIGNvbnN0IHJvb3ROYW1lID0gdGhpcy5maWxlc1swXS53ZWJraXRSZWxhdGl2ZVBhdGguc3BsaXQoJy8nKS5zaGlmdCgpIGFzIHN0cmluZ1xuICAgIGZpbGVQYXRoID0gcGF0aC5qb2luKHJvb3ROYW1lLCB0aGlzLnBhdGgsIGZpbGVQYXRoKVxuICAgIFxuICAgIC8vIHNhZmFyaSBqdXN0IGdpdmVzIHVzIGV2ZXJ5IGZpbGVzIHVwZnJvbnQsIGZpbmQgd2l0aGluIHRoYXQgKGh1Z2UpIGFycmF5XG4gICAgY29uc3QgZmlsZSA9IHRoaXMuZmlsZXMuZmluZChmaWxlID0+IGZpbGUud2Via2l0UmVsYXRpdmVQYXRoID09PSBmaWxlUGF0aCkgYXMgRmlsZSB8IHVuZGVmaW5lZFxuICAgIHJldHVybiBmaWxlID8gbmV3IEJyb3dzZXJEbUZpbGVSZWFkZXIoZmlsZSwgdGhpcykgOiB1bmRlZmluZWRcbiAgfVxuXG4gIGFzeW5jIGZpbGUoZmlsZU5hbWU6IHN0cmluZywgX29wdGlvbnM/OiBGaWxlU3lzdGVtR2V0RmlsZU9wdGlvbnMpIHtcbiAgICBjb25zdCBmaW5kRmlsZSA9IGF3YWl0IHRoaXMuZmluZEZpbGVCeVBhdGgoZmlsZU5hbWUpXG5cbiAgICBpZiAoIGZpbmRGaWxlICkge1xuICAgICAgcmV0dXJuIGZpbmRGaWxlXG4gICAgfVxuXG4gICAgY29uc3Qgc3VwZXJGaWxlID0gbmV3IEJyb3dzZXJEbUZpbGVSZWFkZXIobmV3IEZpbGUoW10sIGZpbGVOYW1lKSwgdGhpcylcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHN1cGVyRmlsZSlcbiAgfVxufVxuXG5mdW5jdGlvbiBnZXRXZWJraXRQYXRoUmVsYXRpdmVUbyhmaWxlOiBGaWxlLCBwYXRoOiBzdHJpbmcpIHtcbiAgY29uc3QgcmVsYXRpdmVTcGxpdCA9IGZpbGUud2Via2l0UmVsYXRpdmVQYXRoLnNwbGl0KCcvJylcbiAgcmVsYXRpdmVTcGxpdC5zaGlmdCgpIC8vIHJlbW92ZSB0aGUgZmlyc3Qgbm90YXRpb24gb24gc2FmYXJpIHJlc3VsdHNcbiAgaWYgKCBwYXRoICE9PSAnJyApIHtcbiAgICBsZXQgc3BsaXRDb3VudCA9IHBhdGguc3BsaXQoJy8nKS5sZW5ndGhcbiAgICB3aGlsZSAoc3BsaXRDb3VudCkge1xuICAgICAgcmVsYXRpdmVTcGxpdC5zaGlmdCgpIC8vIHJlbW92ZSBzdGFydGluZyBub3RhdGlvbnMgb24gc2FmYXJpIHJlc3VsdHNcbiAgICAgIC0tc3BsaXRDb3VudFxuICAgIH1cbiAgfVxuICByZXR1cm4gcmVsYXRpdmVTcGxpdC5qb2luKCcvJylcbn0iXX0=